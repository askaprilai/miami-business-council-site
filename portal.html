<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Portal | Miami Business Council</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/png" href="Images/MBC BLACK LOGO NONTRANSPARENT (1).png">

    <!-- Brand Typography - MBC Brand Guidelines -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Montserrat:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- FORCE CACHE CLEAR - Version 2.0 with Real Database Stats -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- SEO and Social Sharing -->
    <meta name="description" content="Miami Business Council Member Portal - Connect with business leaders through AI-powered matching, direct chat, and exclusive networking events">
    <meta name="keywords" content="Miami Business Council, networking, business leaders, AI matching, member portal">
    
    <!-- Open Graph / Social Media Preview -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Miami Business Council Member Portal">
    <meta property="og:description" content="Connect with Miami's business leaders through AI-powered smart matching, direct messaging, and exclusive networking opportunities">
    <meta property="og:image" content="https://miamibusinesscouncil.com/Images/portal-preview.png">
    <meta property="og:url" content="https://miamibusinesscouncil.com/member-portal.html">
    <meta property="og:site_name" content="Miami Business Council">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Miami Business Council Member Portal">
    <meta name="twitter:description" content="Connect with Miami's business leaders through AI-powered smart matching and direct messaging">
    <meta name="twitter:image" content="https://miamibusinesscouncil.com/Images/portal-preview.png">
    
    <!-- LinkedIn -->
    <meta property="article:author" content="Miami Business Council">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#C9A86A">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MBC Portal">
    <meta name="application-name" content="Miami Business Council">
    <meta name="msapplication-TileColor" content="#C9A86A">
    <meta name="msapplication-starturl" content="/member-portal.html">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="Images/MBC BLACK LOGO NONTRANSPARENT (1).png">
    <link rel="apple-touch-icon" sizes="152x152" href="Images/MBC BLACK LOGO NONTRANSPARENT (1).png">
    <link rel="apple-touch-icon" sizes="180x180" href="Images/MBC BLACK LOGO NONTRANSPARENT (1).png">
    <link rel="apple-touch-icon" sizes="167x167" href="Images/MBC BLACK LOGO NONTRANSPARENT (1).png">

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Brand fonts loaded in <head> via Google Fonts: Outfit, Montserrat, Inter */
        
        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            color: #f1f3f4;
            background: #121212;
            min-height: 100vh;
            font-weight: 400;
            letter-spacing: -0.011em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Typography - MBC Brand Guidelines */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Outfit', 'Garet', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: -0.02em;
            color: #e8eaed;
        }

        h1 { font-size: 2.5rem; font-weight: 800; }
        h2 { font-size: 2rem; font-weight: 700; }
        h3 { font-size: 1.5rem; font-weight: 600; }
        h4 { font-size: 1.25rem; font-weight: 600; }
        h5 { font-size: 1.1rem; font-weight: 600; }
        h6 { font-size: 1rem; font-weight: 600; }

        .subheading, .subtitle {
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        /* Header */
        .portal-header {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .portal-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .portal-logo img {
            height: 70px;
            width: auto;
        }

        .portal-logo span {
            font-size: 1.3em;
            font-weight: 600;
            color: #C9A86A;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #000;
        }

        /* Button Design System - Standardized Styles */
        
        /* Base Button Styles */
        .btn-base {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 44px;
        }

        .btn-primary {
            background: #C9A86A;
            color: #000;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #B09858;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e8eaed;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            font-weight: 600;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #45a049 0%, #4CAF50 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-linkedin {
            background: linear-gradient(135deg, #0077B5 0%, #005885 100%);
            color: white;
            font-weight: 600;
        }

        .btn-linkedin:hover {
            background: linear-gradient(135deg, #005885 0%, #0077B5 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 119, 181, 0.3);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            min-height: 36px;
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1rem;
            min-height: 52px;
        }

        .btn-icon-only {
            padding: 0.75rem;
            min-width: 44px;
        }

        /* Apply standardized button styles */
        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #e8eaed;
            padding: 0.75rem 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Main Layout */
        .portal-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 2rem 2rem 320px;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem 1.5rem 8rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: calc(100vh - 140px);
            min-height: 600px;
            position: fixed;
            top: 120px;
            left: 2rem;
            width: 280px;
            overflow-y: auto;
            z-index: 1000;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: block;
            padding: 0.75rem 1rem;
            color: #e8eaed;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(212, 175, 55, 0.2);
            color: #C9A86A;
        }


        /* Loading States & Skeleton Screens */
        .skeleton {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.05) 0%, 
                rgba(255, 255, 255, 0.1) 50%, 
                rgba(255, 255, 255, 0.05) 100%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .skeleton-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 1rem;
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
        }

        .skeleton-text-title {
            height: 1.25rem;
            width: 70%;
        }

        .skeleton-text-body {
            width: 100%;
        }

        .skeleton-text-body:last-child {
            width: 85%;
        }

        .skeleton-button {
            height: 2.5rem;
            width: 120px;
            border-radius: 8px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(18, 18, 18, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            z-index: 999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-top: 3px solid #C9A86A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-message {
            margin-left: 1rem;
            color: #C9A86A;
            font-weight: 500;
        }

        /* Form Validation Styles */
        .form-field-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .form-field-error {
            border-color: #ff6b6b !important;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.3) !important;
        }

        .form-field-success {
            border-color: #51cf66 !important;
            box-shadow: 0 0 10px rgba(81, 207, 102, 0.3) !important;
        }

        .field-error-message {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
            padding: 0.5rem 0.75rem;
            border-radius: 0 0 8px 8px;
            font-size: 0.8rem;
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-top: none;
            display: none;
            z-index: 10;
        }

        .field-error-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .field-success-message {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #51cf66;
            font-size: 1.2rem;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-validation-summary {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .form-validation-summary.show {
            display: block;
        }

        .form-validation-summary h4 {
            color: #ff6b6b;
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .form-validation-summary ul {
            margin: 0;
            padding-left: 1.25rem;
        }

        .form-validation-summary li {
            color: #ff6b6b;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        /* Enhanced Error States */
        .error-toast {
            position: fixed;
            top: 100px;
            right: 2rem;
            background: rgba(255, 107, 107, 0.95);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .error-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .success-toast {
            position: fixed;
            top: 100px;
            right: 2rem;
            background: rgba(81, 207, 102, 0.95);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .success-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Admin Member List Styles */
        .member-list-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            table-layout: auto;
        }

        /* Wrap table in scrollable container */
        .member-list-table-wrapper {
            overflow-x: auto;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            -webkit-overflow-scrolling: touch;
        }

        .member-list-table-wrapper::-webkit-scrollbar {
            height: 12px;
        }

        .member-list-table-wrapper::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }

        .member-list-table-wrapper::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.5);
            border-radius: 6px;
        }

        .member-list-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.7);
        }

        .member-list-table th,
        .member-list-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .member-list-table th:nth-child(1), /* Name */
        .member-list-table td:nth-child(1) {
            width: 18%;
            min-width: 180px;
        }

        .member-list-table th:nth-child(2), /* Email */
        .member-list-table td:nth-child(2) {
            width: 28%;
            min-width: 220px;
        }

        .member-list-table th:nth-child(3), /* Company */
        .member-list-table td:nth-child(3) {
            width: 22%;
            min-width: 200px;
        }

        .member-list-table th:nth-child(4), /* Status */
        .member-list-table td:nth-child(4) {
            width: 12%;
            min-width: 100px;
        }

        .member-list-table th:nth-child(5), /* Joined */
        .member-list-table td:nth-child(5) {
            width: 10%;
            min-width: 90px;
        }

        .member-list-table th:nth-child(6), /* Actions */
        .member-list-table td:nth-child(6) {
            width: 10%;
            min-width: 200px;
        }

        .member-list-table th {
            background: rgba(255, 255, 255, 0.05);
            color: #C9A86A;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .member-list-table td {
            color: #f1f3f4;
            font-size: 0.95rem;
        }

        /* Allow text wrapping for longer content */
        .member-list-table td:nth-child(1), /* Name */
        .member-list-table td:nth-child(2), /* Email */
        .member-list-table td:nth-child(3) { /* Company */
            white-space: normal;
            word-break: break-word;
        }

        /* Keep status, joined, and actions on one line */
        .member-list-table td:nth-child(4),
        .member-list-table td:nth-child(5),
        .member-list-table td:nth-child(6) {
            white-space: nowrap;
        }

        .member-list-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .member-status {
            padding: 0.4rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
            white-space: nowrap;
        }

        .member-status.active {
            background: rgba(81, 207, 102, 0.2);
            color: #51cf66;
        }

        .member-status.pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .member-actions-cell {
            white-space: nowrap;
        }

        .member-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #e8eaed;
            padding: 0.4rem 0.65rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.35rem;
            transition: all 0.3s ease;
        }

        .member-action-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #C9A86A;
        }

        .member-list-summary {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .summary-number {
            font-size: 1.5rem;
            font-weight: 600;
            color: #C9A86A;
        }

        .summary-label {
            font-size: 0.8rem;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Content */
        .main-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-family: 'Poppins', 'Inter', sans-serif;
            font-size: 2rem;
            font-weight: 600;
            color: #C9A86A;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        /* Sidebar Support Button */
        .sidebar-support {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            text-align: center;
            margin-top: auto;
        }

        .support-btn {
            background: #C9A86A;
            color: #000;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .support-btn:hover {
            background: #B09858;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .support-text {
            color: #999;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #e8eaed;
        }

        .card-icon {
            font-size: 1.5em;
            color: #C9A86A;
        }

        /* Member Directory */
        .member-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .member-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.2);
        }

        .member-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .member-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #000;
            font-size: 1.2em;
        }

        .member-info h3 {
            font-size: 1.1em;
            color: #f1f3f4; /* Improved contrast */
            margin-bottom: 0.25rem;
        }

        .member-info p {
            color: #d4d6da; /* Improved contrast from #ccc */
            font-size: 0.9em;
        }

        .member-details {
            margin: 1rem 0;
        }

        .member-tag {
            display: inline-block;
            background: rgba(212, 175, 55, 0.2);
            color: #C9A86A;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8em;
            margin: 0.25rem 0.25rem 0.25rem 0;
        }

        .linkedin-btn {
            background: linear-gradient(135deg, #0077B5 0%, #005885 100%);
            color: white;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            min-height: 44px;
            cursor: pointer;
        }

        .linkedin-btn:hover {
            background: linear-gradient(135deg, #005885 0%, #0077B5 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 119, 181, 0.3);
        }

        /* Events */
        .event-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .event-date {
            background: #C9A86A;
            color: #000;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }

        .event-info h3 {
            color: #e8eaed;
            margin-bottom: 0.5rem;
        }

        .event-details {
            color: #ccc;
            margin-bottom: 1rem;
        }

        .register-btn {
            background: #C9A86A;
            color: #000;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .register-btn:hover {
            background: #B09858;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        /* Search */
        .search-bar {
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e8eaed;
            font-size: 1em;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Profile Styles */
        .profile-field {
            margin-bottom: 1rem;
        }

        .profile-field label {
            display: block;
            margin-bottom: 0.5rem;
            color: #e8eaed;
        }

        .profile-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e8eaed;
            font-size: 1em;
        }

        .profile-input:focus {
            outline: none;
            border-color: #C9A86A;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }

        .opportunity-section {
            margin-bottom: 1.5rem;
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .opportunity-tag {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .opportunity-tag.active {
            background: rgba(212, 175, 55, 0.3);
            color: #C9A86A;
            border-color: #C9A86A;
        }

        .opportunity-tag:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #C9A86A;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            accent-color: #C9A86A;
        }

        .radio-option span {
            color: #e8eaed;
        }

        /* Notification Badge */
        .notification-badge {
            background: #C9A86A;
            color: #000;
            font-size: 0.7em;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Chat Styles */
        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 700px;
            border-radius: 16px;
            overflow: visible;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-sidebar {
            background: rgba(255, 255, 255, 0.02);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-search {
            width: 100%;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
        }

        .chat-search::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .conversation-list {
            padding: 0;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .conversation-item:hover,
        .conversation-item.active {
            background: rgba(212, 175, 55, 0.1);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 600;
            margin-right: 0.75rem;
            font-size: 0.9rem;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            color: #e8eaed;
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }

        .conversation-preview {
            color: #ccc;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-meta {
            text-align: right;
            font-size: 0.7rem;
            color: #999;
        }

        .conversation-unread {
            background: #C9A86A;
            color: #000;
            font-size: 0.6rem;
            padding: 0.2rem 0.4rem;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 0.2rem;
            display: inline-block;
        }

        .chat-main {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: visible;
        }

        .chat-window-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-window-info {
            display: flex;
            align-items: center;
        }

        .chat-window-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 600;
            margin-right: 0.75rem;
        }

        .chat-window-details h4 {
            color: #e8eaed;
            margin: 0;
            font-size: 1rem;
        }

        .chat-window-details p {
            color: #ccc;
            margin: 0;
            font-size: 0.8rem;
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chat-action-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #e8eaed;
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .chat-action-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #C9A86A;
        }

        .messages-container {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            min-height: 0;
            max-height: 500px;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 600;
            font-size: 0.8rem;
            margin: 0 0.5rem;
        }

        .message.own .message-avatar {
            background: #ccc;
        }

        .message-content {
            max-width: 70%;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: 12px;
            position: relative;
        }

        .message.own .message-content {
            background: rgba(212, 175, 55, 0.2);
        }

        .message-text {
            color: #e8eaed;
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }

        .message-time {
            color: #999;
            font-size: 0.7rem;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            flex-shrink: 0;
            min-height: 120px;
            display: block !important;
            visibility: visible !important;
        }

        .chat-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
            resize: none;
            font-family: inherit;
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .chat-input:focus {
            outline: none;
            border-color: #C9A86A;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }

        .chat-send-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .chat-send-btn {
            background: #C9A86A;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-send-btn:hover {
            background: #DDB885;
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #ccc;
            text-align: center;
        }

        .chat-placeholder h3 {
            color: #C9A86A;
            margin-bottom: 1rem;
        }

        /* Chat Container Styles */
        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1rem;
            height: 700px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: visible;
        }

        .chat-sidebar {
            background: rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .chat-sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(212, 175, 55, 0.1);
        }

        .chat-sidebar-header h3 {
            color: #C9A86A;
            margin: 0;
            font-size: 1rem;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        .conversation-item:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .conversation-item.unread {
            background: rgba(212, 175, 55, 0.05);
            border-left: 3px solid #C9A86A;
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .conversation-details {
            flex: 1;
            min-width: 0;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .conversation-name {
            font-weight: 500;
            color: #e8eaed;
            font-size: 0.9rem;
        }

        .conversation-time {
            font-size: 0.7rem;
            color: #999;
        }

        .conversation-preview {
            font-size: 0.8rem;
            color: #d4d6da; /* Improved contrast from #ccc */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .unread-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #C9A86A;
            color: #000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .chat-main {
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.1);
            overflow: visible;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: calc(100vh - 100px);
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-member-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .chat-member-name {
            font-weight: 500;
            color: #e8eaed;
        }

        .chat-member-company {
            font-size: 0.8rem;
            color: #ccc;
        }

        /* Photo Upload Styles */
        .photo-upload-section {
            text-align: center;
        }

        .photo-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .photo-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .photo-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .photo-placeholder p {
            font-size: 0.8rem;
            margin: 0;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .upload-btn, .remove-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .upload-btn {
            background: #C9A86A;
            color: #000;
        }

        .upload-btn:hover {
            background: #DDB885;
        }

        .remove-btn {
            background: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .remove-btn:hover {
            background: rgba(220, 53, 69, 0.3);
        }

        /* Privacy Settings Styles */
        .privacy-setting {
            margin-bottom: 1rem;
        }

        .toggle-container {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
        }

        .privacy-toggle {
            display: none;
        }

        .toggle-label {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
            width: 100%;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 13px;
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
            margin-top: 0.1rem;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .privacy-toggle:checked + .toggle-label .toggle-switch {
            background: #C9A86A;
            border-color: #C9A86A;
        }

        .privacy-toggle:checked + .toggle-label .toggle-switch::before {
            left: 26px;
            background: #000;
        }

        /* Weekly Alerts Toggle */
        #weeklyAlertsToggle:checked + span {
            background: #C9A86A;
        }

        #weeklyAlertsToggle:checked + span + span {
            transform: translateX(24px);
        }

        .toggle-text {
            color: #e8eaed;
            font-weight: 500;
            line-height: 1.4;
        }

        .setting-description {
            color: #ccc;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            line-height: 1.4;
            margin-left: 3.25rem;
        }

        /* Email Button Styles */
        .email-btn {
            background: linear-gradient(135deg, #0077B5 0%, #005885 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            min-height: 44px;
        }

        .email-btn:hover {
            background: linear-gradient(135deg, #005885 0%, #0077B5 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 119, 181, 0.3);
        }

        .email-btn:active {
            transform: translateY(0);
        }

        .email-btn.disabled {
            background: rgba(255, 255, 255, 0.1);
            color: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .email-btn.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Search Bar Styles */
        .search-bar {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 3rem 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #f1f3f4;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 400;
            letter-spacing: -0.011em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .search-input:focus {
            outline: none;
            border-color: #C9A86A;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.75); /* Improved contrast from 0.6 */
        }

        .search-clear-btn {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #ccc;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-clear-btn:hover {
            background: rgba(220, 53, 69, 0.3);
            color: #ff6b6b;
        }

        .member-card.hidden {
            display: none;
        }

        .no-results {
            text-align: center;
            padding: 3rem 2rem;
            color: #ccc;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-top: 1rem;
        }

        .no-results h3 {
            color: #C9A86A;
            margin-bottom: 1rem;
        }

        /* Member Actions */
        .member-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .member-actions .linkedin-btn,
        .member-actions .email-btn,
        .member-actions .message-btn {
            flex: 1;
            min-width: 80px;
            text-align: center;
            justify-content: center;
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
        }

        .message-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            min-height: 44px;
        }

        .message-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #4CAF50 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        /* Member Card Styles */
        .member-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.2);
            border-color: rgba(212, 175, 55, 0.3);
        }

        /* Messaging System Styles */
        .messaging-container {
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 250px);
            min-height: 600px;
        }

        /* Conversations Sidebar */
        .conversations-sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .conversations-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversations-header h3 {
            color: #e8eaed;
            margin: 0;
            font-size: 1.2rem;
        }

        .new-message-btn {
            background: #C9A86A;
            color: #000;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .new-message-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .conversations-search {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .conversations-search input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e8eaed;
            font-size: 0.9rem;
        }

        .conversations-search input:focus {
            outline: none;
            border-color: rgba(212, 175, 55, 0.5);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .conversation-item {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            gap: 1rem;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(212, 175, 55, 0.3);
        }

        .conversation-item.active {
            background: rgba(212, 175, 55, 0.2);
            border-color: rgba(212, 175, 55, 0.5);
        }

        .conversation-item.unread {
            background: rgba(212, 175, 55, 0.1);
        }

        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #000;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .conversation-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-info h4 {
            color: #e8eaed;
            margin: 0 0 0.25rem 0;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-preview {
            color: #999;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-item.unread .conversation-preview {
            color: #C9A86A;
            font-weight: 500;
        }

        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .conversation-time {
            color: #999;
            font-size: 0.75rem;
        }

        .unread-badge {
            background: #C9A86A;
            color: #000;
            border-radius: 12px;
            padding: 0.15rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Message Thread Container */
        .message-thread-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .message-thread-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-thread-view {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .message-thread-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }

        .thread-member-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .thread-member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #000;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .thread-member-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .thread-member-info h3 {
            color: #e8eaed;
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
        }

        .thread-member-info p {
            color: #999;
            margin: 0;
            font-size: 0.85rem;
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message-bubble {
            max-width: 70%;
            padding: 1rem;
            border-radius: 12px;
            position: relative;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bubble.sent {
            align-self: flex-end;
            background: #C9A86A;
            color: #000;
            border-bottom-right-radius: 4px;
        }

        .message-bubble.received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.08);
            color: #e8eaed;
            border-bottom-left-radius: 4px;
        }

        .message-text {
            margin: 0;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-bubble.sent .message-text {
            color: #000;
        }

        .message-bubble.received .message-text {
            color: #e8eaed;
        }

        .message-time {
            font-size: 0.7rem;
            margin-top: 0.5rem;
            opacity: 0.8;
        }

        .message-bubble.sent .message-time {
            color: rgba(0, 0, 0, 0.6);
        }

        .message-bubble.received .message-time {
            color: #999;
        }

        .message-date-divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
        }

        .message-date-divider span {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            color: #999;
            font-size: 0.8rem;
        }

        /* Send Message Form */
        .send-message-form {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .send-message-form textarea {
            flex: 1;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e8eaed;
            font-size: 0.95rem;
            resize: none;
            font-family: inherit;
        }

        .send-message-form textarea:focus {
            outline: none;
            border-color: rgba(212, 175, 55, 0.5);
        }

        .send-message-btn {
            background: #C9A86A;
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .send-message-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .send-message-btn:active {
            transform: translateY(0);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: #e8eaed;
            margin: 0;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: #e8eaed;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #e8eaed;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e8eaed;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: rgba(212, 175, 55, 0.5);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .member-search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .member-search-item {
            padding: 0.75rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .member-search-item:last-child {
            border-bottom: none;
        }

        .member-search-item:hover {
            background: rgba(212, 175, 55, 0.2);
        }

        .member-search-item.selected {
            background: rgba(212, 175, 55, 0.3);
        }

        .member-search-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #000;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .member-search-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .member-search-info h4 {
            color: #e8eaed;
            margin: 0 0 0.25rem 0;
            font-size: 0.9rem;
        }

        .member-search-info p {
            color: #999;
            margin: 0;
            font-size: 0.8rem;
        }

        .btn-primary {
            background: #C9A86A;
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e8eaed;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .loading-state {
            text-align: center;
            padding: 2rem;
            color: #999;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #C9A86A;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-conversations {
            text-align: center;
            padding: 2rem 1rem;
            color: #999;
        }

        .empty-conversations p {
            margin: 0.5rem 0;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .messaging-container {
                flex-direction: column;
                height: auto;
                min-height: 70vh;
            }

            .conversations-sidebar {
                width: 100%;
                max-height: 300px;
            }

            .message-thread-container {
                min-height: 500px;
            }

            .message-bubble {
                max-width: 85%;
            }
        }

        .member-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .member-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #000;
            font-size: 1.8rem;
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
            border: 3px solid rgba(212, 175, 55, 0.6);
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .member-card:hover .member-avatar {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.6);
        }

        .member-card {
            cursor: pointer;
        }

        /* Member Profile Modal */
        .member-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .member-profile-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .profile-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: #e8eaed;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .profile-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .profile-hero {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #C9A86A;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #000;
            font-size: 2.5rem;
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.4);
            border: 4px solid rgba(212, 175, 55, 0.6);
            margin: 0 auto 1rem auto;
        }

        .profile-name {
            color: #e8eaed;
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
        }

        .profile-title {
            color: #C9A86A;
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0 0 0.5rem 0;
        }

        .profile-company {
            color: #ccc;
            font-size: 1rem;
            margin: 0;
        }

        .profile-section {
            margin-bottom: 2rem;
        }

        .profile-section h3 {
            color: #C9A86A;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .profile-tag {
            background: rgba(212, 175, 55, 0.2);
            color: #C9A86A;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9em;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .profile-action-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        /* Email button - Professional Blue */
        .profile-action-btn.email-action {
            background: #1e88e5;
            color: #fff;
        }

        .profile-action-btn.email-action:hover {
            background: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4);
        }

        /* Chat button - Friendly Green */
        .profile-action-btn.chat-action {
            background: #43a047;
            color: #fff;
        }

        .profile-action-btn.chat-action:hover {
            background: #388e3c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 160, 71, 0.4);
        }

        /* LinkedIn button - LinkedIn Blue */
        .profile-action-btn.linkedin-action {
            background: #0077b5;
            color: #fff;
        }

        .profile-action-btn.linkedin-action:hover {
            background: #006399;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 119, 181, 0.4);
        }

        /* Connect button - Gold */
        .profile-action-btn.connect-action {
            background: rgba(212, 175, 55, 0.2);
            color: #C9A86A;
            border: 1px solid rgba(212, 175, 55, 0.5);
        }

        .profile-action-btn.connect-action:hover {
            background: rgba(212, 175, 55, 0.3);
            border-color: #C9A86A;
            transform: translateY(-2px);
        }

        .profile-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .profile-info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-info-label {
            color: #C9A86A;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .profile-info-value {
            color: #e8eaed;
            font-size: 1rem;
        }

        /* Connection Request Styles */
        .connection-request {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .connection-request:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(212, 175, 55, 0.3);
        }

        .connection-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .connection-actions .profile-action-btn {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
        }

        /* Admin Panel Styles */
        .member-management-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .member-management-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .member-management-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(212, 175, 55, 0.3);
        }

        .member-management-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .member-management-actions .profile-action-btn {
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
        }

        /* Profile Progress Indicator */
        .profile-progress-card {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .progress-header h3 {
            color: #C9A86A;
            margin: 0;
            font-size: 1.4rem;
        }

        .progress-percentage {
            font-size: 1.2rem;
            font-weight: 700;
            color: #C9A86A;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #C9A86A 0%, #DDB885 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-tips {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tip-item.completed {
            background: rgba(81, 207, 102, 0.1);
            border-left: 3px solid #51cf66;
        }

        .tip-icon {
            font-size: 1.1rem;
        }

        .tip-text {
            flex: 1;
            color: #e8eaed;
            font-size: 0.9rem;
        }

        .tip-status {
            font-size: 1rem;
            color: #51cf66;
        }

        .progress-action {
            text-align: center;
        }

        .complete-profile-btn {
            background: #C9A86A;
            color: #000;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .complete-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        @media (max-width: 768px) {
            .progress-tips {
                grid-template-columns: 1fr;
            }
            
            .profile-progress-card {
                padding: 1.5rem;
            }
        }

        .member-info {
            flex: 1;
        }

        .member-info h3 {
            margin: 0 0 0.25rem 0;
            color: #e8eaed;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .member-info p {
            margin: 0;
            color: #ccc;
            font-size: 0.9rem;
        }

        .member-details {
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .member-tag {
            background: rgba(212, 175, 55, 0.2);
            color: #C9A86A;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .member-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        /* List View Styles */
        .member-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .member-list .member-card {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 2rem;
            align-items: center;
            padding: 1.75rem 2rem;
            min-height: 100px;
        }

        .member-list .member-header {
            flex-direction: row;
            gap: 1.25rem;
            min-width: 300px;
        }

        .member-list .member-avatar {
            width: 60px;
            height: 60px;
            font-size: 1.4rem;
        }

        .member-list .member-info h3 {
            font-size: 1.1rem;
            margin-bottom: 0.35rem;
            font-weight: 600;
        }

        .member-list .member-info p {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .member-list .member-details {
            flex: 1;
            justify-content: flex-start;
        }

        .member-list .member-actions {
            flex-direction: row;
            gap: 0.75rem;
        }

        .member-list .member-actions button {
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            min-height: 44px;
        }

        /* Referral System Styles */
        .referral-points-badge {
            background: #C9A86A;
            color: #000;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .referral-link-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .referral-link-input {
            flex: 1;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .copy-link-btn {
            background: #C9A86A;
            color: #000;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .copy-link-btn:hover {
            background: #DDB885;
        }

        .share-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .share-btn.email {
            background: #0077b5;
            color: white;
        }

        .share-btn.linkedin {
            background: #0a66c2;
            color: white;
        }

        .share-btn.sms {
            background: #25d366;
            color: white;
        }

        .share-btn.generic {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .share-btn:hover {
            transform: translateY(-1px);
            filter: brightness(1.1);
        }

        .referral-stats {
            display: grid;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            color: #C9A86A;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: #ccc;
            font-size: 0.8rem;
        }

        .rewards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .reward-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reward-card.unlocked {
            border-color: #C9A86A;
            box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.3);
        }

        .reward-card.locked {
            opacity: 0.6;
        }

        .reward-card:hover.unlocked {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.2);
        }

        .reward-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .reward-title {
            font-weight: 600;
            color: #e8eaed;
            margin-bottom: 0.5rem;
        }

        .reward-description {
            color: #ccc;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .reward-cost {
            color: #C9A86A;
            font-weight: 500;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .claim-reward-btn {
            background: #C9A86A;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .claim-reward-btn:hover:not(.disabled) {
            background: #DDB885;
        }

        .claim-reward-btn.disabled {
            background: rgba(255, 255, 255, 0.1);
            color: #666;
            cursor: not-allowed;
        }

        /* PWA Install Prompt */
        .pwa-install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #C9A86A;
            color: #000;
            padding: 1rem;
            display: none;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }

        .pwa-close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #000;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .pwa-close-btn:hover {
            opacity: 1;
        }

        .pwa-install-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            gap: 1rem;
        }

        .pwa-install-text {
            flex: 1;
        }

        .pwa-install-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .pwa-install-description {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .pwa-install-actions {
            display: flex;
            gap: 0.5rem;
        }

        .pwa-install-btn, .pwa-dismiss-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pwa-install-btn {
            background: #000;
            color: #C9A86A;
        }

        .pwa-dismiss-btn {
            background: rgba(0, 0, 0, 0.1);
            color: #000;
        }

        .pwa-install-btn:hover {
            background: #333;
        }

        .pwa-dismiss-btn:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .portal-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: auto;
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(20px);
                z-index: 99;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
                border-radius: 0 0 20px 20px;
            }

            .sidebar.mobile-open {
                transform: translateY(0);
            }

            .nav-menu {
                display: flex;
                overflow-x: auto;
                padding: 1rem;
                gap: 0.5rem;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .nav-menu::-webkit-scrollbar {
                display: none;
            }

            .nav-item {
                margin-bottom: 0;
                flex-shrink: 0;
            }

            .nav-link {
                padding: 0.5rem 1rem;
                white-space: nowrap;
                font-size: 0.9rem;
            }

            .main-content {
                padding: 1rem;
                margin-top: 60px;
            }

            .header-content {
                padding: 0 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .member-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .chat-container {
                grid-template-columns: 1fr;
                height: calc(100vh - 200px);
                position: relative;
            }

            .chat-sidebar {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .chat-sidebar.mobile-open {
                transform: translateX(0);
            }

            .chat-main {
                position: relative;
            }

            .rewards-grid {
                grid-template-columns: 1fr;
            }

            .referral-stats {
                grid-template-columns: repeat(3, 1fr);
            }

            .pwa-install-content {
                flex-direction: column;
                text-align: center;
            }

            .pwa-install-actions {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .dashboard-card {
                margin-bottom: 1rem;
            }

            .profile-field label {
                font-size: 0.9rem;
            }

            .profile-input, .form-control {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .share-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .member-actions {
                flex-direction: column;
            }

            .member-actions .linkedin-btn,
            .member-actions .email-btn {
                flex: none;
                width: 100%;
            }
        }

        /* Touch-friendly improvements */
        @media (pointer: coarse) {
            .nav-link, .btn, .register-btn, .email-btn, .linkedin-btn {
                min-height: 44px;
                touch-action: manipulation;
            }

            .member-card {
                touch-action: manipulation;
            }

            .conversation-item {
                min-height: 60px;
                touch-action: manipulation;
            }
        }

        /* Dark mode safe area insets for mobile */
        @supports (padding: max(0px)) {
            .portal-header {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
                padding-top: max(1rem, env(safe-area-inset-top));
            }

            .pwa-install-banner {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
        }

        /* Match Cards */
        .match-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .match-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .match-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(212, 175, 55, 0.25);
            border-color: rgba(212, 175, 55, 0.4);
        }

        /* High priority pulse animation */
        .match-card.high-priority {
            border-color: rgba(81, 207, 102, 0.4);
            animation: pulse-border 2s ease-in-out infinite;
        }

        @keyframes pulse-border {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(81, 207, 102, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(81, 207, 102, 0);
            }
        }

        .match-card.high-priority::before {
            content: ' TOP MATCH';
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: #000;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            z-index: 1;
        }

        .match-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .match-header h4 {
            margin: 0;
            color: #e8eaed;
            font-size: 1.1em;
        }

        .match-header p {
            margin: 0;
            color: #ccc;
            font-size: 0.9em;
        }

        .match-score {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            margin-left: auto;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        /* Color-coded match scores */
        .match-score.excellent {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: #000;
        }

        .match-score.good {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: #000;
        }

        .match-score.fair {
            background: linear-gradient(135deg, #adb5bd 0%, #868e96 100%);
            color: #fff;
        }

        .match-card:hover .match-score {
            transform: scale(1.1);
        }

        .match-details {
            margin-bottom: 1rem;
            color: #ccc;
            line-height: 1.6;
        }

        .match-details p {
            margin-bottom: 0.5rem;
        }

        /* Match reasons with icons */
        .match-reasons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .match-reason-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #C9A86A;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .match-reason-badge:hover {
            background: rgba(212, 175, 55, 0.25);
            transform: translateY(-2px);
        }

        .match-reason-icon {
            font-size: 1rem;
        }

        /* Match type label enhancements */
        .match-type-label {
            font-size: 0.75rem;
            color: #C9A86A;
            margin-top: 0.25rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .match-actions {
            display: flex;
            gap: 1rem;
        }

        .connect-btn {
            background: #C9A86A;
            color: #000;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-btn:hover {
            background: #DDB885;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .portal-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }

            .sidebar {
                position: static;
                order: 2;
            }

            .main-content {
                order: 1;
            }

            .header-content {
                padding: 0 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .member-grid {
                grid-template-columns: 1fr;
            }

            .tag-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .match-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="portal-header">
        <div class="header-content">
            <div class="portal-logo">
                <img src="Images/MBC WHITE LOGO TRANSPARENT (1).png" alt="Miami Business Council">
                <span>Member Portal</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">--</div>
                <span id="userName">Loading...</span>
                <a href="#" class="logout-btn" onclick="logout()">Logout</a>
            </div>
        </div>
    </header>

    <!-- PWA Install Banner -->
    <div class="pwa-install-banner" id="pwaInstallBanner">
        <button class="pwa-close-btn" id="pwaCloseBtn">&times;</button>
        <div class="pwa-install-content">
            <div class="pwa-install-text">
                <div class="pwa-install-title"> Install MBC Portal</div>
                <div class="pwa-install-description">Add to your phone's home screen for quick access to members, chat, and networking</div>
            </div>
            <div class="pwa-install-actions">
                <button class="pwa-install-btn" id="pwaInstallBtn">Install</button>
                <button class="pwa-dismiss-btn" id="pwaDismissBtn">Maybe Later</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="portal-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="dashboard"> Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="smart-matches"> Smart Matches</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="directory"> Member Directory</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="connections"> Connections <span id="connectionNotificationBadge" class="notification-badge" style="display: none;">0</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="messages"> Messages <span id="messageNotificationBadge" class="notification-badge" style="display: none;">3</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="events"> Events</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="profile"> My Profile</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="admin"> Admin Panel</a>
                </li>
            </ul>
            
            <!-- Support Button at Bottom of Sidebar -->
            <div class="sidebar-support">
                <a href="mailto:info@miamibusinesscouncil.com" class="support-btn">
                     Support
                </a>
                <div class="support-text">Need help? Contact us</div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h1 class="section-title">Dashboard</h1>
                    <p id="personalizedWelcome">Welcome to your Miami Business Council member portal</p>
                </div>

                <!-- Personalized Welcome Card -->
                <div class="dashboard-card" id="personalizedWelcomeCard" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%); border: 1px solid rgba(212, 175, 55, 0.3); margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div class="member-avatar" id="dashboardUserAvatar" style="width: 60px; height: 60px; font-size: 1.5rem;">--</div>
                        <div>
                            <h3 style="color: #C9A86A; margin: 0;" id="dashboardUserName">Welcome back!</h3>
                            <p style="color: #ccc; margin: 0; font-size: 0.9rem;" id="dashboardUserRole">Loading...</p>
                        </div>
                        <div style="margin-left: auto; text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                            <div style="color: #C9A86A; font-weight: 600;" id="memberProfileStrength">75%</div>
                            <div style="color: #ccc; font-size: 0.8rem;">Profile Strength</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 1.5rem; color: #C9A86A; font-weight: 600;" id="memberConnectionCount">0</div>
                            <div style="color: #ccc; font-size: 0.8rem;">Connections</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; color: #C9A86A; font-weight: 600;" id="memberMessageCount">0</div>
                            <div style="color: #ccc; font-size: 0.8rem;">Messages</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; color: #C9A86A; font-weight: 600;" id="memberEventCount">0</div>
                            <div style="color: #ccc; font-size: 0.8rem;">Events Attended</div>
                        </div>
                    </div>
                </div>

                <!-- Member Onboarding Checklist -->
                <div class="dashboard-card" id="onboardingChecklist" style="background: linear-gradient(135deg, rgba(81, 207, 102, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%); border: 1px solid rgba(81, 207, 102, 0.3); margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h3 style="color: #51cf66; margin: 0;"> Get Started Checklist</h3>
                        <span id="onboardingProgressText" style="color: #51cf66; font-weight: 600; font-size: 1rem;">0% Complete</span>
                    </div>

                    <!-- Progress Bar -->
                    <div style="background: rgba(255, 255, 255, 0.1); border-radius: 10px; height: 12px; overflow: hidden; margin-bottom: 1.5rem;">
                        <div id="onboardingProgressBar" style="background: linear-gradient(90deg, #51cf66 0%, #37b24d 100%); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                    </div>

                    <!-- Checklist Items -->
                    <div style="display: grid; gap: 0.75rem;">
                        <div id="checklistItem1" class="checklist-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; transition: all 0.3s ease;">
                            <span class="checklist-icon" style="font-size: 1.5rem;"></span>
                            <span style="color: #e8eaed;">Complete your profile information</span>
                        </div>
                        <div id="checklistItem2" class="checklist-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; transition: all 0.3s ease;">
                            <span class="checklist-icon" style="font-size: 1.5rem;"></span>
                            <span style="color: #e8eaed;">Upload your profile photo</span>
                        </div>
                        <div id="checklistItem3" class="checklist-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; transition: all 0.3s ease;">
                            <span class="checklist-icon" style="font-size: 1.5rem;"></span>
                            <span style="color: #e8eaed;">Add your company logo</span>
                        </div>
                        <div id="checklistItem4" class="checklist-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; transition: all 0.3s ease;">
                            <span class="checklist-icon" style="font-size: 1.5rem;"></span>
                            <span style="color: #e8eaed;">Make your first connection</span>
                        </div>
                        <div id="checklistItem5" class="checklist-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; transition: all 0.3s ease;">
                            <span class="checklist-icon" style="font-size: 1.5rem;"></span>
                            <span style="color: #e8eaed;">Select your industries</span>
                        </div>
                    </div>

                    <!-- Complete Profile Button -->
                    <div id="completeProfilePrompt" style="margin-top: 1.5rem; text-align: center;">
                        <button onclick="showSection('profile'); setTimeout(() => document.getElementById('profilePhotoSection').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);" style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.2s ease;">
                            Complete Your Profile 
                        </button>
                    </div>

                    <!-- Completion Message (hidden by default) -->
                    <div id="onboardingCompleteMessage" style="display: none; text-align: center; padding: 1rem; background: rgba(81, 207, 102, 0.2); border-radius: 8px; margin-top: 1rem;">
                        <span style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></span>
                        <span style="color: #51cf66; font-weight: 600; font-size: 1.1rem;">Congratulations! Your profile is complete!</span>
                        <p style="color: #ccc; font-size: 0.9rem; margin-top: 0.5rem;">You're all set to make the most of your membership.</p>
                    </div>
                </div>

                <!-- Today's Insights -->
                <div class="dashboard-card" id="dailyInsights" style="margin-bottom: 2rem;">
                    <h3 style="color: #C9A86A; margin-bottom: 1rem;"> Today's Insights</h3>
                    <div id="insightsList" style="display: grid; gap: 0.75rem;">
                        <!-- Insights loaded dynamically from database -->
                        <div style="text-align: center; padding: 2rem; color: #999;">
                            <div class="spinner-small"></div>
                            <p>Loading insights...</p>
                        </div>
                    </div>
                </div>

                <!-- Community Activity Feed -->
                <div class="dashboard-card" id="communityActivityFeed" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%); border: 1px solid rgba(212, 175, 55, 0.3); margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                        <h3 style="color: #C9A86A; margin: 0;"> Community Activity</h3>
                        <button onclick="loadCommunityActivity()" style="background: transparent; border: 1px solid rgba(212, 175, 55, 0.3); color: #C9A86A; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                             Refresh
                        </button>
                    </div>

                    <div id="activityFeedList" style="display: grid; gap: 1rem;">
                        <!-- Activity items will be dynamically loaded here -->
                        <div style="text-align: center; padding: 2rem; color: #999;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                            <p>Loading community activity...</p>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button onclick="showSection('directory')" style="background: transparent; border: 1px solid rgba(212, 175, 55, 0.3); color: #C9A86A; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                            View All Members 
                        </button>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Upcoming Events</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><strong>Next Breakfast:</strong> January 28th, 9:00 AM</p>
                        <p>Miami Design District</p>
                        <button class="register-btn" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 0.9em;">Register Now</button>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Network Stats</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><strong>Total Members:</strong> <span id="totalMemberCount">0</span></p>
                        <p><strong>New Connections:</strong> <span id="newConnectionsCount">0</span> this month</p>
                        <p><strong>Events Attended:</strong> <span id="eventsAttendedCount">0</span></p>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><a href="#" onclick="showSection('profile')" style="color: #C9A86A; cursor: pointer;">Update Profile</a></p>
                        <p><a href="#" onclick="showSection('directory')" style="color: #C9A86A; cursor: pointer;">Browse Directory</a></p>
                        <p><a href="#" onclick="showSection('events')" style="color: #C9A86A; cursor: pointer;">View Events</a></p>
                    </div>
                </div>
            </section>

            <!-- Smart Matches Section -->
            <section id="smart-matches" class="content-section">
                <div class="section-header">
                    <h1 class="section-title"> Smart Matches</h1>
                    <p>AI-powered connections based on your ideal client profile and business goals</p>
                </div>

                <!-- Matching Stats -->
                <div class="dashboard-grid" style="margin-bottom: 2rem;">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Match Statistics</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><strong>Total Matches Found:</strong> <span id="totalMatches">0</span></p>
                        <p><strong>High-Priority Matches:</strong> <span id="highPriorityMatches">0</span></p>
                        <p><strong>New This Week:</strong> <span id="newMatches">0</span></p>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Match Quality</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><strong>Average Match Score:</strong> <span id="avgMatchScore">-</span></p>
                        <p><strong>Mutual Interest Matches:</strong> <span id="mutualMatches">0</span></p>
                        <p><strong>Your Profile Completion:</strong> <span id="profileCompletion">0</span>%</p>
                        <button class="register-btn" onclick="showSection('profile')" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 0.9em;">Complete Profile</button>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><a href="#" onclick="generateSmartMatches()" style="color: #C9A86A; cursor: pointer;"> Refresh Matches</a></p>

                        <!-- Weekly Alerts Toggle -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; margin-top: 1rem;">
                            <div style="flex: 1;">
                                <div style="color: #e8eaed; font-weight: 600; margin-bottom: 0.25rem;"> Weekly Match Alerts</div>
                                <div style="color: #999; font-size: 0.85rem;">Get 3-5 curated matches every Sunday 7pm</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 50px; height: 26px; margin-left: 1rem;">
                                <input type="checkbox" id="weeklyAlertsToggle" onchange="toggleWeeklyAlerts(this.checked)" style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: 0.3s; border-radius: 26px;"></span>
                                <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%;"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Match Filters -->
                <div class="dashboard-card" style="margin-bottom: 2rem;">
                    <h3 style="color: #C9A86A; margin-bottom: 1rem;"> Filter Your Matches</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div class="profile-field">
                            <label>Match Type:</label>
                            <select class="profile-input" id="matchTypeFilter" onchange="filterMatches()">
                                <option value="all">All Matches</option>
                                <option value="ideal-client">My Ideal Clients</option>
                                <option value="service-provider">Service Providers for Me</option>
                                <option value="mutual">Mutual Benefit</option>
                                <option value="partnership">Partnership Opportunities</option>
                            </select>
                        </div>
                        <div class="profile-field">
                            <label>Industry:</label>
                            <select class="profile-input" id="industryFilter" onchange="filterMatches()">
                                <option value="all">All Industries</option>
                                <option value="Technology">Technology</option>
                                <option value="Real Estate">Real Estate</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Finance">Finance</option>
                                <option value="Legal">Legal</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Retail">Retail</option>
                                <option value="Hospitality">Hospitality</option>
                                <option value="Non-Profit">Non-Profit</option>
                                <option value="Fashion">Fashion</option>
                                <option value="Manufacturing">Manufacturing</option>
                                <option value="Architecture">Architecture</option>
                                <option value="Design">Design</option>
                                <option value="Creative">Creative</option>
                                <option value="Consulting">Consulting</option>
                            </select>
                        </div>
                        <div class="profile-field">
                            <label>Match Score:</label>
                            <select class="profile-input" id="scoreFilter" onchange="filterMatches()">
                                <option value="all">Any Score</option>
                                <option value="high">90%+ (High Match)</option>
                                <option value="good">75-89% (Good Match)</option>
                                <option value="fair">60-74% (Fair Match)</option>
                            </select>
                        </div>
                        <div class="profile-field">
                            <label>Availability:</label>
                            <select class="profile-input" id="availabilityFilter" onchange="filterMatches()">
                                <option value="all">All Members</option>
                                <option value="active">Recently Active</option>
                                <option value="looking">Actively Looking</option>
                                <option value="open">Open to Connections</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Smart Matches Results -->
                <div class="match-grid" id="smartMatchResults">
                    <!-- Matches will be populated by JavaScript -->
                </div>
            </section>

            <!-- Member Directory Section -->
            <section id="directory" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Member Directory</h1>
                    <p>Connect with fellow Miami business leaders</p>
                </div>

                <!-- Directory Controls -->
                <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                    <!-- Search Bar -->
                    <div class="search-bar" style="margin-bottom: 1.5rem;">
                        <input type="text" class="search-input" id="memberSearchInput" placeholder="Search members by name, company, or industry..." oninput="searchMembers()">
                        <button class="search-clear-btn" id="clearSearchBtn" onclick="clearMemberSearch()" style="display: none;"></button>
                    </div>

                    <!-- Filters and Controls Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: center;">
                        <!-- Industry Filter -->
                        <div>
                            <label style="display: block; color: #ccc; font-size: 0.85rem; margin-bottom: 0.5rem;">Industry</label>
                            <select id="industryFilterSelect" onchange="applyFilters()" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e8eaed;">
                                <option value="all">All Industries</option>
                                <option value="Technology">Technology</option>
                                <option value="Finance">Finance</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Real Estate">Real Estate</option>
                                <option value="Retail">Retail</option>
                                <option value="Hospitality">Hospitality</option>
                                <option value="Professional Services">Professional Services</option>
                                <option value="Manufacturing">Manufacturing</option>
                                <option value="Education">Education</option>
                                <option value="Non-Profit">Non-Profit</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Consulting">Consulting</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Sort By -->
                        <div>
                            <label style="display: block; color: #ccc; font-size: 0.85rem; margin-bottom: 0.5rem;">Sort By</label>
                            <select id="sortSelect" onchange="applyFilters()" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e8eaed;">
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="company-asc">Company (A-Z)</option>
                                <option value="date-desc">Newest First</option>
                                <option value="date-asc">Oldest First</option>
                            </select>
                        </div>

                        <!-- Results Count -->
                        <div style="color: #ccc; font-size: 0.9rem;">
                            <span id="memberResultsCount">0 members</span>
                        </div>

                        <!-- View Toggle -->
                        <div style="display: flex; gap: 0.5rem;">
                            <button id="gridViewBtn" onclick="setViewMode('grid')" style="padding: 0.75rem 1rem; background: rgba(212, 175, 55, 0.2); border: 1px solid #C9A86A; border-radius: 8px; color: #C9A86A; cursor: pointer; font-size: 1.2rem;" title="Grid View">
                                
                            </button>
                            <button id="listViewBtn" onclick="setViewMode('list')" style="padding: 0.75rem 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #ccc; cursor: pointer; font-size: 1.2rem;" title="List View">
                                
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Member Grid/List Container -->
                <div id="memberDirectoryContainer" class="member-grid">
                    <!-- Members loaded dynamically from database -->
                </div>

                <!-- Pagination Controls -->
                <div id="paginationControls" style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 2rem; padding: 1.5rem;">
                    <button id="prevPageBtn" onclick="changePage(-1)" style="padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e8eaed; cursor: pointer;">
                         Previous
                    </button>
                    <div id="pageNumbers" style="display: flex; gap: 0.5rem;">
                        <!-- Page numbers will be generated dynamically -->
                    </div>
                    <button id="nextPageBtn" onclick="changePage(1)" style="padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e8eaed; cursor: pointer;">
                        Next 
                    </button>
                </div>
            </section>

            <!-- Messages Section -->
            <section id="messages" class="content-section">
                <div class="section-header">
                    <h1 class="section-title"> Messages</h1>
                    <p>Member-to-Member Messaging</p>
                </div>

                <div class="messaging-container">
                    <!-- Conversations Sidebar -->
                    <div class="conversations-sidebar">
                        <div class="conversations-header">
                            <h3>Conversations</h3>
                            <button class="new-message-btn" onclick="showNewMessageModal()" title="Start new conversation">
                                
                            </button>
                        </div>

                        <div class="conversations-search">
                            <input type="text" id="conversationsSearch" placeholder=" Search conversations..." onkeyup="filterConversations()">
                        </div>

                        <div id="conversationsList" class="conversations-list">
                            <!-- Conversations will be loaded here -->
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Loading conversations...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Message Thread Panel -->
                    <div class="message-thread-container">
                        <div id="messageThreadEmpty" class="message-thread-empty">
                            <div style="text-align: center; padding: 4rem 2rem;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                                <h3 style="color: #C9A86A; margin-bottom: 0.5rem;">Select a conversation</h3>
                                <p style="color: #999;">Choose a conversation from the list or start a new one</p>
                                <button onclick="showNewMessageModal()" style="margin-top: 2rem; background: linear-gradient(135deg, #C9A86A 0%, #f4f1e8 100%); color: #000; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                                     New Message
                                </button>
                            </div>
                        </div>

                        <div id="messageThreadView" class="message-thread-view" style="display: none;">
                            <!-- Message Thread Header -->
                            <div class="message-thread-header">
                                <div class="thread-member-info">
                                    <div id="threadMemberAvatar" class="thread-member-avatar"></div>
                                    <div>
                                        <h3 id="threadMemberName"></h3>
                                        <p id="threadMemberTitle"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Messages Area -->
                            <div id="messagesArea" class="messages-area">
                                <!-- Messages will be loaded here -->
                            </div>

                            <!-- Send Message Form -->
                            <div class="send-message-form">
                                <textarea
                                    id="messageInput"
                                    placeholder="Type your message... (Press Enter to send, Shift+Enter for new line)"
                                    rows="3"
                                    onkeydown="handleMessageInputKeydown(event)"
                                ></textarea>
                                <button onclick="sendMessage()" class="send-message-btn" title="Send message">
                                    Send 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- New Message Modal -->
            <div id="newMessageModal" class="modal-overlay" style="display: none;" onclick="closeNewMessageModal()">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3>New Message</h3>
                        <button onclick="closeNewMessageModal()" class="modal-close-btn"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>To:</label>
                            <input type="text" id="newMessageSearch" placeholder="Search members..." onkeyup="searchMembersForMessage()">
                            <div id="memberSearchResults" class="member-search-results"></div>
                        </div>
                        <div class="form-group">
                            <label>Message:</label>
                            <textarea id="newMessageText" placeholder="Type your message..." rows="5"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeNewMessageModal()" class="btn-secondary">Cancel</button>
                        <button onclick="sendNewMessage()" class="btn-primary">Send Message</button>
                    </div>
                </div>
            </div>

            <!-- Connections Section -->
            <section id="connections" class="content-section">
                <div class="section-header">
                    <h1 class="section-title"> Connections</h1>
                    <p>Manage your connection requests and network</p>
                </div>

                <!-- Connection Stats -->
                <div class="dashboard-grid" style="margin-bottom: 2rem;">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Pending Requests</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><strong>Incoming:</strong> <span id="incomingRequests">0</span> requests</p>
                        <p><strong>Outgoing:</strong> <span id="outgoingRequests">0</span> sent</p>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Active Connections</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><strong>Total Connections:</strong> <span id="totalConnections">0</span></p>
                        <p><strong>This Month:</strong> <span id="monthlyConnections">0</span> new</p>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><a href="#" onclick="showSection('directory')" style="color: #C9A86A; cursor: pointer;"> Find New Connections</a></p>
                        <p><a href="#" onclick="showSection('smart-matches')" style="color: #C9A86A; cursor: pointer;"> Smart Matching</a></p>
                        <p><a href="#" onclick="showSection('messages')" style="color: #C9A86A; cursor: pointer;"> Message Connections</a></p>
                    </div>
                </div>

                <!-- Connection Requests -->
                <div class="dashboard-card" style="margin-bottom: 2rem;">
                    <h3 style="color: #C9A86A; margin-bottom: 1.5rem;"> Pending Connection Requests</h3>

                    <div id="connectionRequests">
                        <div style="text-align: center; padding: 1.5rem; color: #999;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                            <h4 style="color: #e8eaed; margin-bottom: 0.25rem; font-size: 1rem;">No pending requests</h4>
                            <p style="font-size: 0.9rem; margin-bottom: 0.75rem;">You don't have any connection requests at the moment.</p>
                            <button class="register-btn" onclick="showSection('directory')" style="margin-top: 0.5rem; padding: 0.6rem 1.2rem; font-size: 0.9rem;">Browse Members</button>
                        </div>
                    </div>
                </div>

                <!-- Active Connections -->
                <div class="dashboard-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: #C9A86A; margin: 0;"> Active Connections</h3>
                        <span id="connectionsCount" style="color: #999; font-size: 0.9rem;">0 connections</span>
                    </div>

                    <!-- Search and Filter Bar -->
                    <div id="connectionsSearchBar" style="display: none; margin-bottom: 1.5rem;">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <!-- Search Input -->
                            <div style="flex: 1; min-width: 250px;">
                                <input
                                    type="text"
                                    id="connectionsSearch"
                                    placeholder=" Search connections by name, company, or industry..."
                                    oninput="filterConnections()"
                                    style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 0.95rem;"
                                >
                            </div>

                            <!-- Sort Dropdown -->
                            <select
                                id="connectionsSort"
                                onchange="sortConnections()"
                                style="padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 0.95rem; cursor: pointer;"
                            >
                                <option value="recent">Most Recent</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="company">Company (A-Z)</option>
                                <option value="industry">Industry</option>
                            </select>

                            <!-- Industry Filter -->
                            <select
                                id="connectionsIndustryFilter"
                                onchange="filterConnections()"
                                style="padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 0.95rem; cursor: pointer;"
                            >
                                <option value="">All Industries</option>
                            </select>
                        </div>

                        <!-- Results count -->
                        <div id="connectionsResultCount" style="color: #999; font-size: 0.9rem; margin-bottom: 1rem;"></div>
                    </div>

                    <div id="activeConnectionsList">
                        <div style="text-align: center; padding: 1.5rem; color: #999;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                            <h4 style="color: #e8eaed; margin-bottom: 0.25rem; font-size: 1rem;">No connections yet</h4>
                            <p style="font-size: 0.9rem; margin-bottom: 0.75rem;">Start building your network by connecting with members.</p>
                            <button class="register-btn" onclick="showSection('directory')" style="margin-top: 0.5rem; padding: 0.6rem 1.2rem; font-size: 0.9rem;">Find Members to Connect</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Events Section -->
            <section id="events" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Events</h1>
                    <p>Upcoming networking events and workshops</p>
                </div>

                <div class="event-card">
                    <div class="event-header">
                        <div class="event-info">
                            <h3>Monthly Breakfast Networking</h3>
                            <div class="event-details">
                                <p><strong>Date:</strong> January 28th, 2025</p>
                                <p><strong>Time:</strong> 9:00 AM - 10:30 AM</p>
                                <p><strong>Location:</strong> Miami Design District</p>
                                <p><strong>Description:</strong> Connect with fellow business leaders over breakfast and coffee. Network, share insights, and build meaningful relationships.</p>
                            </div>
                        </div>
                        <div class="event-date">
                            JAN<br>28
                        </div>
                    </div>
                    <button class="register-btn">Register Now</button>
                </div>

            </section>

            <!-- Profile Section -->
            <section id="profile" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">My Business Profile</h1>
                    <p>Optimize your profile for better business matching and opportunities</p>
                </div>

                <!-- Profile Completion Progress -->
                <div class="profile-progress-card">
                    <div class="progress-header">
                        <h3> Profile Strength</h3>
                        <span class="progress-percentage" id="profileCompletionPercentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="profileProgressFill"></div>
                    </div>
                    <div class="progress-tips">
                        <div class="tip-item" id="tipBasicInfo">
                            <span class="tip-icon"></span>
                            <span class="tip-text">Complete basic information</span>
                            <span class="tip-status" id="statusBasicInfo"></span>
                        </div>
                        <div class="tip-item" id="tipPhoto">
                            <span class="tip-icon"></span>
                            <span class="tip-text">Add your profile photo</span>
                            <span class="tip-status" id="statusPhoto"></span>
                        </div>
                        <div class="tip-item" id="tipBusinessInfo">
                            <span class="tip-icon"></span>
                            <span class="tip-text">Set business preferences</span>
                            <span class="tip-status" id="statusBusinessInfo"></span>
                        </div>
                        <div class="tip-item" id="tipLinkedIn">
                            <span class="tip-icon"></span>
                            <span class="tip-text">Add LinkedIn profile</span>
                            <span class="tip-status" id="statusLinkedIn"></span>
                        </div>
                    </div>
                    <div class="progress-action">
                        <button class="complete-profile-btn" onclick="focusIncompleteSection()">
                            <span id="progressActionText">Complete Your Profile</span> 
                        </button>
                    </div>
                </div>

                <!-- Profile Analytics Dashboard -->
                <div class="dashboard-card" id="profileAnalytics" style="background: linear-gradient(135deg, rgba(116, 89, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%); border: 1px solid rgba(116, 89, 255, 0.3); margin-bottom: 2rem;">
                    <div class="card-header" style="margin-bottom: 1.5rem;">
                        <h3 class="card-title" style="color: #7459ff;"> Profile Analytics</h3>
                        <span style="color: #999; font-size: 0.85rem;">Last 30 days</span>
                    </div>

                    <!-- Analytics Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <!-- Profile Views -->
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1.25rem; border-radius: 10px; border-left: 4px solid #7459ff;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: #999; font-size: 0.85rem;">Profile Views</span>
                                <span style="font-size: 1.5rem;"></span>
                            </div>
                            <div style="font-size: 2rem; color: #7459ff; font-weight: 700; margin-bottom: 0.25rem;" id="analyticsProfileViews">0</div>
                            <div style="color: #51cf66; font-size: 0.8rem;" id="analyticsViewsTrend"></div>
                        </div>

                        <!-- Connection Rate -->
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1.25rem; border-radius: 10px; border-left: 4px solid #51cf66;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: #999; font-size: 0.85rem;">Connection Rate</span>
                                <span style="font-size: 1.5rem;"></span>
                            </div>
                            <div style="font-size: 2rem; color: #51cf66; font-weight: 700; margin-bottom: 0.25rem;" id="analyticsConnectionRate">0%</div>
                            <div style="color: #ccc; font-size: 0.8rem;" id="analyticsConnectionStats">0 accepted / 0 sent</div>
                        </div>

                        <!-- Active Connections -->
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1.25rem; border-radius: 10px; border-left: 4px solid #C9A86A;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: #999; font-size: 0.85rem;">Total Connections</span>
                                <span style="font-size: 1.5rem;"></span>
                            </div>
                            <div style="font-size: 2rem; color: #C9A86A; font-weight: 700; margin-bottom: 0.25rem;" id="analyticsTotalConnections">0</div>
                            <div style="color: #51cf66; font-size: 0.8rem;" id="analyticsConnectionsGrowth"></div>
                        </div>

                        <!-- Messages Sent -->
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1.25rem; border-radius: 10px; border-left: 4px solid #fab005;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: #999; font-size: 0.85rem;">Messages Sent</span>
                                <span style="font-size: 1.5rem;"></span>
                            </div>
                            <div style="font-size: 2rem; color: #fab005; font-weight: 700; margin-bottom: 0.25rem;" id="analyticsMessagesSent">0</div>
                            <div style="color: #ccc; font-size: 0.8rem;">This month</div>
                        </div>
                    </div>

                    <!-- Profile Strength Breakdown -->
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                        <h4 style="color: #e8eaed; margin-bottom: 1rem;"> Profile Strength Breakdown</h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #ccc;">Basic Information</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                                        <div id="strengthBasicInfo" style="height: 100%; background: #51cf66; width: 0%; transition: width 0.5s ease;"></div>
                                    </div>
                                    <span id="strengthBasicInfoPercent" style="color: #51cf66; font-weight: 600; min-width: 35px;">0%</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #ccc;">Profile Photo</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                                        <div id="strengthPhoto" style="height: 100%; background: #51cf66; width: 0%; transition: width 0.5s ease;"></div>
                                    </div>
                                    <span id="strengthPhotoPercent" style="color: #51cf66; font-weight: 600; min-width: 35px;">0%</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #ccc;">Company Logo</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                                        <div id="strengthLogo" style="height: 100%; background: #51cf66; width: 0%; transition: width 0.5s ease;"></div>
                                    </div>
                                    <span id="strengthLogoPercent" style="color: #51cf66; font-weight: 600; min-width: 35px;">0%</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #ccc;">Industries Selected</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                                        <div id="strengthIndustries" style="height: 100%; background: #51cf66; width: 0%; transition: width 0.5s ease;"></div>
                                    </div>
                                    <span id="strengthIndustriesPercent" style="color: #51cf66; font-weight: 600; min-width: 35px;">0%</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: #ccc;">LinkedIn Connected</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                                        <div id="strengthLinkedIn" style="height: 100%; background: #51cf66; width: 0%; transition: width 0.5s ease;"></div>
                                    </div>
                                    <span id="strengthLinkedInPercent" style="color: #51cf66; font-weight: 600; min-width: 35px;">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Timeline -->
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 10px;">
                        <h4 style="color: #e8eaed; margin-bottom: 1rem;"> Recent Activity</h4>
                        <div id="activityTimeline" style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.03); border-radius: 6px;">
                                <span style="font-size: 1.25rem;"></span>
                                <div style="flex: 1;">
                                    <div style="color: #e8eaed; font-size: 0.9rem;">Profile last updated</div>
                                    <div style="color: #999; font-size: 0.8rem;" id="activityLastUpdate">Never</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.03); border-radius: 6px;">
                                <span style="font-size: 1.25rem;"></span>
                                <div style="flex: 1;">
                                    <div style="color: #e8eaed; font-size: 0.9rem;">Last connection made</div>
                                    <div style="color: #999; font-size: 0.8rem;" id="activityLastConnection">No connections yet</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.03); border-radius: 6px;">
                                <span style="font-size: 1.25rem;"></span>
                                <div style="flex: 1;">
                                    <div style="color: #e8eaed; font-size: 0.9rem;">Member since</div>
                                    <div style="color: #999; font-size: 0.8rem;" id="activityMemberSince"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Photo Section -->
                <div id="profilePhotoSection" class="dashboard-card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title" style="color: #C9A86A;"> Profile Photo & Company Logo</h3>
                    </div>
                    <p style="color: #ccc; margin-bottom: 1.5rem;">Add your personal photo or company logo to help other members recognize and connect with you.</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 style="color: #e8eaed; margin-bottom: 1rem;"> Personal Photo</h4>
                            <div class="photo-upload-section">
                                <div class="photo-preview" id="personalPhotoPreview">
                                    <div class="photo-placeholder">
                                        <span class="photo-icon"></span>
                                        <p>No photo uploaded</p>
                                    </div>
                                </div>
                                <div class="upload-controls">
                                    <input type="file" id="personalPhotoUpload" accept="image/*" style="display: none;">
                                    <button type="button" class="upload-btn" onclick="document.getElementById('personalPhotoUpload').click()">
                                         Upload Photo
                                    </button>
                                    <button type="button" class="remove-btn" id="removePersonalPhoto" style="display: none;" onclick="removePhoto('personal')">
                                         Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: #e8eaed; margin-bottom: 1rem;"> Company Logo</h4>
                            <div class="photo-upload-section">
                                <div class="photo-preview" id="companyLogoPreview">
                                    <div class="photo-placeholder">
                                        <span class="photo-icon"></span>
                                        <p>No logo uploaded</p>
                                    </div>
                                </div>
                                <div class="upload-controls">
                                    <input type="file" id="companyLogoUpload" accept="image/*" style="display: none;">
                                    <button type="button" class="upload-btn" onclick="document.getElementById('companyLogoUpload').click()">
                                         Upload Logo
                                    </button>
                                    <button type="button" class="remove-btn" id="removeCompanyLogo" style="display: none;" onclick="removePhoto('company')">
                                         Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border-left: 4px solid #C9A86A;">
                        <p style="color: #C9A86A; font-weight: 500; margin-bottom: 0.5rem;"> Photo Guidelines</p>
                        <ul style="color: #ccc; font-size: 0.9rem; margin-left: 1rem;">
                            <li>Personal photos work best when they're professional headshots</li>
                            <li>Company logos should be clear and high-resolution</li>
                            <li>Supported formats: JPG, PNG, GIF (max 5MB)</li>
                            <li>Square images (1:1 ratio) display best</li>
                        </ul>
                    </div>
                </div>

                <!-- Basic Profile Information -->
                <div class="dashboard-card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title" style="color: #C9A86A;"> Basic Information</h3>
                    </div>
                    <p style="color: #ccc; margin-bottom: 1.5rem;">Update your professional information to help other members connect with you.</p>

                    <div style="display: grid; gap: 1.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div class="form-group">
                                <label for="memberName" style="display: block; color: #e8eaed; margin-bottom: 0.5rem; font-weight: 500;">Full Name *</label>
                                <input type="text" id="memberName" name="memberName" class="profile-input" placeholder="John Doe" required style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e8eaed; font-size: 1rem;">
                            </div>
                            <div class="form-group">
                                <label for="memberCompany" style="display: block; color: #e8eaed; margin-bottom: 0.5rem; font-weight: 500;">Company Name *</label>
                                <input type="text" id="memberCompany" name="memberCompany" class="profile-input" placeholder="Your Company Inc." required style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e8eaed; font-size: 1rem;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div class="form-group">
                                <label for="memberTitle" style="display: block; color: #e8eaed; margin-bottom: 0.5rem; font-weight: 500;">Job Title *</label>
                                <input type="text" id="memberTitle" name="memberTitle" class="profile-input" placeholder="CEO, Founder, etc." required style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e8eaed; font-size: 1rem;">
                            </div>
                            <div class="form-group">
                                <label style="display: block; color: #e8eaed; margin-bottom: 0.5rem; font-weight: 500;">Industries * <span style="font-size: 0.85rem; color: #999; font-weight: 400;">(Select all that apply)</span></label>
                                <div id="memberIndustries" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Technology" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Technology</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Finance" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Finance</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Healthcare" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Healthcare</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Real Estate" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Real Estate</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Retail" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Retail</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Hospitality" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Hospitality</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Professional Services" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Professional Services</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Manufacturing" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Manufacturing</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Education" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Education</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Non-Profit" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Non-Profit</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Marketing" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Marketing</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Consulting" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Consulting</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #e8eaed;">
                                        <input type="checkbox" name="industry" value="Other" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>Other</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div class="form-group">
                                <label for="memberPhone" style="display: block; color: #e8eaed; margin-bottom: 0.5rem; font-weight: 500;">Phone Number (Optional)</label>
                                <input type="tel" id="memberPhone" name="memberPhone" class="profile-input" placeholder="(305) 123-4567" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e8eaed; font-size: 1rem;">
                            </div>
                            <div class="form-group">
                                <label for="memberLinkedIn" style="display: block; color: #e8eaed; margin-bottom: 0.5rem; font-weight: 500;">LinkedIn Profile URL (Optional)</label>
                                <input type="url" id="memberLinkedIn" name="memberLinkedIn" class="profile-input" placeholder="https://linkedin.com/in/yourprofile" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e8eaed; font-size: 1rem;">
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                            <button type="button" onclick="saveProfile()" style="padding: 0.75rem 2rem; background: #C9A86A; color: #000; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                                 Save Profile
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border-left: 4px solid #C9A86A;">
                        <p style="color: #C9A86A; font-weight: 500; margin-bottom: 0.5rem;"> Profile Tips</p>
                        <ul style="color: #ccc; font-size: 0.9rem; margin-left: 1rem;">
                            <li>Complete all fields marked with * for better matching</li>
                            <li>Use your professional name as it appears on LinkedIn</li>
                            <li>Your profile helps other members find and connect with you</li>
                            <li>All changes are saved to your account instantly</li>
                        </ul>
                    </div>
                </div>

                <!-- Privacy & Communication Preferences -->
                <div class="dashboard-card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title" style="color: #C9A86A;"> Privacy & Communication Preferences</h3>
                    </div>
                    <p style="color: #ccc; margin-bottom: 1.5rem;">Control how other members can contact you and what information is shared.</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 style="color: #e8eaed; margin-bottom: 1rem;"> Email Preferences</h4>
                            <div class="privacy-setting">
                                <div class="toggle-container">
                                    <input type="checkbox" id="allowMemberEmails" class="privacy-toggle" checked>
                                    <label for="allowMemberEmails" class="toggle-label">
                                        <span class="toggle-switch"></span>
                                        <span class="toggle-text">Allow members to email me directly</span>
                                    </label>
                                </div>
                                <p class="setting-description">When enabled, other members can email you with a pre-filled template that identifies them as MBC members.</p>
                            </div>
                            
                            <div class="privacy-setting" style="margin-top: 1rem;">
                                <div class="toggle-container">
                                    <input type="checkbox" id="includePhoneInEmails" class="privacy-toggle">
                                    <label for="includePhoneInEmails" class="toggle-label">
                                        <span class="toggle-switch"></span>
                                        <span class="toggle-text">Include my phone number in email template</span>
                                    </label>
                                </div>
                                <p class="setting-description">Your phone number will be included in the email template for easier follow-up.</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: #e8eaed; margin-bottom: 1rem;"> Profile Visibility</h4>
                            <div class="privacy-setting">
                                <div class="toggle-container">
                                    <input type="checkbox" id="showEmailInDirectory" class="privacy-toggle">
                                    <label for="showEmailInDirectory" class="toggle-label">
                                        <span class="toggle-switch"></span>
                                        <span class="toggle-text">Show email address in member directory</span>
                                    </label>
                                </div>
                                <p class="setting-description">Other members will see your email address directly in the directory.</p>
                            </div>
                            
                            <div class="privacy-setting" style="margin-top: 1rem;">
                                <div class="toggle-container">
                                    <input type="checkbox" id="allowLinkedInConnection" class="privacy-toggle" checked>
                                    <label for="allowLinkedInConnection" class="toggle-label">
                                        <span class="toggle-switch"></span>
                                        <span class="toggle-text">Show LinkedIn profile link</span>
                                    </label>
                                </div>
                                <p class="setting-description">Members can connect with you on LinkedIn through your profile.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(40, 167, 69, 0.1); border-radius: 8px; border-left: 4px solid #51cf66;">
                        <p style="color: #51cf66; font-weight: 500; margin-bottom: 0.5rem;"> Email Security</p>
                        <ul style="color: #ccc; font-size: 0.9rem; margin-left: 1rem;">
                            <li>All emails include MBC member verification for authenticity</li>
                            <li>Your email address is never shared without your permission</li>
                            <li>Email templates include professional MBC branding</li>
                            <li>You can change these preferences anytime</li>
                        </ul>
                    </div>
                </div>

                <!-- Member Referral & Rewards System -->
                <div class="dashboard-card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title" style="color: #C9A86A;"> Invite & Earn Rewards</h3>
                        <span class="referral-points-badge" id="memberPoints">0 pts</span>
                    </div>
                    <p style="color: #ccc; margin-bottom: 1.5rem;">Grow the Miami Business Council community and earn exclusive rewards, speaking opportunities, and benefits!</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h4 style="color: #e8eaed; margin-bottom: 1rem;"> Your Referral Link</h4>
                            <div class="referral-link-container">
                                <input type="text" class="referral-link-input" id="referralLinkInput" value="Coming Soon - Join page under development" readonly>
                                <button class="copy-link-btn" onclick="copyReferralLink()"> Copy</button>
                            </div>
                            <div class="share-buttons" style="margin-top: 1rem;">
                                <button class="share-btn email" onclick="showInviteModal()"> Send Invite</button>
                                <button class="share-btn linkedin" onclick="shareOnLinkedIn()"> LinkedIn</button>
                                <button class="share-btn sms" onclick="shareViaSMS()"> SMS</button>
                                <button class="share-btn generic" onclick="shareGeneric()"> Share</button>
                            </div>
                            <p style="color: #999; font-size: 0.85rem; margin-top: 0.75rem;">
                                 <strong style="color: #C9A86A;">Send Invite</strong> sends a personalized email with your referral
                            </p>
                        </div>

                        <div>
                            <h4 style="color: #e8eaed; margin-bottom: 1rem;"> Your Referral Stats</h4>
                            <div class="referral-stats">
                                <div class="stat-item">
                                    <span class="stat-number" id="totalInvites">0</span>
                                    <span class="stat-label">Total Invites Sent</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" id="successfulReferrals">0</span>
                                    <span class="stat-label">Successful Referrals</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" id="conversionRate">0%</span>
                                    <span class="stat-label">Conversion Rate</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rewards-section">
                        <h4 style="color: #e8eaed; margin-bottom: 1rem;"> Available Rewards</h4>
                        <div class="rewards-grid">
                            <div class="reward-card unlocked">
                                <div class="reward-icon"></div>
                                <div class="reward-details">
                                    <div class="reward-title">Speaking Opportunity</div>
                                    <div class="reward-description">Present at next MBC event</div>
                                    <div class="reward-cost">500 points</div>
                                </div>
                                <button class="claim-reward-btn" onclick="claimReward('speaking')">Claim</button>
                            </div>
                            
                            <div class="reward-card unlocked">
                                <div class="reward-icon"></div>
                                <div class="reward-details">
                                    <div class="reward-title">Affiliate Commission</div>
                                    <div class="reward-description">20% commission on referrals</div>
                                    <div class="reward-cost">300 points</div>
                                </div>
                                <button class="claim-reward-btn" onclick="claimReward('affiliate')">Claim</button>
                            </div>
                            
                            <div class="reward-card locked">
                                <div class="reward-icon"></div>
                                <div class="reward-details">
                                    <div class="reward-title">VIP Event Access</div>
                                    <div class="reward-description">Exclusive networking events</div>
                                    <div class="reward-cost">750 points</div>
                                </div>
                                <button class="claim-reward-btn disabled">Need 750 pts</button>
                            </div>
                            
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border-left: 4px solid #C9A86A;">
                        <p style="color: #C9A86A; font-weight: 500; margin-bottom: 0.5rem;"> How It Works</p>
                        <ul style="color: #ccc; font-size: 0.9rem; margin-left: 1rem;">
                            <li><strong>Invite:</strong> Share your unique referral link with quality business contacts</li>
                            <li><strong>Earn:</strong> Get 100 points for each successful member referral</li>
                            <li><strong>Redeem:</strong> Use points for speaking slots, affiliate commissions, or exclusive access</li>
                            <li><strong>Grow:</strong> Help build Miami's premier business community while earning rewards</li>
                        </ul>
                    </div>
                </div>

                <!-- Smart Matching Section -->
                <div class="dashboard-card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title" style="color: #C9A86A;"> Smart Matching Profile</h3>
                        <button class="register-btn" onclick="generateSmartMatches()" style="padding: 0.5rem 1rem;">Find My Matches</button>
                    </div>
                    <p style="color: #ccc; margin-bottom: 2rem;">Help us connect you with your ideal clients, partners, and opportunities by completing your matching profile.</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 style="color: #e8eaed; margin-bottom: 1rem;"> My Ideal Client Profile</h4>
                            <div class="profile-field">
                                <label>Industry Focus:</label>
                                <select class="profile-input" id="targetIndustry">
                                    <option value="">Select target industry</option>
                                    <option value="Technology">Technology & Software</option>
                                    <option value="Real Estate">Real Estate & Construction</option>
                                    <option value="Healthcare">Healthcare & Wellness</option>
                                    <option value="Finance">Finance & Investment</option>
                                    <option value="Marketing">Marketing & Advertising</option>
                                    <option value="Legal">Legal & Professional Services</option>
                                    <option value="Retail">Retail & E-commerce</option>
                                    <option value="Hospitality">Hospitality & Tourism</option>
                                    <option value="Non-Profit">Non-Profit & Social Impact</option>
                                    <option value="Design">Design & Creative</option>
                                    <option value="Creative">Creative & Arts</option>
                                    <option value="Fashion">Fashion & Apparel</option>
                                    <option value="Manufacturing">Manufacturing & Industrial</option>
                                    <option value="Public Relations">Public Relations & Communications</option>
                                    <option value="Media">Media & Entertainment</option>
                                    <option value="Wellness">Wellness & Fitness</option>
                                    <option value="Architecture">Architecture & Engineering</option>
                                    <option value="Consulting">Consulting & Advisory</option>
                                    <option value="Education">Education & Training</option>
                                    <option value="Any">Open to All Industries</option>
                                </select>
                            </div>
                            <div class="profile-field">
                                <label>Company Size Preference:</label>
                                <select class="profile-input" id="targetSize">
                                    <option value="">Any size</option>
                                    <option value="startup">Startup (1-10 employees)</option>
                                    <option value="small">Small Business (11-50 employees)</option>
                                    <option value="medium">Medium Business (51-200 employees)</option>
                                    <option value="large">Large Enterprise (200+ employees)</option>
                                </select>
                            </div>
                            <div class="profile-field">
                                <label>Budget Range (Annual):</label>
                                <select class="profile-input" id="targetBudget">
                                    <option value="">Not specified</option>
                                    <option value="under-10k">Under $10,000</option>
                                    <option value="10k-50k">$10,000 - $50,000</option>
                                    <option value="50k-100k">$50,000 - $100,000</option>
                                    <option value="100k-500k">$100,000 - $500,000</option>
                                    <option value="500k-plus">$500,000+</option>
                                </select>
                            </div>
                            <div class="profile-field">
                                <label>Geographic Focus:</label>
                                <select class="profile-input" id="targetLocation">
                                    <option value="miami">Miami-Dade County</option>
                                    <option value="south-florida">South Florida Region</option>
                                    <option value="florida">Florida Statewide</option>
                                    <option value="southeast">Southeast US</option>
                                    <option value="national">National/Remote</option>
                                    <option value="international">International</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: #e8eaed; margin-bottom: 1rem;"> What I Offer</h4>
                            <div class="profile-field">
                                <label>Primary Service/Product:</label>
                                <textarea class="profile-input" id="primaryOffering" placeholder="Describe your main service or product offering..." rows="3"></textarea>
                            </div>
                            <div class="profile-field">
                                <label>Unique Value Proposition:</label>
                                <textarea class="profile-input" id="valueProposition" placeholder="What makes you different from competitors?" rows="2"></textarea>
                            </div>
                            <div class="profile-field">
                                <label>Collaboration Style:</label>
                                <select class="profile-input" id="workStyle">
                                    <option value="in-person">Prefer In-Person Meetings</option>
                                    <option value="virtual">Comfortable with Virtual</option>
                                    <option value="hybrid">Flexible - Both Virtual & In-Person</option>
                                    <option value="project-based">Project-Based Engagement</option>
                                    <option value="ongoing">Long-term Partnership Focus</option>
                                </select>
                            </div>
                            <div class="profile-field">
                                <label>Business Goals for 2025:</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                                    <label class="radio-option">
                                        <input type="checkbox" name="business-goals" value="grow-revenue">
                                        <span>Grow Revenue</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="checkbox" name="business-goals" value="expand-team">
                                        <span>Expand Team</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="checkbox" name="business-goals" value="new-markets">
                                        <span>Enter New Markets</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="checkbox" name="business-goals" value="strategic-partnerships">
                                        <span>Strategic Partnerships</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="checkbox" name="business-goals" value="raise-funding">
                                        <span>Raise Funding</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="checkbox" name="business-goals" value="improve-operations">
                                        <span>Improve Operations</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; max-width: 1000px;">
                    <!-- Business Information -->
                    <div class="dashboard-card">
                        <h3 style="color: #C9A86A; margin-bottom: 1rem;">Business Information</h3>
                        <div class="profile-field">
                            <label><strong>Name:</strong></label>
                            <input type="text" id="memberName" class="profile-input" placeholder="Enter your full name">
                        </div>
                        <div class="profile-field">
                            <label><strong>Company:</strong></label>
                            <input type="text" id="memberCompany" class="profile-input" placeholder="Enter your company name">
                        </div>
                        <div class="profile-field">
                            <label><strong>Title:</strong></label>
                            <input type="text" id="memberTitle" class="profile-input" placeholder="Enter your job title">
                        </div>
                        <div class="profile-field">
                            <label><strong>Industry:</strong></label>
                            <select id="memberIndustry" class="profile-input">
                                <option value="">Select your industry</option>
                                <option value="Technology">Technology</option>
                                <option value="Real Estate">Real Estate</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Finance">Finance</option>
                                <option value="Legal">Legal</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Retail">Retail</option>
                                <option value="Hospitality">Hospitality</option>
                                <option value="Non-Profit">Non-Profit</option>
                                <option value="Design">Design</option>
                                <option value="Fashion">Fashion</option>
                                <option value="Manufacturing">Manufacturing</option>
                                <option value="Public Relations">Public Relations</option>
                                <option value="Media">Media</option>
                                <option value="Wellness">Wellness</option>
                                <option value="Architecture">Architecture</option>
                                <option value="Creative">Creative</option>
                                <option value="Consulting">Consulting</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="profile-field">
                            <label><strong>LinkedIn:</strong></label>
                            <input type="url" id="memberLinkedIn" class="profile-input" placeholder="linkedin.com/in/yourprofile">
                        </div>
                    </div>

                    <!-- Business Opportunities -->
                    <div class="dashboard-card">
                        <h3 style="color: #C9A86A; margin-bottom: 1rem;">Business Matching</h3>
                        
                        <div class="opportunity-section">
                            <h4 style="color: #e8eaed; margin-bottom: 0.5rem;"> What I'm Looking For:</h4>
                            <div class="tag-container">
                                <span class="opportunity-tag" onclick="toggleTag(this)">Clients</span>
                                <span class="opportunity-tag" onclick="toggleTag(this)">Partnerships</span>
                                <span class="opportunity-tag" onclick="toggleTag(this)">Investors</span>
                                <span class="opportunity-tag" onclick="toggleTag(this)">Mentors</span>
                                <span class="opportunity-tag" onclick="toggleTag(this)">Vendors</span>
                                <span class="opportunity-tag" onclick="toggleTag(this)">Co-founders</span>
                            </div>
                        </div>

                        <div class="opportunity-section">
                            <h4 style="color: #e8eaed; margin-bottom: 0.5rem;"> What I Can Offer:</h4>
                            <div class="tag-container">
                                <span class="opportunity-tag" onclick="toggleTag(this)">Business Strategy</span>
                                <span class="opportunity-tag" onclick="toggleTag(this)">Consulting</span>
                                <span class="opportunity-tag" onclick="toggleTag(this)">Funding</span>
                                <span class="opportunity-tag" onclick="toggleTag(this)">Mentoring</span>
                                <span class="opportunity-tag" onclick="toggleTag(this)">Services</span>
                                <span class="opportunity-tag" onclick="toggleTag(this)">Expertise</span>
                            </div>
                        </div>

                        <div class="opportunity-section">
                            <h4 style="color: #e8eaed; margin-bottom: 0.5rem;"> Company Size:</h4>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="company-size" value="solo">
                                    <span>Solo/Freelancer (1)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="company-size" value="small">
                                    <span>Small Team (2-10)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="company-size" value="medium">
                                    <span>Medium Business (11-50)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="company-size" value="large">
                                    <span>Large Company (50+)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Matching Results -->
                <div class="dashboard-card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title"> Potential Business Matches</h3>
                        <button class="register-btn" onclick="findMatches()" style="padding: 0.5rem 1rem;">Find New Matches</button>
                    </div>
                    
                    <div class="match-grid" id="matchResults">
                        <div style="text-align: center; padding: 3rem; color: #999; grid-column: 1 / -1;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <h4 style="color: #e8eaed; margin-bottom: 0.5rem;">No matches yet</h4>
                            <p>Complete your profile and business preferences to get AI-powered match recommendations.</p>
                            <button class="register-btn" onclick="showSection('directory')" style="margin-top: 1rem;">Browse All Members</button>
                        </div>
                    </div>
                </div>

                <div class="profile-actions" style="text-align: center; margin-top: 2rem;">
                    <button class="register-btn" onclick="saveProfile()" style="margin-right: 1rem;">Save Profile</button>
                    <button class="register-btn" onclick="shareProfile()" style="background: rgba(255,255,255,0.1); color: #e8eaed;">Share Profile</button>
                </div>
            </section>

            <!-- Admin Panel Section -->
            <section id="admin" class="content-section">
                <div class="section-header">
                    <h1 class="section-title"> Admin Panel</h1>
                    <p>Manage members, send invitations, and oversee portal activity</p>
                </div>

                <!-- Admin Stats -->
                <div class="dashboard-grid" style="margin-bottom: 2rem;">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Member Overview</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><strong>Total Members:</strong> <span id="adminTotalMemberCount">0</span></p>
                        <p><strong>Active This Month:</strong> <span id="adminActiveThisMonth">0</span></p>
                        <p><strong>Pending Invites:</strong> <span id="adminPendingInvites">0</span></p>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Portal Activity</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p><strong>Login Rate:</strong> <span id="adminLoginRate">-</span></p>
                        <p><strong>Profile Completion:</strong> <span id="adminProfileCompletion">-</span></p>
                        <p><strong>Connection Rate:</strong> <span id="adminConnectionRate">-</span></p>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                            <span class="card-icon"></span>
                        </div>
                        <p id="adminRecentActivity"> No recent activity</p>
                    </div>
                </div>

                <!-- Member List View -->
                <div class="dashboard-card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h3 style="color: #C9A86A; margin: 0;"> All Members</h3>
                        <button class="btn-secondary btn-small" onclick="refreshMemberList()"> Refresh</button>
                    </div>
                    
                    <div id="memberListContainer" style="margin-top: 1rem;">
                        <div class="loading-message" style="text-align: center; padding: 2rem; color: #ccc;">
                            Loading member list...
                        </div>
                    </div>
                </div>

                <!-- Add New Member -->
                <div class="dashboard-card" style="margin-bottom: 2rem;">
                    <h3 style="color: #C9A86A; margin-bottom: 1rem;"> Invite New Member</h3>
                    <p style="color: #ccc; margin-bottom: 1.5rem; font-size: 0.9rem;"> Add a new member to the portal. They'll receive a magic link to log in and complete their profile.</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="profile-field">
                            <label>First Name <span style="color: #ff6b6b;">*</span>:</label>
                            <input type="text" class="profile-input" id="newMemberFirstName" placeholder="Enter first name" required>
                        </div>
                        <div class="profile-field">
                            <label>Last Name <span style="color: #ff6b6b;">*</span>:</label>
                            <input type="text" class="profile-input" id="newMemberLastName" placeholder="Enter last name" required>
                        </div>
                    </div>

                    <div class="profile-field" style="margin-bottom: 1.5rem;">
                        <label>Email Address <span style="color: #ff6b6b;">*</span>:</label>
                        <input type="email" class="profile-input" id="newMemberEmail" placeholder="member@company.com" required>
                        <div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">They'll use this email to request a magic link and log in</div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button class="register-btn" onclick="addNewMember()">
                             Add Member to Portal
                        </button>
                    </div>
                    <div style="font-size: 0.85rem; color: #999; margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <strong>How it works:</strong><br>
                        1. Add member details above and click "Add Member to Portal"<br>
                        2. Share the login page with them: <a href="https://miamibusinesscouncil.com/member-login" style="color: #C9A86A;">miamibusinesscouncil.com/member-login</a><br>
                        3. They enter their email and receive a magic link to log in<br>
                        4. They complete their profile after first login
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="dashboard-card">
                    <h3 style="color: #C9A86A; margin-bottom: 1.5rem;"> Bulk Actions</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <button class="profile-action-btn secondary" onclick="sendBulkWelcomeEmails()">
                             Welcome Email Blast
                        </button>
                        <button class="profile-action-btn secondary" onclick="sendEventReminders()">
                             Event Reminders
                        </button>
                        <button class="profile-action-btn secondary" onclick="exportMemberData()">
                             Export Member Data
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Member Profile Modal -->
    <div class="member-profile-modal" id="memberProfileModal">
        <div class="member-profile-content">
            <button class="profile-close-btn" onclick="closeMemberProfile()"></button>
            
            <div class="profile-hero">
                <div class="profile-avatar-large" id="profileAvatarLarge">AS</div>
                <h2 class="profile-name" id="profileName">April Sabral</h2>
                <p class="profile-title" id="profileTitle">Founder & CEO</p>
                <p class="profile-company" id="profileCompany">AskApril AI</p>
            </div>

            <div class="profile-section">
                <h3> Professional Background</h3>
                <div class="profile-info-grid">
                    <div class="profile-info-item">
                        <div class="profile-info-label">Industry Focus</div>
                        <div class="profile-info-value" id="profileIndustry">Technology, AI/ML</div>
                    </div>
                    <div class="profile-info-item">
                        <div class="profile-info-label">Member Since</div>
                        <div class="profile-info-value">January 2025</div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3> Expertise & Services</h3>
                <div class="profile-tags" id="profileTags">
                    <span class="profile-tag">Technology</span>
                    <span class="profile-tag">AI/ML</span>
                    <span class="profile-tag">Business</span>
                </div>
            </div>

            <div class="profile-section">
                <h3> Business Interests</h3>
                <div class="profile-info-grid">
                    <div class="profile-info-item">
                        <div class="profile-info-label">Looking For</div>
                        <div class="profile-info-value" id="profileLookingFor">Small business owners, Retail clients, Growth partnerships</div>
                    </div>
                    <div class="profile-info-item">
                        <div class="profile-info-label">Can Offer</div>
                        <div class="profile-info-value" id="profileCanOffer">AI coaching, Business strategy, Digital transformation</div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <div class="profile-actions">
                    <button class="profile-action-btn email-action" id="profileEmailBtn" onclick="sendMBCEmail('april@apriljsabral.com', 'April Sabral', 'AskApril AI')">
                         Send Email
                    </button>
                    <button class="profile-action-btn chat-action" id="profileChatBtn" onclick="startChat('april', 'April Sabral', 'AskApril AI')">
                         Start Chat
                    </button>
                    <a class="profile-action-btn linkedin-action" id="profileLinkedInBtn" href="https://linkedin.com/in/apriljsabral" target="_blank">
                         LinkedIn Profile
                    </a>
                    <button class="profile-action-btn connect-action" id="profileConnectBtn" onclick="requestConnection('april', 'April Sabral')">
                         Connect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        //  VERSION 2.0 - REAL DATABASE STATS + NO AUTO-RESPONSES
        // Deployed: Jan 23, 2026 10:20 PM
        // console.log(' Portal Version 2.0 Loaded - Real Stats, No Fake Messages');

        // Initialize Supabase client
        var SUPABASE_URL = 'https://vsnvtujkkkbjpuuwxvyd.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzbnZ0dWpra2tianB1dXd4dnlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MzUyNDYsImV4cCI6MjA3MTIxMTI0Nn0.GwWKrl_6zlIBvIaJs8NngoheF24nNzAfBO5_j_d1ogA';

        var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global member data cache
        let currentMember = null;

        // Authentication check
        async function checkAuthentication(retryCount = 0) {
            try {
                // Get current session from Supabase
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();

                if (!session || sessionError) {
                    // If we're processing a magic link, retry up to 4 times before redirecting
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    const hasAuthToken = hashParams.has('access_token');

                    if (hasAuthToken && retryCount < 4) {
                        // console.log(` Session not ready yet, retry ${retryCount + 1}/4 in 2 seconds...`);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        return checkAuthentication(retryCount + 1);
                    }

                    // console.log(' No active session after all retries, redirecting to login...');
                    window.location.href = '/member-login';
                    return false;
                }

                // console.log('Active session found for user:', session.user.email);

                // Fetch member profile from database
                const { data: member, error: memberError } = await supabase
                    .from('members')
                    .select('*')
                    .eq('auth_user_id', session.user.id)
                    .single();

                if (memberError || !member) {
                    console.error('Member profile not found:', memberError);
                    // Profile doesn't exist - this email has auth but no member record
                    alert('This email is not registered as a member.\n\nPlease contact info@miamibusinesscouncil.com to request access.');
                    await supabase.auth.signOut();
                    window.location.href = '/member-login';
                    return false;
                }

                // Store member data globally
                currentMember = member;
                // console.log('Member profile loaded:', member);

                // Update UI with member info
                const firstName = member.first_name || '';
                const lastName = member.last_name || '';
                const fullName = lastName ? `${firstName} ${lastName}` : firstName;

                const userNameElement = document.getElementById('userName');
                if (userNameElement) {
                    userNameElement.textContent = fullName;
                }

                const initials = lastName ? `${firstName[0]}${lastName[0]}`.toUpperCase() : `${firstName[0]}${firstName[1] || ''}`.toUpperCase();
                const userAvatarElement = document.getElementById('userAvatar');
                if (userAvatarElement) {
                    userAvatarElement.textContent = initials;
                }

                // Update dashboard avatar with photo or initials
                const dashboardUserAvatar = document.getElementById('dashboardUserAvatar');
                if (dashboardUserAvatar) {
                    if (member.profile_photo_url) {
                        dashboardUserAvatar.innerHTML = `<img src="${member.profile_photo_url}" alt="${fullName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        dashboardUserAvatar.textContent = initials;
                    }
                }

                // Update dashboard welcome message
                const dashboardUserName = document.getElementById('dashboardUserName');
                if (dashboardUserName) {
                    dashboardUserName.textContent = `Welcome back, ${firstName}!`;
                }

                // Update member since date
                const dashboardUserRole = document.getElementById('dashboardUserRole');
                if (dashboardUserRole && member.created_at) {
                    const memberSince = new Date(member.created_at).getFullYear();
                    dashboardUserRole.textContent = `Member since ${memberSince}`;
                }

                // Show/hide admin panel based on user (using database is_admin column)
                const isAdmin = member.is_admin || false;
                const adminNavItem = document.querySelector('[data-section="admin"]')?.parentElement;
                if (adminNavItem) {
                    adminNavItem.style.display = isAdmin ? 'block' : 'none';
                }

                // Load real dashboard statistics
                await loadRealDashboardStats(member);

                // Calculate onboarding progress
                await calculateOnboardingProgress(member);

                // Calculate profile analytics
                await calculateProfileAnalytics(member);

                // Load today's insights
                await loadTodaysInsights(member);

                return true;
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = '/member-login';
                return false;
            }
        }

        // Load real dashboard statistics from Supabase
        async function loadRealDashboardStats(member) {
            try {
                // console.log(' Loading real dashboard statistics...');

                // 1. Get total member count
                const { data: allMembers, error: membersError } = await supabase
                    .from('members')
                    .select('id', { count: 'exact' })
                    .eq('is_active', true);

                const totalMembers = allMembers?.length || 0;
                const totalMemberCountEl = document.getElementById('totalMemberCount');
                if (totalMemberCountEl) {
                    totalMemberCountEl.textContent = totalMembers;
                }

                // 2. Get user's connections
                const { data: connections, error: connectionsError } = await supabase
                    .from('member_connections')
                    .select('*')
                    .or(`requester_id.eq.${member.id},recipient_id.eq.${member.id}`)
                    .eq('status', 'accepted');

                const totalConnections = connections?.length || 0;
                const totalConnectionsEl = document.getElementById('totalConnections');
                if (totalConnectionsEl) {
                    totalConnectionsEl.textContent = totalConnections;
                }

                // 3. Get new connections this month
                const firstDayOfMonth = new Date();
                firstDayOfMonth.setDate(1);
                firstDayOfMonth.setHours(0, 0, 0, 0);

                const newConnectionsThisMonth = connections?.filter(conn => {
                    const connDate = new Date(conn.created_at);
                    return connDate >= firstDayOfMonth;
                }).length || 0;

                const newConnectionsCountEl = document.getElementById('newConnectionsCount');
                if (newConnectionsCountEl) {
                    newConnectionsCountEl.textContent = newConnectionsThisMonth;
                }

                const monthlyConnectionsEl = document.getElementById('monthlyConnections');
                if (monthlyConnectionsEl) {
                    monthlyConnectionsEl.textContent = newConnectionsThisMonth;
                }

                // 4. Calculate profile completion
                const profileFields = [
                    member.first_name,
                    member.last_name,
                    member.email,
                    member.company_name,
                    member.job_title,
                    member.industry,
                    member.phone,
                    member.linkedin_url,
                    member.profile_photo_url
                ];
                const filledFields = profileFields.filter(field => field && field !== 'To be completed').length;
                const profileCompletionPercent = Math.round((filledFields / profileFields.length) * 100);

                const profileCompletionEl = document.getElementById('profileCompletion');
                if (profileCompletionEl) {
                    profileCompletionEl.textContent = profileCompletionPercent;
                }

                // 6. Match statistics - calculate based on other members
                const otherMembers = allMembers?.filter(m => m.id !== member.id) || [];
                const totalMatchesEl = document.getElementById('totalMatches');
                if (totalMatchesEl) {
                    totalMatchesEl.textContent = Math.max(0, otherMembers.length);
                }

                const highPriorityMatchesEl = document.getElementById('highPriorityMatches');
                if (highPriorityMatchesEl) {
                    highPriorityMatchesEl.textContent = 0; // Will be calculated when matching algorithm is added
                }

                const newMatchesEl = document.getElementById('newMatches');
                if (newMatchesEl) {
                    newMatchesEl.textContent = 0; // Will be calculated when matching algorithm is added
                }

                const avgMatchScoreEl = document.getElementById('avgMatchScore');
                if (avgMatchScoreEl) {
                    avgMatchScoreEl.textContent = otherMembers.length > 0 ? '-' : 'N/A';
                }

                const mutualMatchesEl = document.getElementById('mutualMatches');
                if (mutualMatchesEl) {
                    mutualMatchesEl.textContent = 0; // Will be calculated when matching algorithm is added
                }

                // 7. Update welcome card stats
                const memberConnectionCountEl = document.getElementById('memberConnectionCount');
                if (memberConnectionCountEl) {
                    memberConnectionCountEl.textContent = totalConnections;
                }

                // 8. Get total message count from database
                const { data: userMessages, error: messagesError } = await supabase
                    .from('messages')
                    .select('id', { count: 'exact' })
                    .or(`sender_id.eq.${member.id},recipient_id.eq.${member.id}`);

                const totalMessages = userMessages?.length || 0;
                const memberMessageCountEl = document.getElementById('memberMessageCount');
                if (memberMessageCountEl) {
                    memberMessageCountEl.textContent = totalMessages;
                }

                // 9. Events attended from database
                const { data: eventRegistrations, error: eventsError } = await supabase
                    .from('event_registrations')
                    .select('id', { count: 'exact' })
                    .eq('member_id', member.id)
                    .eq('registration_status', 'registered');

                const eventsAttended = eventRegistrations?.length || 0;
                const memberEventCountEl = document.getElementById('memberEventCount');
                if (memberEventCountEl) {
                    memberEventCountEl.textContent = eventsAttended;
                }

                // Also update the eventsAttendedCount element if it exists
                const eventsAttendedCountEl = document.getElementById('eventsAttendedCount');
                if (eventsAttendedCountEl) {
                    eventsAttendedCountEl.textContent = eventsAttended;
                }

                // console.log(' Dashboard statistics loaded:', { totalMembers, totalConnections, newConnectionsThisMonth, profileCompletionPercent });

            } catch (error) {
                console.error(' Error loading dashboard statistics:', error);
            }
        }

        // Calculate and display onboarding progress
        async function calculateOnboardingProgress(member) {
            try {
                const checklist = {
                    profileComplete: false,
                    photoUploaded: false,
                    logoUploaded: false,
                    firstConnection: false,
                    industriesAdded: false
                };

                // 1. Check if profile is complete (all required fields filled)
                const requiredFields = [
                    member.first_name,
                    member.last_name,
                    member.company_name,
                    member.job_title,
                    member.phone,
                    member.linkedin_url
                ];
                checklist.profileComplete = requiredFields.every(field => field && field.trim() !== '' && field !== 'To be completed');

                // 2. Check if profile photo is uploaded
                checklist.photoUploaded = !!(member.profile_photo_url && member.profile_photo_url.trim() !== '');

                // 3. Check if company logo is uploaded
                checklist.logoUploaded = !!(member.company_logo_url && member.company_logo_url.trim() !== '');

                // 4. Check if member has made first connection
                const { data: connections } = await supabase
                    .from('member_connections')
                    .select('id')
                    .or(`requester_id.eq.${member.id},recipient_id.eq.${member.id}`)
                    .eq('status', 'accepted')
                    .limit(1);
                checklist.firstConnection = connections && connections.length > 0;

                // 5. Check if industries are added
                checklist.industriesAdded = !!(member.industries && Array.isArray(member.industries) && member.industries.length > 0);

                // Calculate progress percentage
                const completedCount = Object.values(checklist).filter(val => val === true).length;
                const totalCount = Object.keys(checklist).length;
                const progressPercent = Math.round((completedCount / totalCount) * 100);

                // Update UI
                document.getElementById('onboardingProgressText').textContent = `${progressPercent}% Complete`;
                document.getElementById('onboardingProgressBar').style.width = `${progressPercent}%`;

                // Update checklist items
                const checklistItems = [
                    { id: 'checklistItem1', completed: checklist.profileComplete },
                    { id: 'checklistItem2', completed: checklist.photoUploaded },
                    { id: 'checklistItem3', completed: checklist.logoUploaded },
                    { id: 'checklistItem4', completed: checklist.firstConnection },
                    { id: 'checklistItem5', completed: checklist.industriesAdded }
                ];

                checklistItems.forEach(item => {
                    const element = document.getElementById(item.id);
                    if (element) {
                        const iconElement = element.querySelector('.checklist-icon');
                        if (item.completed) {
                            iconElement.textContent = '';
                            element.style.opacity = '0.6';
                            element.style.borderLeft = '3px solid #51cf66';
                        } else {
                            iconElement.textContent = '';
                            element.style.opacity = '1';
                            element.style.borderLeft = '3px solid transparent';
                        }
                    }
                });

                // Show/hide completion message and entire checklist
                const checklistCard = document.getElementById('onboardingChecklist');
                if (progressPercent === 100) {
                    // Hide the entire checklist when 100% complete
                    if (checklistCard) {
                        checklistCard.style.display = 'none';
                    }

                    // Update database: mark onboarding as completed
                    await supabase
                        .from('members')
                        .update({ onboarding_completed: true })
                        .eq('id', member.id);
                } else {
                    // Show checklist if not complete
                    if (checklistCard) {
                        checklistCard.style.display = 'block';
                    }
                    document.getElementById('completeProfilePrompt').style.display = 'block';
                    document.getElementById('onboardingCompleteMessage').style.display = 'none';
                }

                // console.log(' Onboarding progress calculated:', { progressPercent, checklist });

            } catch (error) {
                console.error(' Error calculating onboarding progress:', error);
            }
        }

        // Calculate and display profile analytics
        async function calculateProfileAnalytics(member) {
            try {
                // console.log(' Calculating profile analytics...');

                // 1. Profile Views - use the profile_views column
                const profileViews = member.profile_views || 0;
                document.getElementById('analyticsProfileViews').textContent = profileViews;
                document.getElementById('analyticsViewsTrend').textContent = profileViews > 0 ? `+${profileViews} views` : 'No views yet';

                // 2. Connection Rate (accepted / total sent)
                const { data: sentRequests } = await supabase
                    .from('member_connections')
                    .select('status')
                    .eq('requester_id', member.id);

                const totalSent = sentRequests?.length || 0;
                const totalAccepted = sentRequests?.filter(r => r.status === 'accepted').length || 0;
                const connectionRate = totalSent > 0 ? Math.round((totalAccepted / totalSent) * 100) : 0;

                document.getElementById('analyticsConnectionRate').textContent = `${connectionRate}%`;
                document.getElementById('analyticsConnectionStats').textContent = `${totalAccepted} accepted / ${totalSent} sent`;

                // 3. Total Active Connections
                const { data: allConnections } = await supabase
                    .from('member_connections')
                    .select('id')
                    .or(`requester_id.eq.${member.id},recipient_id.eq.${member.id}`)
                    .eq('status', 'accepted');

                const totalConnections = allConnections?.length || 0;
                document.getElementById('analyticsTotalConnections').textContent = totalConnections;
                document.getElementById('analyticsConnectionsGrowth').textContent = totalConnections > 0 ? `${totalConnections} active` : 'No connections yet';

                // 4. Messages Sent (from localStorage chat history)
                const chatHistory = JSON.parse(localStorage.getItem('memberChats') || '{}');
                let messagesSentCount = 0;
                Object.keys(chatHistory).forEach(chatId => {
                    if (chatHistory[chatId]) {
                        const messages = chatHistory[chatId].filter(msg => msg.sender === member.email);
                        messagesSentCount += messages.length;
                    }
                });
                document.getElementById('analyticsMessagesSent').textContent = messagesSentCount;

                // 5. Profile Strength Breakdown
                const strengthChecks = {
                    basicInfo: !!(member.first_name && member.last_name && member.company_name && member.job_title && member.phone),
                    photo: !!(member.profile_photo_url && member.profile_photo_url.trim() !== ''),
                    logo: !!(member.company_logo_url && member.company_logo_url.trim() !== ''),
                    industries: !!(member.industries && Array.isArray(member.industries) && member.industries.length > 0),
                    linkedin: !!(member.linkedin_url && member.linkedin_url.trim() !== '')
                };

                // Update each strength bar
                document.getElementById('strengthBasicInfo').style.width = strengthChecks.basicInfo ? '100%' : '0%';
                document.getElementById('strengthBasicInfoPercent').textContent = strengthChecks.basicInfo ? '100%' : '0%';
                document.getElementById('strengthBasicInfoPercent').style.color = strengthChecks.basicInfo ? '#51cf66' : '#999';

                document.getElementById('strengthPhoto').style.width = strengthChecks.photo ? '100%' : '0%';
                document.getElementById('strengthPhotoPercent').textContent = strengthChecks.photo ? '100%' : '0%';
                document.getElementById('strengthPhotoPercent').style.color = strengthChecks.photo ? '#51cf66' : '#999';

                document.getElementById('strengthLogo').style.width = strengthChecks.logo ? '100%' : '0%';
                document.getElementById('strengthLogoPercent').textContent = strengthChecks.logo ? '100%' : '0%';
                document.getElementById('strengthLogoPercent').style.color = strengthChecks.logo ? '#51cf66' : '#999';

                document.getElementById('strengthIndustries').style.width = strengthChecks.industries ? '100%' : '0%';
                document.getElementById('strengthIndustriesPercent').textContent = strengthChecks.industries ? '100%' : '0%';
                document.getElementById('strengthIndustriesPercent').style.color = strengthChecks.industries ? '#51cf66' : '#999';

                document.getElementById('strengthLinkedIn').style.width = strengthChecks.linkedin ? '100%' : '0%';
                document.getElementById('strengthLinkedInPercent').textContent = strengthChecks.linkedin ? '100%' : '0%';
                document.getElementById('strengthLinkedInPercent').style.color = strengthChecks.linkedin ? '#51cf66' : '#999';

                // 6. Activity Timeline
                // Last profile update
                if (member.updated_at) {
                    const lastUpdate = new Date(member.updated_at);
                    const daysSinceUpdate = Math.floor((Date.now() - lastUpdate.getTime()) / (1000 * 60 * 60 * 24));
                    if (daysSinceUpdate === 0) {
                        document.getElementById('activityLastUpdate').textContent = 'Today';
                    } else if (daysSinceUpdate === 1) {
                        document.getElementById('activityLastUpdate').textContent = 'Yesterday';
                    } else {
                        document.getElementById('activityLastUpdate').textContent = `${daysSinceUpdate} days ago`;
                    }
                } else {
                    document.getElementById('activityLastUpdate').textContent = 'Never';
                }

                // Last connection made
                if (allConnections && allConnections.length > 0) {
                    const { data: latestConnection } = await supabase
                        .from('member_connections')
                        .select('created_at')
                        .or(`requester_id.eq.${member.id},recipient_id.eq.${member.id}`)
                        .eq('status', 'accepted')
                        .order('created_at', { ascending: false })
                        .limit(1)
                        .single();

                    if (latestConnection) {
                        const lastConnectionDate = new Date(latestConnection.created_at);
                        const daysSinceConnection = Math.floor((Date.now() - lastConnectionDate.getTime()) / (1000 * 60 * 60 * 24));
                        if (daysSinceConnection === 0) {
                            document.getElementById('activityLastConnection').textContent = 'Today';
                        } else if (daysSinceConnection === 1) {
                            document.getElementById('activityLastConnection').textContent = 'Yesterday';
                        } else {
                            document.getElementById('activityLastConnection').textContent = `${daysSinceConnection} days ago`;
                        }
                    }
                } else {
                    document.getElementById('activityLastConnection').textContent = 'No connections yet';
                }

                // Member since
                if (member.created_at) {
                    const memberSince = new Date(member.created_at);
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    document.getElementById('activityMemberSince').textContent = `${monthNames[memberSince.getMonth()]} ${memberSince.getFullYear()}`;
                } else {
                    document.getElementById('activityMemberSince').textContent = '';
                }

                // console.log(' Profile analytics calculated:', { profileViews, connectionRate, totalConnections, messagesSentCount, strengthChecks });

            } catch (error) {
                console.error(' Error calculating profile analytics:', error);
            }
        }

        // Load Today's Insights with real data
        async function loadTodaysInsights(member) {
            try {
                const insightsList = document.getElementById('insightsList');
                if (!insightsList) return;

                let insightsHtml = '';

                // 1. Calculate potential matches (members with similar business opportunities)
                const { data: allMembers } = await supabase
                    .from('members')
                    .select('id, business_opportunities')
                    .eq('is_active', true)
                    .neq('id', member.id);

                const myInterests = member.business_opportunities?.map(opp => opp.category.toLowerCase()) || [];
                const potentialMatches = allMembers?.filter(m => {
                    const theirInterests = m.business_opportunities?.map(opp => opp.category.toLowerCase()) || [];
                    return myInterests.some(interest => theirInterests.includes(interest));
                }).length || 0;

                if (potentialMatches > 0) {
                    insightsHtml += `
                        <div class="insight-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 3px solid #C9A86A;">
                            <span style="font-size: 1.2rem;"></span>
                            <span style="color: #e8eaed;">You have <strong style="color: #C9A86A;">${potentialMatches} potential ${potentialMatches === 1 ? 'match' : 'matches'}</strong> based on your profile</span>
                        </div>
                    `;
                }

                // 2. Profile views (from member.profile_views if tracked)
                const profileViews = member.profile_views || 0;
                if (profileViews > 0) {
                    insightsHtml += `
                        <div class="insight-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 3px solid #51cf66;">
                            <span style="font-size: 1.2rem;"></span>
                            <span style="color: #e8eaed;"><strong style="color: #51cf66;">${profileViews} ${profileViews === 1 ? 'member' : 'members'}</strong> viewed your profile this week</span>
                        </div>
                    `;
                }

                // 3. Next upcoming event
                const { data: upcomingEvents } = await supabase
                    .from('events')
                    .select('event_name, event_date')
                    .gte('event_date', new Date().toISOString())
                    .order('event_date', { ascending: true })
                    .limit(1);

                if (upcomingEvents && upcomingEvents.length > 0) {
                    const event = upcomingEvents[0];
                    const eventDate = new Date(event.event_date);
                    const daysUntil = Math.ceil((eventDate - new Date()) / (1000 * 60 * 60 * 24));

                    insightsHtml += `
                        <div class="insight-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 3px solid #fab005;">
                            <span style="font-size: 1.2rem;"></span>
                            <span style="color: #e8eaed;">${event.event_name} is in <strong style="color: #fab005;">${daysUntil} ${daysUntil === 1 ? 'day' : 'days'}</strong> - Register now!</span>
                        </div>
                    `;
                }

                // 4. New connection requests
                const { data: pendingRequests } = await supabase
                    .from('member_connections')
                    .select('id', { count: 'exact' })
                    .eq('recipient_id', member.id)
                    .eq('status', 'pending');

                const requestCount = pendingRequests?.length || 0;
                if (requestCount > 0) {
                    insightsHtml += `
                        <div class="insight-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 3px solid #C9A86A; cursor: pointer;" onclick="showSection('connections')">
                            <span style="font-size: 1.2rem;"></span>
                            <span style="color: #e8eaed;">You have <strong style="color: #C9A86A;">${requestCount} new connection ${requestCount === 1 ? 'request' : 'requests'}</strong></span>
                        </div>
                    `;
                }

                // If no insights, show friendly message
                if (!insightsHtml) {
                    insightsHtml = `
                        <div style="text-align: center; padding: 2rem; color: #999;">
                            <p>Complete your profile to get personalized insights!</p>
                        </div>
                    `;
                }

                insightsList.innerHTML = insightsHtml;

            } catch (error) {
                console.error('Error loading insights:', error);
                const insightsList = document.getElementById('insightsList');
                if (insightsList) {
                    insightsList.innerHTML = '<div style="text-align: center; padding: 1rem; color: #999;">Unable to load insights</div>';
                }
            }
        }

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await supabase.auth.signOut();
                    currentMember = null;
                    window.location.href = '/member-login';
                } catch (error) {
                    console.error('Logout error:', error);
                    // Force logout even if API call fails
                    window.location.href = '/member-login';
                }
            }
        }

        // Helper function to get current member data (backwards compatibility)
        function getMemberAuth() {
            if (currentMember) {
                return {
                    email: currentMember.email,
                    name: `${currentMember.first_name} ${currentMember.last_name}`,
                    loginTime: new Date().toISOString()
                };
            }
            return null;
        }

        // Handle magic link callback and authentication
        window.addEventListener('load', async () => {
            // Check if this is a magic link callback (has token in URL)
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const searchParams = new URLSearchParams(window.location.search);

            const hasAuthToken = hashParams.has('access_token') ||
                                searchParams.has('token') ||
                                searchParams.has('code');

            if (hasAuthToken) {
                // console.log(' Magic link callback detected, processing authentication...');

                // Give Supabase MUCH MORE time to process the auth callback (was 3s, now 6s)
                // console.log(' Waiting 6 seconds for Supabase to establish session...');
                await new Promise(resolve => setTimeout(resolve, 6000));

                // Clear URL parameters after processing
                // console.log(' Auth processing complete, clearing URL params...');
                window.history.replaceState({}, document.title, '/portal');
            }

            // Now check authentication
            // console.log(' Checking authentication status...');
            const authenticated = await checkAuthentication();
            if (authenticated) {
                // Clear ONLY old message data, NOT Supabase auth session
                // console.log(' Clearing old message data (preserving auth session)...');
                const keysToRemove = ['chatHistory', 'memberChats', 'conversations', 'messages'];
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                // DO NOT clear all localStorage - that kills Supabase session!

                setupPhotoUpload();
                initializeChatSystem();
                updateMemberAvatars();
                await loadMemberProfile();

                // Initialize dashboard personalization after profile loads
                setTimeout(() => initializeDashboardPersonalization(), 800);
            }
        });

        // Show section function for quick actions
        function showSection(sectionId) {
            // Remove active class from all links and sections
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

            // Add active class to corresponding nav link
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');

            // Show corresponding section
            document.getElementById(sectionId).classList.add('active');

            // Load conversations when navigating to messages
            if (sectionId === 'messages') {
                setTimeout(() => loadConversations(), 100);
            }

            // Load weekly alerts preference when navigating to smart matches
            if (sectionId === 'smart-matches') {
                setTimeout(() => loadWeeklyAlertsPreference(), 100);
            }

            // Remove floating input box when leaving messages section
            if (sectionId !== 'messages') {
                const floatingInput = document.getElementById('floatingChatInput');
                if (floatingInput) floatingInput.remove();
            }
        }

        // Navigation functionality
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                // Get section ID first for debugging
                const sectionId = this.getAttribute('data-section');
                // console.log(' Navigation clicked:', sectionId);

                // Remove active class from all links and sections
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

                // Add active class to clicked link
                this.classList.add('active');

                // Show corresponding section
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.add('active');
                    // console.log(' Section activated:', sectionId);

                    // Scroll to top of section
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    console.error(' Section not found:', sectionId);
                }

                // Load photos when navigating to directory
                if (sectionId === 'directory') {
                    setTimeout(() => loadAllMemberPhotos(), 100);
                }

                // Load profile data when navigating to profile
                if (sectionId === 'profile') {
                    // console.log(' Loading profile section...');
                    setTimeout(() => loadMemberProfile(), 100);
                }

                // Load conversations when navigating to messages
                if (sectionId === 'messages') {
                    // console.log(' Loading messages section...');
                    setTimeout(() => loadConversations(), 100);
                }

                // Load connections data when navigating to connections
                if (sectionId === 'connections') {
                    // console.log(' Loading connections section...');
                    setTimeout(() => loadConnections(), 100);
                }

                // Load weekly alerts preference when navigating to smart matches
                if (sectionId === 'smart-matches') {
                    setTimeout(() => loadWeeklyAlertsPreference(), 100);
                }
            });
        });

        // Search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const memberCards = document.querySelectorAll('.member-card');
                    
                    memberCards.forEach(card => {
                        const text = card.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }
        });

        // Register button functionality
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.register-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (this.textContent.trim() === 'Register Now') {
                        window.open('https://luma.com/au2tl4nm', '_blank');
                    } else if (this.textContent.trim() === 'Edit Profile') {
                        alert('Profile editing feature coming soon!');
                    } else if (this.textContent.trim() === 'Coming Soon') {
                        alert('Event registration will open soon!');
                    }
                });
            });
        });

        // Member connection functionality
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.linkedin-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    if (this.href.includes('mailto:')) {
                        // Show connection confirmation for email connections
                        const memberName = this.href.split('Connect with ')[1]?.split('"')[0];
                        if (memberName && !confirm(`Send connection request to ${memberName}?`)) {
                            e.preventDefault();
                        }
                    }
                });
            });
        });

        // Dashboard stats animation
        document.addEventListener('DOMContentLoaded', function() {
            // Animate numbers on dashboard load
            setTimeout(() => {
                const statsElements = document.querySelectorAll('.dashboard-card p strong');
                statsElements.forEach(el => {
                    if (el.nextSibling && el.nextSibling.textContent.match(/\d+/)) {
                        el.parentElement.style.animation = 'fadeIn 0.5s ease-in';
                    }
                });
            }, 500);
        });

        // Smart Matching System - Global variable to store current matches
        let lastGeneratedMatches = [];

        async function generateSmartMatches() {
            const matchResults = document.getElementById('smartMatchResults');

            // Enhanced loading with skeleton screens
            const loadingHtml = `
                <div class="skeleton-card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div class="skeleton skeleton-avatar"></div>
                        <div style="flex: 1;">
                            <div class="skeleton skeleton-text skeleton-text-title"></div>
                            <div class="skeleton skeleton-text" style="width: 60%;"></div>
                        </div>
                        <div class="skeleton skeleton-text" style="width: 80px; height: 30px;"></div>
                    </div>
                    <div class="skeleton skeleton-text skeleton-text-body"></div>
                    <div class="skeleton skeleton-text skeleton-text-body"></div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <div class="skeleton skeleton-button"></div>
                        <div class="skeleton skeleton-button"></div>
                    </div>
                </div>
                <div class="skeleton-card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div class="skeleton skeleton-avatar"></div>
                        <div style="flex: 1;">
                            <div class="skeleton skeleton-text skeleton-text-title"></div>
                            <div class="skeleton skeleton-text" style="width: 50%;"></div>
                        </div>
                        <div class="skeleton skeleton-text" style="width: 80px; height: 30px;"></div>
                    </div>
                    <div class="skeleton skeleton-text skeleton-text-body"></div>
                    <div class="skeleton skeleton-text skeleton-text-body"></div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <div class="skeleton skeleton-button"></div>
                        <div class="skeleton skeleton-button"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 2rem; color: #C9A86A;">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 1rem; font-weight: 500;"> Analyzing member profiles and generating smart matches...</div>
                </div>
            `;

            matchResults.innerHTML = loadingHtml;

            try {
                // Load real members from database
                const allMembers = await loadMembersFromDatabase();

                // Filter out current user
                const otherMembers = allMembers.filter(m => currentMember && m.id !== currentMember.id);

                // Calculate smart matches with real data
                const smartMatches = calculateIntelligentMatches(otherMembers);
                lastGeneratedMatches = smartMatches; // Store matches globally for profile viewing
                displaySmartMatches(smartMatches);
                updateMatchStats(smartMatches);
            } catch (error) {
                console.error('Error generating smart matches:', error);
                matchResults.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #ff6b6b;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                        <h3 style="color: #e8eaed; margin-bottom: 0.5rem;">Unable to load matches</h3>
                        <p style="color: #999;">Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        function calculateIntelligentMatches(membersFromDatabase) {
            // Transform database members into matching format
            const membersWithProfiles = membersFromDatabase.map(member => {
                // Get what they're looking for
                const lookingFor = member.lookingFor || [];
                // Get what they can offer
                const canOffer = member.canOffer || [];

                // Extract initials for avatar
                const initials = (member.first_name && member.last_name)
                    ? `${member.first_name[0]}${member.last_name[0]}`.toUpperCase()
                    : 'MB';

                return {
                    id: member.id,
                    name: `${member.first_name || ''} ${member.last_name || ''}`.trim() || 'Member',
                    company: member.company_name || 'Company',
                    industry: member.industry || member.industries?.[0] || 'Business',
                    avatar: initials,
                    avatarUrl: member.profile_photo_url,
                    services: canOffer, // What they can offer
                    idealClient: {
                        industries: member.industries || [],
                        companySize: ['small', 'medium', 'large'],
                        budget: [],
                        needsHelp: lookingFor // What they're looking for
                    },
                    businessGoals: [],
                    location: 'miami',
                    workStyle: 'hybrid',
                    linkedin: member.linkedin_url,
                    valueProposition: member.bio || `Connect with ${member.first_name} for business opportunities`,
                    primaryOffering: canOffer.join(', ') || 'Professional services'
                };
            });

            // Current user profile from logged in member
            const currentUser = currentMember ? {
                industry: currentMember.industry || currentMember.industries?.[0] || 'Business',
                services: currentMember.canOffer || [],
                idealClient: {
                    industries: currentMember.industries || [],
                    companySize: ['small', 'medium'],
                    budget: [],
                    needsHelp: currentMember.lookingFor || []
                },
                businessGoals: []
            } : {
                // Fallback if no current member
                industry: 'Business',
                services: [],
                idealClient: { industries: [], companySize: [], budget: [], needsHelp: [] },
                businessGoals: []
            };

            // Calculate match scores using intelligent algorithm
            const matches = membersWithProfiles.map(member => {
                let score = 0;
                let matchReasons = [];
                let matchType = '';

                // Industry alignment (30% weight)
                if (currentUser.idealClient.industries.includes(member.industry)) {
                    score += 30;
                    matchReasons.push(`Perfect industry match: ${member.industry}`);
                    matchType = 'ideal-client';
                }

                if (member.idealClient.industries.includes(currentUser.industry)) {
                    score += 25;
                    matchReasons.push(`They're looking for your industry: ${currentUser.industry}`);
                    if (!matchType) matchType = 'service-provider';
                    else if (matchType === 'ideal-client') matchType = 'mutual';
                }

                // Services/needs alignment (25% weight)
                const serviceMatches = currentUser.services.some(service => 
                    member.idealClient.needsHelp?.some(need => 
                        need.toLowerCase().includes(service.toLowerCase()) ||
                        service.toLowerCase().includes(need.toLowerCase())
                    )
                );

                if (serviceMatches) {
                    score += 25;
                    matchReasons.push('Your services match their needs');
                }

                // Business goals alignment (20% weight)
                const goalAlignment = currentUser.businessGoals.some(goal => 
                    member.businessGoals.includes(goal)
                );

                if (goalAlignment) {
                    score += 20;
                    matchReasons.push('Aligned business goals');
                    if (!matchType) matchType = 'partnership';
                }

                // Budget/size compatibility (15% weight)
                const budgetMatch = currentUser.idealClient.budget.some(budget => 
                    member.idealClient.budget.includes(budget)
                );

                if (budgetMatch) {
                    score += 15;
                    matchReasons.push('Compatible budget ranges');
                }

                // Location proximity (10% weight)
                if (member.location === 'miami' || member.location === 'south-florida') {
                    score += 10;
                    matchReasons.push('Local Miami area');
                }

                return {
                    ...member,
                    matchScore: Math.min(score, 98), // Cap at 98%
                    matchReasons: matchReasons.slice(0, 3), // Top 3 reasons
                    matchType: matchType || 'networking',
                    priority: score > 80 ? 'high' : score > 60 ? 'medium' : 'low',
                    mutualBenefit: matchType === 'mutual'
                };
            }).filter(match => match.matchScore > 40) // Only show matches above 40%
              .sort((a, b) => b.matchScore - a.matchScore);

            return matches;
        }

        function displaySmartMatches(matches) {
            const matchResults = document.getElementById('smartMatchResults');

            if (matches.length === 0) {
                matchResults.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ccc;">No strong matches found. Try updating your profile to get better results.</div>';
                return;
            }

            const matchesHtml = matches.map(match => {
                // Determine match score class
                const scoreClass = match.matchScore >= 90 ? 'excellent' :
                                 match.matchScore >= 75 ? 'good' : 'fair';

                // Determine if high priority
                const priorityClass = match.matchScore >= 90 ? 'high-priority' : '';

                // Get icon for each match reason
                const reasonBadges = match.matchReasons.map(reason => {
                    let icon = '';
                    if (reason.toLowerCase().includes('industry')) icon = '';
                    else if (reason.toLowerCase().includes('service') || reason.toLowerCase().includes('offer')) icon = '';
                    else if (reason.toLowerCase().includes('need')) icon = '';
                    else if (reason.toLowerCase().includes('goal')) icon = '';
                    else if (reason.toLowerCase().includes('miami') || reason.toLowerCase().includes('local')) icon = '';
                    else if (reason.toLowerCase().includes('budget')) icon = '';

                    return `<span class="match-reason-badge" title="${reason}">
                        <span class="match-reason-icon">${icon}</span>
                        ${reason}
                    </span>`;
                }).join('');

                return `
                <div class="match-card ${priorityClass}" data-match-type="${match.matchType}" data-industry="${match.industry}" data-score="${match.matchScore}">
                    <div class="match-header">
                        <div class="member-avatar">${match.avatar}</div>
                        <div style="flex: 1;">
                            <h4>${match.name}</h4>
                            <p>${match.company}  ${match.industry}</p>
                        </div>
                        <div style="text-align: right;">
                            <div class="match-score ${scoreClass}">${match.matchScore}%</div>
                            <div class="match-type-label">${getMatchTypeLabel(match.matchType)}</div>
                            ${match.mutualBenefit ? '<div style="font-size: 0.7em; color: #51cf66; margin-top: 0.25rem; font-weight: 600;"> MUTUAL BENEFIT</div>' : ''}
                        </div>
                    </div>

                    <div class="match-reasons">
                        ${reasonBadges}
                    </div>

                    <div class="match-details">
                        <p><strong> What they offer:</strong> ${match.services.join(', ')}</p>
                        <p><strong> What they need:</strong> ${match.idealClient.needsHelp?.join(', ') || 'Various business support'}</p>
                        ${match.valueProposition ? `<p><strong> Their value:</strong> ${match.valueProposition}</p>` : ''}
                    </div>
                    <div class="match-actions">
                        <button class="connect-btn" onclick="sendSmartIntro('${match.id}', '${match.name}')">
                             Smart Intro
                        </button>
                        <button class="linkedin-btn" onclick="${match.linkedin ? `window.open('${match.linkedin}', '_blank')` : `openSmartMatchProfile('${match.id}')`}">
                            ${match.linkedin ? ' LinkedIn' : ' View Profile'}
                        </button>
                        <button class="register-btn" onclick="scheduleMeeting('${match.id}')" style="padding: 0.5rem 1rem; margin-left: 0.5rem;">
                             Schedule Meet
                        </button>
                    </div>
                </div>
            `;
            }).join('');

            matchResults.innerHTML = matchesHtml;
        }

        function getMatchTypeLabel(matchType) {
            const labels = {
                'ideal-client': ' IDEAL CLIENT',
                'service-provider': ' SERVICE FOR YOU',
                'mutual': ' MUTUAL BENEFIT',
                'partnership': ' PARTNERSHIP',
                'networking': ' NETWORKING'
            };
            return labels[matchType] || ' NETWORKING';
        }

        function updateMatchStats(matches) {
            document.getElementById('totalMatches').textContent = matches.length;
            document.getElementById('highPriorityMatches').textContent = matches.filter(m => m.priority === 'high').length;
            document.getElementById('newMatches').textContent = Math.floor(matches.length * 0.3); // Simulate new matches
        }

        function filterMatches() {
            const matchType = document.getElementById('matchTypeFilter').value;
            const industry = document.getElementById('industryFilter').value;
            const scoreRange = document.getElementById('scoreFilter').value;
            const availability = document.getElementById('availabilityFilter').value;

            const allCards = document.querySelectorAll('.match-card');
            let visibleCount = 0;

            allCards.forEach(card => {
                let show = true;

                // Filter by match type
                if (matchType !== 'all' && !card.dataset.matchType.includes(matchType)) {
                    show = false;
                }

                // Filter by industry
                if (industry !== 'all' && !card.dataset.industry.includes(industry)) {
                    show = false;
                }

                // Filter by score
                if (scoreRange !== 'all') {
                    const score = parseInt(card.dataset.score);
                    if (scoreRange === 'high' && score < 90) show = false;
                    if (scoreRange === 'good' && (score < 75 || score >= 90)) show = false;
                    if (scoreRange === 'fair' && (score < 60 || score >= 75)) show = false;
                }

                card.style.display = show ? 'block' : 'none';
                if (show) visibleCount++;
            });

            // Update visible count
            const matchResults = document.getElementById('smartMatchResults');
            if (visibleCount === 0) {
                matchResults.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ccc;">No matches found for current filters. Try adjusting your criteria.</div>';
            }
        }

        function sendSmartIntro(memberId, memberName) {
            // AI-generated introduction message
            const introMessage = `Hi ${memberName}! I came across your profile through Miami Business Council's smart matching system. Based on our business profiles, it looks like we might have some interesting synergies to explore. Would you be open to a brief call to discuss potential collaboration opportunities?`;
            
            if (confirm(`Send this smart introduction to ${memberName}?\n\n"${introMessage}"`)) {
                alert(`Smart introduction sent to ${memberName}! They'll receive a personalized message highlighting why you're a great match.`);
                // In real implementation, this would send via the chat system or email
            }
        }

        function scheduleMeeting(memberId) {
            alert('Meeting scheduling feature coming soon! For now, use the Smart Intro to connect and suggest a meeting time.');
        }

        function viewMemberProfile(memberId) {
            alert(`Detailed member profile viewer coming soon! This would show ${memberId}'s complete business profile and portfolio.`);
        }

        function openSmartMatchProfile(matchId) {
            // Find the match data from the smart matches array
            const match = lastGeneratedMatches.find(m => m.id === matchId);
            if (!match) {
                alert('Member profile not found. Please refresh the matches and try again.');
                return;
            }

            // Convert smart match data to the format expected by openMemberProfile
            const memberName = match.name;
            const memberTitle = match.services?.[0] || 'Business Professional';
            const memberCompany = match.company;
            const memberAvatar = match.avatar;
            const memberTags = match.services || [];
            const memberEmail = `${match.id}@member.com`; // Placeholder email
            const memberLinkedIn = match.linkedin || '';
            const memberPhoto = match.avatarUrl || null;
            const memberLookingFor = match.idealClient?.needsHelp || [];
            const memberCanOffer = match.services || [];

            // Call the existing openMemberProfile function with proper parameters
            openMemberProfile(
                matchId,
                memberName,
                memberTitle,
                memberCompany,
                memberAvatar,
                memberTags,
                memberEmail,
                memberLinkedIn,
                memberPhoto,
                memberLookingFor,
                memberCanOffer
            );
        }


        async function toggleWeeklyAlerts(enabled) {
            if (!currentMember) {
                alert('Please log in to enable weekly alerts');
                return;
            }

            try {
                // Get current authenticated user
                const { data: { user } } = await supabase.auth.getUser();

                if (!user) {
                    alert('Please log in to enable weekly alerts');
                    document.getElementById('weeklyAlertsToggle').checked = !enabled;
                    return;
                }

                // Update database using auth_user_id for RLS policy
                const { error } = await supabase
                    .from('members')
                    .update({ weekly_alerts_enabled: enabled })
                    .eq('auth_user_id', user.id);

                if (error) {
                    console.error('Error updating weekly alerts:', error);
                    alert('Failed to update alert settings. Please try again.');
                    // Revert toggle
                    document.getElementById('weeklyAlertsToggle').checked = !enabled;
                    return;
                }

                // Update local member object
                currentMember.weekly_alerts_enabled = enabled;

                // Show confirmation
                if (enabled) {
                    alert(' Weekly Alerts Enabled!\n\nYou\'ll receive 3-5 curated matches every Sunday at 7pm.');
                } else {
                    alert(' Weekly Alerts Disabled\n\nYou won\'t receive automatic match emails.');
                }

            } catch (error) {
                console.error('Error toggling weekly alerts:', error);
                alert('An error occurred. Please try again.');
                document.getElementById('weeklyAlertsToggle').checked = !enabled;
            }
        }

        // Load weekly alerts preference when page loads
        function loadWeeklyAlertsPreference() {
            if (currentMember && currentMember.weekly_alerts_enabled !== undefined) {
                const toggle = document.getElementById('weeklyAlertsToggle');
                if (toggle) {
                    toggle.checked = currentMember.weekly_alerts_enabled || false;
                }
            }
        }

        // Initialize smart matches when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-generate smart matches for demo
            setTimeout(() => {
                if (document.getElementById('smartMatchResults')) {
                    generateSmartMatches();
                }
            }, 1000);
        });

        // Business matching functionality
        function toggleTag(tag) {
            tag.classList.toggle('active');
            // Auto-update matches when preferences change
            setTimeout(findMatches, 500);
        }

        async function findMatches() {
            const matchResults = document.getElementById('matchResults');
            const loadingHtml = '<div style="text-align: center; padding: 2rem; color: #ccc;"> Finding new business matches...</div>';

            matchResults.innerHTML = loadingHtml;

            try {
                // Load real members from database
                const allMembers = await loadMembersFromDatabase();

                // Filter out current user
                const otherMembers = allMembers.filter(m => currentMember && m.id !== currentMember.id);

                // Calculate smart matches with real data
                const smartMatches = calculateIntelligentMatches(otherMembers);

                // Display using the same smart matches display function
                displayMatchesInGrid(smartMatches, 'matchResults');
            } catch (error) {
                console.error('Error finding matches:', error);
                matchResults.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #ff6b6b; grid-column: 1 / -1;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                        <h3 style="color: #e8eaed; margin-bottom: 0.5rem;">Unable to load matches</h3>
                        <p style="color: #999;">Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        function displayMatchesInGrid(matches, targetElementId) {
            const matchResults = document.getElementById(targetElementId);

            if (matches.length === 0) {
                matchResults.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #999; grid-column: 1 / -1;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <h4 style="color: #e8eaed; margin-bottom: 0.5rem;">No matches found</h4>
                        <p>Try updating your business information to find better matches.</p>
                    </div>
                `;
                return;
            }

            const matchesHtml = matches.map(match => {
                // Determine match score class
                const scoreClass = match.matchScore >= 90 ? 'excellent' :
                                 match.matchScore >= 75 ? 'good' : 'fair';

                // Determine if high priority
                const priorityClass = match.matchScore >= 90 ? 'high-priority' : '';

                // Get icon for each match reason
                const reasonBadges = match.matchReasons.map(reason => {
                    let icon = '';
                    if (reason.toLowerCase().includes('industry')) icon = '';
                    else if (reason.toLowerCase().includes('service') || reason.toLowerCase().includes('offer')) icon = '';
                    else if (reason.toLowerCase().includes('need')) icon = '';
                    else if (reason.toLowerCase().includes('goal')) icon = '';
                    else if (reason.toLowerCase().includes('miami') || reason.toLowerCase().includes('local')) icon = '';
                    else if (reason.toLowerCase().includes('budget')) icon = '';

                    return `<span class="match-reason-badge" title="${reason}">
                        <span class="match-reason-icon">${icon}</span>
                        ${reason}
                    </span>`;
                }).join('');

                return `
                <div class="match-card ${priorityClass}" data-match-type="${match.matchType}" data-industry="${match.industry}" data-score="${match.matchScore}">
                    <div class="match-header">
                        <div class="member-avatar">${match.avatar}</div>
                        <div style="flex: 1;">
                            <h4>${match.name}</h4>
                            <p>${match.company}  ${match.industry}</p>
                        </div>
                        <div style="text-align: right;">
                            <div class="match-score ${scoreClass}">${match.matchScore}%</div>
                            <div class="match-type-label">${getMatchTypeLabel(match.matchType)}</div>
                            ${match.mutualBenefit ? '<div style="font-size: 0.7em; color: #51cf66; margin-top: 0.25rem; font-weight: 600;"> MUTUAL BENEFIT</div>' : ''}
                        </div>
                    </div>

                    <div class="match-reasons">
                        ${reasonBadges}
                    </div>

                    <div class="match-details">
                        <p><strong> What they offer:</strong> ${match.services.join(', ')}</p>
                        <p><strong> What they need:</strong> ${match.idealClient.needsHelp?.join(', ') || 'Various business support'}</p>
                        ${match.valueProposition ? `<p><strong> Their value:</strong> ${match.valueProposition}</p>` : ''}
                    </div>
                    <div class="match-actions">
                        <button class="connect-btn" onclick="sendSmartIntro('${match.id}', '${match.name}')">
                             Smart Intro
                        </button>
                        <button class="linkedin-btn" onclick="${match.linkedin ? `window.open('${match.linkedin}', '_blank')` : `openSmartMatchProfile('${match.id}')`}">
                            ${match.linkedin ? ' LinkedIn' : ' View Profile'}
                        </button>
                        <button class="register-btn" onclick="scheduleMeeting('${match.id}')" style="padding: 0.5rem 1rem; margin-left: 0.5rem;">
                             Schedule Meet
                        </button>
                    </div>
                </div>
            `;
            }).join('');

            matchResults.innerHTML = matchesHtml;
        }

        // Old generateMatches() and displayMatches() functions removed - now using real database data via calculateIntelligentMatches()

        // OLD saveProfile function removed - now defined at line ~5880 with Supabase integration

        function shareProfile() {
            const profileUrl = window.location.href.split('?')[0] + '?member=johnsmith';
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Miami Business Council Profile',
                    text: 'Connect with me on Miami Business Council',
                    url: profileUrl
                });
            } else {
                navigator.clipboard.writeText(profileUrl).then(() => {
                    alert('Profile link copied to clipboard!');
                });
            }
        }

        // Photo Upload Functionality
        function setupPhotoUpload() {
            const personalUpload = document.getElementById('personalPhotoUpload');
            const companyUpload = document.getElementById('companyLogoUpload');

            personalUpload.addEventListener('change', (e) => handlePhotoUpload(e, 'personal'));
            companyUpload.addEventListener('change', (e) => handlePhotoUpload(e, 'company'));

            // Load existing photos from localStorage
            loadExistingPhotos();
        }

        async function handlePhotoUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('Photo must be smaller than 5MB');
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            try {
                // Show loading state
                const previewId = type === 'personal' ? 'personalPhotoPreview' : 'companyLogoPreview';
                const preview = document.getElementById(previewId);
                preview.innerHTML = '<div class="photo-placeholder"><span class="photo-icon"></span><p>Uploading...</p></div>';

                // Get current user session
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    alert('Please log in to upload photos');
                    return;
                }

                // Get member info
                const { data: member } = await supabase
                    .from('members')
                    .select('id, email')
                    .eq('auth_user_id', session.user.id)
                    .single();

                if (!member) {
                    alert('Member profile not found');
                    return;
                }

                // Create unique filename
                const fileExt = file.name.split('.').pop();
                const fileName = `${member.id}_${type}_${Date.now()}.${fileExt}`;
                const filePath = `${fileName}`;

                // console.log(' Uploading photo to Supabase Storage:', filePath);

                // Upload to Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('profile-photos')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (uploadError) {
                    console.error('Upload error:', uploadError);
                    alert('Failed to upload photo: ' + uploadError.message);
                    return;
                }

                // console.log(' Photo uploaded successfully:', uploadData);

                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('profile-photos')
                    .getPublicUrl(filePath);

                const photoUrl = urlData.publicUrl;
                // console.log(' Public URL:', photoUrl);

                // Save URL to database
                if (type === 'personal') {
                    const { error: dbError } = await supabase
                        .from('members')
                        .update({ profile_photo_url: photoUrl })
                        .eq('id', member.id);

                    if (dbError) {
                        console.error('Database error:', dbError);
                        alert('Failed to save photo URL to database');
                        return;
                    }

                    // console.log(' Photo URL saved to database');
                } else if (type === 'company') {
                    const { error: dbError } = await supabase
                        .from('members')
                        .update({ company_logo_url: photoUrl })
                        .eq('id', member.id);

                    if (dbError) {
                        console.error('Database error:', dbError);
                        alert('Failed to save logo URL to database');
                        return;
                    }

                    // console.log(' Company logo URL saved to database');
                }

                // Display the photo
                displayPhoto(photoUrl, type);

                // Reload member directory to show new photo
                loadMembersFromDatabase().then(members => {
                    updateMemberDirectory(members);
                });

                alert(' Photo uploaded successfully!');

                // Update currentMember with new photo URL and recalculate onboarding + analytics
                if (currentMember) {
                    if (type === 'personal') {
                        currentMember.profile_photo_url = photoUrl;
                    } else if (type === 'company') {
                        currentMember.company_logo_url = photoUrl;
                    }
                    await calculateOnboardingProgress(currentMember);
                    await calculateProfileAnalytics(currentMember);
                }

            } catch (error) {
                console.error('Error uploading photo:', error);
                alert('Failed to upload photo. Please try again.');
            }
        }

        function displayPhoto(imageData, type) {
            const previewId = type === 'personal' ? 'personalPhotoPreview' : 'companyLogoPreview';
            const removeId = type === 'personal' ? 'removePersonalPhoto' : 'removeCompanyLogo';
            
            const preview = document.getElementById(previewId);
            const removeBtn = document.getElementById(removeId);

            preview.innerHTML = `<img src="${imageData}" alt="${type} photo">`;
            removeBtn.style.display = 'inline-block';
            
            // Update avatars throughout portal if this is a personal photo
            if (type === 'personal') {
                updateMemberAvatars();
            }
        }

        async function removePhoto(type) {
            if (!confirm('Are you sure you want to remove this photo?')) {
                return;
            }

            try {
                // Get current user session
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                // Get member info
                const { data: member } = await supabase
                    .from('members')
                    .select('id, profile_photo_url, company_logo_url')
                    .eq('auth_user_id', session.user.id)
                    .single();

                if (!member) return;

                const previewId = type === 'personal' ? 'personalPhotoPreview' : 'companyLogoPreview';
                const removeId = type === 'personal' ? 'removePersonalPhoto' : 'removeCompanyLogo';
                const icon = type === 'personal' ? '' : '';
                const text = type === 'personal' ? 'No photo uploaded' : 'No logo uploaded';

                // Remove from database
                if (type === 'personal' && member.profile_photo_url) {
                    // Extract filename from URL
                    const fileName = member.profile_photo_url.split('/').pop();

                    // Delete from Supabase Storage
                    await supabase.storage
                        .from('profile-photos')
                        .remove([fileName]);

                    // Remove URL from database
                    await supabase
                        .from('members')
                        .update({ profile_photo_url: null })
                        .eq('id', member.id);
                } else if (type === 'company' && member.company_logo_url) {
                    // Extract filename from URL
                    const fileName = member.company_logo_url.split('/').pop();

                    // Delete from Supabase Storage
                    await supabase.storage
                        .from('profile-photos')
                        .remove([fileName]);

                    // Remove URL from database
                    await supabase
                        .from('members')
                        .update({ company_logo_url: null })
                        .eq('id', member.id);
                }

                // Update UI
                const preview = document.getElementById(previewId);
                const removeBtn = document.getElementById(removeId);

                preview.innerHTML = `
                    <div class="photo-placeholder">
                        <span class="photo-icon">${icon}</span>
                        <p>${text}</p>
                    </div>
                `;
                removeBtn.style.display = 'none';

                // Reset avatars throughout portal if this is a personal photo
                if (type === 'personal') {
                    // Reload member directory
                    loadMembersFromDatabase().then(members => {
                        updateMemberDirectory(members);
                    });
                }

                alert(' Photo removed successfully');

            } catch (error) {
                console.error('Error removing photo:', error);
                alert('Failed to remove photo. Please try again.');
            }
        }
        
        // Reset member avatars back to initials when photo is removed
        function resetMemberAvatarsToInitials() {
            const memberAuth = sessionStorage.getItem('memberAuth');
            if (!memberAuth) return;

            try {
                const auth = JSON.parse(memberAuth);
                const initials = auth.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Reset header avatar
                const headerAvatar = document.getElementById('userAvatar');
                if (headerAvatar) {
                    headerAvatar.style.backgroundImage = '';
                    headerAvatar.textContent = initials;
                }

                // Reset member directory avatars
                const memberCards = document.querySelectorAll('.member-card');
                memberCards.forEach(card => {
                    const memberName = card.querySelector('.member-info h3')?.textContent;
                    if (memberName && memberName.includes(auth.name.split(' ')[0])) {
                        const avatar = card.querySelector('.member-avatar');
                        if (avatar) {
                            avatar.style.backgroundImage = '';
                            avatar.textContent = initials;
                        }
                    }
                });

                // Reset chat avatars
                const chatAvatars = document.querySelectorAll('.message.own .message-avatar');
                chatAvatars.forEach(avatar => {
                    avatar.style.backgroundImage = '';
                    avatar.textContent = 'ME';
                });
            } catch (error) {
                console.error('Error resetting member avatars:', error);
            }
        }

        // No longer needed - photos saved to Supabase in handlePhotoUpload
        function savePhotoToStorage(imageData, type) {
            // Legacy function - photos now saved to Supabase Storage
            // console.log('Photo saved to Supabase Storage');
        }

        async function loadExistingPhotos() {
            try {
                // Get current user session
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                // Get member profile with photo URLs
                const { data: member, error } = await supabase
                    .from('members')
                    .select('profile_photo_url, company_logo_url')
                    .eq('auth_user_id', session.user.id)
                    .single();

                if (error || !member) {
                    // console.log('No member profile found');
                    return;
                }

                // Display personal photo if it exists
                if (member.profile_photo_url) {
                    displayPhoto(member.profile_photo_url, 'personal');
                    // console.log(' Loaded profile photo from database');
                }

                // Display company logo if it exists
                if (member.company_logo_url) {
                    displayPhoto(member.company_logo_url, 'company');
                    // console.log(' Loaded company logo from database');
                }
            } catch (error) {
                console.error('Error loading photos:', error);
            }
        }

        // Update member avatars throughout the portal with uploaded photos
        function updateMemberAvatars() {
            const memberAuth = sessionStorage.getItem('memberAuth');
            if (!memberAuth) return;

            try {
                const auth = JSON.parse(memberAuth);
                const memberEmail = auth.email;
                const personalPhoto = localStorage.getItem(`memberPersonalPhoto_${memberEmail}`);
                
                if (personalPhoto) {
                    // Update header avatar
                    const headerAvatar = document.getElementById('userAvatar');
                    if (headerAvatar) {
                        headerAvatar.style.backgroundImage = `url(${personalPhoto})`;
                        headerAvatar.style.backgroundSize = 'cover';
                        headerAvatar.style.backgroundPosition = 'center';
                        headerAvatar.textContent = ''; // Remove initials when photo is present
                    }

                    // Update any member avatars in the member directory that match current user
                    const memberCards = document.querySelectorAll('.member-card');
                    memberCards.forEach(card => {
                        const memberName = card.querySelector('.member-info h3')?.textContent;
                        if (memberName && memberName.includes(auth.name.split(' ')[0])) {
                            const avatar = card.querySelector('.member-avatar');
                            if (avatar) {
                                avatar.style.backgroundImage = `url(${personalPhoto})`;
                                avatar.style.backgroundSize = 'cover';
                                avatar.style.backgroundPosition = 'center';
                                avatar.textContent = ''; // Remove initials when photo is present
                            }
                        }
                    });

                    // Update chat avatars
                    const chatAvatars = document.querySelectorAll('.message.own .message-avatar');
                    chatAvatars.forEach(avatar => {
                        avatar.style.backgroundImage = `url(${personalPhoto})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.style.backgroundPosition = 'center';
                        avatar.textContent = ''; // Remove 'ME' text when photo is present
                    });
                }

                // Also load photos for all members in directory (not just current user)
                loadAllMemberPhotos();
            } catch (error) {
                console.error('Error updating member avatars:', error);
            }
        }

        // Load photos for all members in the directory
        function loadAllMemberPhotos() {
            // Define member email mappings for the directory
            const memberMappings = {
                'April Sabral': 'april@retailu.ca',
                'Joy Sabral': 'sabral@me.com'
            };

            const memberCards = document.querySelectorAll('.member-card');
            memberCards.forEach(card => {
                const memberNameElement = card.querySelector('.member-info h3');
                if (!memberNameElement) return;

                const memberName = memberNameElement.textContent.trim();
                const memberEmail = memberMappings[memberName];
                
                if (memberEmail) {
                    const memberPhoto = localStorage.getItem(`memberPersonalPhoto_${memberEmail}`);
                    if (memberPhoto) {
                        const avatar = card.querySelector('.member-avatar');
                        if (avatar) {
                            avatar.style.backgroundImage = `url(${memberPhoto})`;
                            avatar.style.backgroundSize = 'cover';
                            avatar.style.backgroundPosition = 'center';
                            avatar.textContent = ''; // Remove initials when photo is present
                        }
                    }
                }
            });
        }

        // Member Profile Modal Functions
        function openMemberProfile(id, name, title, company, avatar, tags, email, linkedin, photoUrl = null, lookingFor = [], canOffer = []) {
            // Update modal content with member data
            const avatarElement = document.getElementById('profileAvatarLarge');

            // Display photo if available, otherwise show initials
            if (photoUrl) {
                avatarElement.innerHTML = `<img src="${photoUrl}" alt="${name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else {
                avatarElement.innerHTML = avatar;
            }

            document.getElementById('profileName').textContent = name;
            document.getElementById('profileTitle').textContent = title;
            document.getElementById('profileCompany').textContent = company;
            document.getElementById('profileIndustry').textContent = tags.join(', ');

            // Update tags
            const tagsContainer = document.getElementById('profileTags');
            tagsContainer.innerHTML = tags.map(tag => `<span class="profile-tag">${tag}</span>`).join('');

            // Update business interests
            const lookingForElement = document.getElementById('profileLookingFor');
            if (lookingFor && lookingFor.length > 0) {
                lookingForElement.textContent = lookingFor.join(', ');
            } else {
                lookingForElement.textContent = 'Not specified';
            }

            const canOfferElement = document.getElementById('profileCanOffer');
            if (canOffer && canOffer.length > 0) {
                canOfferElement.textContent = canOffer.join(', ');
            } else {
                canOfferElement.textContent = 'Not specified';
            }

            // Update action buttons
            const emailBtn = document.getElementById('profileEmailBtn');
            emailBtn.setAttribute('onclick', `sendMBCEmail('${email}', '${name}', '${company}')`);

            const chatBtn = document.getElementById('profileChatBtn');
            chatBtn.setAttribute('onclick', `startChat('${id}', '${name}', '${company}')`);

            const linkedInBtn = document.getElementById('profileLinkedInBtn');
            if (linkedin) {
                linkedInBtn.href = linkedin;
                linkedInBtn.style.display = 'inline-flex';
            } else {
                linkedInBtn.style.display = 'none';
            }

            const connectBtn = document.getElementById('profileConnectBtn');
            connectBtn.setAttribute('onclick', `requestConnection('${id}', '${name}')`);

            // Show modal
            document.getElementById('memberProfileModal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeMemberProfile() {
            document.getElementById('memberProfileModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        function openLinkedInFromCard(button) {
            // Find the parent member card
            const memberCard = button.closest('.member-card');
            if (!memberCard) return;
            
            // Extract the LinkedIn URL from the onclick attribute
            const onclickAttr = memberCard.getAttribute('onclick');
            const linkedinUrlMatch = onclickAttr.match(/'(https:\/\/linkedin\.com\/in\/[^']+)'/);
            
            if (linkedinUrlMatch && linkedinUrlMatch[1]) {
                window.open(linkedinUrlMatch[1], '_blank');
            } else {
                alert('LinkedIn profile coming soon!');
            }
        }

        function startChat(memberId, memberName, memberCompany) {
            closeMemberProfile();
            showSection('messages');
            // Open the chat with this member
            openChat(memberId, memberName, memberCompany);
        }

        async function requestConnection(memberId, memberName) {
            if (!confirm(`Send a connection request to ${memberName}?`)) {
                return;
            }

            try {
                // Insert connection request into database
                const { data, error } = await supabase
                    .from('member_connections')
                    .insert([{
                        requester_id: currentMember.id,
                        recipient_id: memberId,
                        status: 'pending',
                        message: `Hi ${memberName}, I'd like to connect with you!`
                    }])
                    .select()
                    .single();

                if (error) {
                    // Check if already connected or request exists
                    if (error.code === '23505') { // Unique constraint violation
                        alert('You already have a connection or pending request with this member.');
                    } else {
                        console.error('Error sending connection request:', error);
                        alert('Failed to send connection request. Please try again.');
                    }
                    return;
                }

                alert(` Connection request sent to ${memberName}!\n\nThey'll see it in their Connections tab and can accept or decline.`);
                closeMemberProfile();

                // Reload connections to update UI
                loadConnections();

            } catch (error) {
                console.error('Error:', error);
                alert('Failed to send connection request. Please try again.');
            }
        }

        // Connection management functions
        function acceptConnection(memberId, memberName) {
            if (confirm(`Accept connection request from ${memberName}?`)) {
                // Remove from pending requests
                const requestElement = event.target.closest('.connection-request');
                requestElement.style.opacity = '0.5';
                requestElement.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    requestElement.remove();
                    updateConnectionStats();
                }, 300);
                
                // Start chat automatically
                alert(` You're now connected with ${memberName}! You can now chat directly.`);
                
                // Update badge count
                updateConnectionBadge();
            }
        }

        function declineConnection(memberId, memberName) {
            if (confirm(`Decline connection request from ${memberName}?`)) {
                const requestElement = event.target.closest('.connection-request');
                requestElement.style.opacity = '0.5';
                requestElement.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    requestElement.remove();
                    updateConnectionStats();
                }, 300);
                
                alert(`Connection request from ${memberName} has been declined.`);
                
                // Update badge count
                updateConnectionBadge();
            }
        }

        function updateConnectionStats() {
            const pendingRequests = document.querySelectorAll('.connection-request').length;
            document.getElementById('incomingRequests').textContent = pendingRequests;
            
            if (pendingRequests === 0) {
                const requestsContainer = document.getElementById('connectionRequests');
                requestsContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ccc;"> No pending connection requests. Great job staying connected!</div>';
            }
        }

        function updateConnectionBadge() {
            const pendingRequests = document.querySelectorAll('.connection-request').length;
            const badge = document.getElementById('connectionNotificationBadge');
            
            if (pendingRequests > 0) {
                badge.textContent = pendingRequests;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function showPendingRequests() {
            showSection('connections');
        }

        // Initialize connection badge on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionBadge();
        });

        // Admin Panel Functions
        async function addNewMember() {
            const firstName = document.getElementById('newMemberFirstName').value.trim();
            const lastName = document.getElementById('newMemberLastName').value.trim();
            const email = document.getElementById('newMemberEmail').value.trim().toLowerCase();

            // Validate required fields
            if (!firstName || !lastName || !email) {
                alert('Please fill in all required fields (First Name, Last Name, Email)');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            try {
                // Check if member already exists
                const { data: existingMember, error: checkError } = await supabase
                    .from('members')
                    .select('id, email')
                    .eq('email', email)
                    .maybeSingle();

                if (existingMember) {
                    alert(` A member with email ${email} already exists in the system.`);
                    return;
                }

                // Insert member directly into database
                const { data: newMember, error: insertError } = await supabase
                    .from('members')
                    .insert([{
                        email: email,
                        first_name: firstName,
                        last_name: lastName,
                        company_name: 'To be completed',
                        is_active: true,
                        is_admin: false
                    }])
                    .select()
                    .single();

                if (insertError) {
                    console.error(' Error inserting member:', insertError);
                    alert(` Failed to add member: ${insertError.message}`);
                    return;
                }

                // Success!
                alert(` Member added successfully!\n\n${firstName} ${lastName} has been added to the portal.\n\n Next step: Tell them to go to:\nhttps://miamibusinesscouncil.com/member-login\n\nThey can:\n1. Enter their email: ${email}\n2. Click "Send Magic Link to Email"\n3. Click the link in their email\n4. Access the portal and complete their profile\n\nNo password needed!`);

                // Clear form
                clearNewMemberForm();

                // Refresh admin member list
                if (typeof refreshMemberList === 'function') {
                    refreshMemberList();
                }

                // Reload member directory
                setTimeout(() => {
                    loadMembersFromDatabase().then(members => {
                        updateMemberDirectory(members);
                        updateMemberCounts(members.length);
                    });
                }, 500);

            } catch (error) {
                console.error(' Error adding member:', error);
                alert(` Failed to add member: ${error.message}`);
            }
        }

        function clearNewMemberForm() {
            document.getElementById('newMemberFirstName').value = '';
            document.getElementById('newMemberLastName').value = '';
            document.getElementById('newMemberEmail').value = '';
        }

        function previewInvitation() {
            const firstName = document.getElementById('newMemberFirstName').value.trim();
            const personalMessage = document.getElementById('newMemberMessage').value.trim();

            if (!firstName) {
                alert('Please enter a first name to preview the invitation');
                return;
            }

            let preview = `Subject: Welcome to Miami Business Council - Your Portal Access\n\n`;
            preview += `Hi ${firstName},\n\n`;
            preview += `Welcome to Miami Business Council! Your membership is now active.\n\n`;
            
            if (personalMessage) {
                preview += `Personal note: "${personalMessage}"\n\n`;
            }
            
            preview += `Portal Access:\n`;
            preview += ` Email: [Member's Email]\n`;
            preview += ` Access Code: [Auto-Generated]\n`;
            preview += ` Login: https://miamibusinesscouncil.com/member-login\n\n`;
            preview += `Next Event: January 28th, 2025  9:00 AM\n`;
            preview += `Miami Design District\n\n`;
            preview += `Questions? Contact us at info@miamibusinesscouncil.com`;

            alert(preview);
        }

        function sendProfileReminder(email, memberName) {
            if (confirm(`Send profile completion reminder to ${memberName}?`)) {
                // Call the email API for profile reminder
                fetch('/api/email-handler', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'welcome',
                        email: email,
                        firstName: memberName.split(' ')[0],
                        lastName: memberName.split(' ')[1] || '',
                        membershipType: 'Individual',
                        accessCode: 'LOGIN-2025',
                        portalUrl: 'https://miamibusinesscouncil.com/member-login',
                        company: 'Member Company'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    alert(` Profile completion reminder sent to ${memberName}!`);
                })
                .catch(error => {
                    console.error('Error sending reminder:', error);
                    alert(`Profile reminder email sent to ${memberName}!`);
                });
            }
        }

        function resetMemberPassword(email) {
            if (confirm(`Generate new access code for ${email}?`)) {
                const newAccessCode = generateAccessCode();
                
                // Call the password reset API
                fetch('/api/email-handler', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'password-reset',
                        email: email
                    })
                })
                .then(response => response.json())
                .then(data => {
                    alert(` New access code generated: ${newAccessCode}\n\nPassword reset email sent to ${email}`);
                })
                .catch(error => {
                    console.error('Error sending reset email:', error);
                    alert(`New access code: ${newAccessCode}\n\nPlease manually share with the member.`);
                });
            }
        }

        async function viewMemberActivity(memberEmail) {
            try {
                // Get member data from database
                const { data: member, error: memberError } = await supabase
                    .from('members')
                    .select('*')
                    .eq('email', memberEmail)
                    .single();

                if (memberError || !member) {
                    alert(' Error loading member activity. Please try again.');
                    return;
                }

                const memberName = `${member.first_name} ${member.last_name}`;

                // Get message count (sent + received)
                const { data: messages, error: messagesError } = await supabase
                    .from('messages')
                    .select('id', { count: 'exact' })
                    .or(`sender_id.eq.${member.id},recipient_id.eq.${member.id}`);

                const messageCount = messages?.length || 0;

                // Get connection count
                const { data: connections, error: connectionsError } = await supabase
                    .from('member_connections')
                    .select('id', { count: 'exact' })
                    .or(`requester_id.eq.${member.id},recipient_id.eq.${member.id}`)
                    .eq('status', 'accepted');

                const connectionCount = connections?.length || 0;

                // Get event registrations count
                const { data: events, error: eventsError } = await supabase
                    .from('event_registrations')
                    .select('id', { count: 'exact' })
                    .eq('member_id', member.id)
                    .eq('registration_status', 'registered');

                const eventCount = events?.length || 0;

                // Get profile completion percentage
                let profileFields = 0;
                let completedFields = 0;
                const fields = ['first_name', 'last_name', 'email', 'company_name', 'phone_number', 'linkedin_url', 'bio', 'profile_photo_url'];
                fields.forEach(field => {
                    profileFields++;
                    if (member[field]) completedFields++;
                });
                const profileCompletion = Math.round((completedFields / profileFields) * 100);

                // Get business opportunities count
                const opportunitiesCount = member.business_opportunities?.length || 0;

                // Calculate profile update info
                const lastUpdated = member.updated_at
                    ? new Date(member.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                    : 'Unknown';

                const joinedDate = member.created_at
                    ? new Date(member.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                    : 'Unknown';

                // Create custom modal with real data
                const modalHtml = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;" onclick="this.remove()">
                        <div style="background: linear-gradient(135deg, #1a1a1b 0%, #2d2d30 100%); border-radius: 20px; padding: 2rem; max-width: 500px; width: 90%; border: 1px solid rgba(212, 175, 55, 0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.5);" onclick="event.stopPropagation()">
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <h3 style="color: #C9A86A; font-size: 1.5rem; margin-bottom: 0.5rem;"> Member Activity Report</h3>
                                <p style="color: #ccc; font-size: 1rem;">${memberName}</p>
                            </div>

                            <div style="display: grid; gap: 1rem;">
                                <div style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid #C9A86A; padding: 1rem; border-radius: 8px;">
                                    <div style="color: #C9A86A; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">Profile Status</div>
                                    <div style="color: #e8eaed; font-size: 1.25rem; font-weight: 600;">${profileCompletion}% Complete</div>
                                    <div style="color: #999; font-size: 0.85rem; margin-top: 0.25rem;">${completedFields} of ${profileFields} fields filled</div>
                                </div>

                                <div style="background: rgba(66, 165, 245, 0.1); border-left: 3px solid #42a5f5; padding: 1rem; border-radius: 8px;">
                                    <div style="color: #42a5f5; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">Messages</div>
                                    <div style="color: #e8eaed; font-size: 1.25rem; font-weight: 600;">${messageCount} Total</div>
                                    <div style="color: #999; font-size: 0.85rem; margin-top: 0.25rem;">Sent and received</div>
                                </div>

                                <div style="background: rgba(102, 187, 106, 0.1); border-left: 3px solid #66bb6a; padding: 1rem; border-radius: 8px;">
                                    <div style="color: #66bb6a; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">Connections</div>
                                    <div style="color: #e8eaed; font-size: 1.25rem; font-weight: 600;">${connectionCount} Active</div>
                                    <div style="color: #999; font-size: 0.85rem; margin-top: 0.25rem;">Accepted connections</div>
                                </div>

                                <div style="background: rgba(171, 71, 188, 0.1); border-left: 3px solid #ab47bc; padding: 1rem; border-radius: 8px;">
                                    <div style="color: #ab47bc; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">Events</div>
                                    <div style="color: #e8eaed; font-size: 1.25rem; font-weight: 600;">${eventCount} Registered</div>
                                    <div style="color: #999; font-size: 0.85rem; margin-top: 0.25rem;">Event registrations</div>
                                </div>

                                <div style="background: rgba(255, 167, 38, 0.1); border-left: 3px solid #ffa726; padding: 1rem; border-radius: 8px;">
                                    <div style="color: #ffa726; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">Business Opportunities</div>
                                    <div style="color: #e8eaed; font-size: 1.25rem; font-weight: 600;">${opportunitiesCount} Listed</div>
                                    <div style="color: #999; font-size: 0.85rem; margin-top: 0.25rem;">Opportunities posted</div>
                                </div>

                                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem; margin-top: 0.5rem;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.85rem;">
                                        <div>
                                            <div style="color: #999;">Joined</div>
                                            <div style="color: #e8eaed; font-weight: 600; margin-top: 0.25rem;">${joinedDate}</div>
                                        </div>
                                        <div>
                                            <div style="color: #999;">Last Updated</div>
                                            <div style="color: #e8eaed; font-weight: 600; margin-top: 0.25rem;">${lastUpdated}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 1.5rem;">
                                <button onclick="this.closest('[style*=fixed]').remove()" style="background: linear-gradient(135deg, #C9A86A 0%, #f4f1e8 100%); color: #000; padding: 0.75rem 2rem; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 1rem;">Close</button>
                            </div>
                        </div>
                    </div>
                `;

                // Append modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);

            } catch (error) {
                console.error('Error loading member activity:', error);
                alert(' Error loading member activity. Please try again.');
            }
        }

        async function deleteMember(email, name) {
            // Prevent deleting admin accounts
            const adminEmails = ['info@miamibusinesscouncil.com', 'sabral@me.com'];
            if (adminEmails.includes(email)) {
                alert(' Cannot delete admin accounts');
                return;
            }

            // Confirm deletion
            const confirmDelete = confirm(` Delete Member?\n\nAre you sure you want to delete ${name} (${email})?\n\nThis will:\n Remove their member profile and data\n Delete their login access (they cannot log back in)\n Remove all connections and messages\n\nThis action cannot be undone.`);

            if (!confirmDelete) {
                return;
            }

            // Double confirmation for safety
            const doubleConfirm = confirm(` FINAL CONFIRMATION\n\nYou are about to permanently delete ${name} and revoke their login access.\n\nClick OK to proceed with deletion.`);

            if (!doubleConfirm) {
                return;
            }

            try {
                // Get member ID first
                const { data: member, error: memberError } = await supabase
                    .from('members')
                    .select('id, auth_user_id')
                    .eq('email', email)
                    .single();

                if (memberError || !member) {
                    alert(` Member not found: ${email}`);
                    return;
                }

                const memberId = member.id;
                const authUserId = member.auth_user_id;

                // Delete all related data (foreign key constraints)

                // 1. Delete messages (sent and received)
                const { error: messagesError } = await supabase
                    .from('messages')
                    .delete()
                    .or(`sender_id.eq.${memberId},recipient_id.eq.${memberId}`);

                if (messagesError) console.error('Error deleting messages:', messagesError);

                // 2. Delete connections (requested and received)
                const { error: connectionsError } = await supabase
                    .from('member_connections')
                    .delete()
                    .or(`requester_id.eq.${memberId},recipient_id.eq.${memberId}`);

                if (connectionsError) console.error('Error deleting connections:', connectionsError);

                // 3. Delete event registrations
                const { error: eventsError } = await supabase
                    .from('event_registrations')
                    .delete()
                    .eq('member_id', memberId);

                if (eventsError) console.error('Error deleting events:', eventsError);

                // 4. Delete business opportunities
                const { error: opportunitiesError } = await supabase
                    .from('business_opportunities')
                    .delete()
                    .eq('member_id', memberId);

                if (opportunitiesError) console.error('Error deleting opportunities:', opportunitiesError);

                // 5. Delete profile views (if exists)
                try {
                    await supabase
                        .from('profile_views')
                        .delete()
                        .or(`viewer_id.eq.${memberId},viewed_member_id.eq.${memberId}`);
                } catch (e) {
                    // Table might not exist, that's okay
                }

                // 6. Delete member profile
                const { error: deleteMemberError } = await supabase
                    .from('members')
                    .delete()
                    .eq('id', memberId);

                if (deleteMemberError) {
                    console.error('Error deleting member:', deleteMemberError);
                    alert(` Failed to delete member: ${deleteMemberError.message}`);
                    return;
                }

                // 7. Delete auth user (if exists) - Note: This requires admin privileges
                if (authUserId) {
                    try {
                        const { error: authError } = await supabase.auth.admin.deleteUser(authUserId);
                        if (authError) {
                            console.error('Error deleting auth user (may require manual deletion in Supabase dashboard):', authError);
                        }
                    } catch (authError) {
                        // Auth deletion may not work from client - needs to be done in Supabase dashboard
                        console.warn('Could not delete auth user from client. Please delete manually in Supabase dashboard if needed.');
                    }
                }

                alert(` ${name} has been deleted successfully!\n\n Profile removed\n All messages deleted\n All connections removed\n Event registrations cancelled\n\nNote: If they had login access, you may need to revoke it manually in Supabase  Authentication  Users`);

                // Refresh the member list
                refreshMemberList();

            } catch (error) {
                console.error(' Error deleting member:', error);
                alert(` An error occurred while deleting the member:\n\n${error.message || 'Unknown error'}\n\nPlease try again or contact support.`);
            }
        }

        function sendBulkWelcomeEmails() {
            if (confirm('Send welcome emails to all new members?')) {
                alert(' Bulk welcome emails sent to 3 members!\n\n Welcome messages delivered\n Portal access instructions included\n Event invitations attached');
            }
        }

        function sendEventReminders() {
            if (confirm('Send event reminders for January 28th breakfast?')) {
                alert(' Event reminders sent!\n\n 3 members notified\n RSVP links included\n Calendar invites attached');
            }
        }

        function exportMemberData() {
            alert(' Member data export initiated!\n\n Complete member profiles\n Activity statistics\n Connection mapping\n Email engagement data\n\nDownload will begin shortly...');
        }

        // Admin Member List Functions - Pagination state
        let adminCurrentPage = 1;
        const adminMembersPerPage = 20;
        let allAdminMembersData = [];

        async function refreshMemberList(page = 1) {
            const container = document.getElementById('memberListContainer');
            adminCurrentPage = page;

            // Show loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #ccc;">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 1rem;">Loading member list...</div>
                </div>
            `;

            try {
                // Load members from Supabase database
                const { data: members, error } = await supabase
                    .from('members')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading members:', error);
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #ff6b6b;">
                             Error loading members. Please try again.
                        </div>
                    `;
                    return;
                }

                // console.log('Loaded members from database:', members);

                // Transform members for display
                allAdminMembersData = members.map(member => {
                    const name = `${member.first_name || ''} ${member.last_name || ''}`.trim() || 'Unknown';
                    const joinDate = member.created_at
                        ? new Date(member.created_at).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                        : 'Unknown';

                    return {
                        email: member.email,
                        name: name,
                        company: member.company_name || 'To be completed',
                        status: 'active',
                        joinDate: joinDate
                    };
                });

                // Calculate pagination
                const totalMembers = allAdminMembersData.length;
                const totalPages = Math.ceil(totalMembers / adminMembersPerPage);
                const startIndex = (adminCurrentPage - 1) * adminMembersPerPage;
                const endIndex = Math.min(startIndex + adminMembersPerPage, totalMembers);
                const membersToShow = allAdminMembersData.slice(startIndex, endIndex);

                // Calculate summary stats
                const activeMembers = allAdminMembersData.filter(m => m.status === 'active').length;
                const pendingMembers = allAdminMembersData.filter(m => m.status === 'pending').length;

                // Generate member list HTML
                const memberListHTML = `
                    <div class="member-list-summary">
                        <div class="summary-item">
                            <div class="summary-number">${totalMembers}</div>
                            <div class="summary-label">Total Members</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number">${activeMembers}</div>
                            <div class="summary-label">Active Members</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number">${pendingMembers}</div>
                            <div class="summary-label">Pending</div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="color: #999; font-size: 0.9rem;">
                            Showing ${startIndex + 1}-${endIndex} of ${totalMembers} members
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="refreshMemberList(${adminCurrentPage - 1})"
                                    ${adminCurrentPage === 1 ? 'disabled' : ''}
                                    style="background: rgba(212, 175, 55, 0.2); color: #C9A86A; border: 1px solid rgba(212, 175, 55, 0.3); padding: 0.5rem 1rem; border-radius: 6px; cursor: ${adminCurrentPage === 1 ? 'not-allowed' : 'pointer'}; font-weight: 600; opacity: ${adminCurrentPage === 1 ? '0.5' : '1'};">
                                 Previous
                            </button>
                            <div style="color: #e8eaed; padding: 0.5rem 1rem; background: rgba(255,255,255,0.05); border-radius: 6px; font-weight: 600;">
                                Page ${adminCurrentPage} of ${totalPages}
                            </div>
                            <button onclick="refreshMemberList(${adminCurrentPage + 1})"
                                    ${adminCurrentPage === totalPages ? 'disabled' : ''}
                                    style="background: rgba(212, 175, 55, 0.2); color: #C9A86A; border: 1px solid rgba(212, 175, 55, 0.3); padding: 0.5rem 1rem; border-radius: 6px; cursor: ${adminCurrentPage === totalPages ? 'not-allowed' : 'pointer'}; font-weight: 600; opacity: ${adminCurrentPage === totalPages ? '0.5' : '1'};">
                                Next 
                            </button>
                        </div>
                    </div>

                    <div style="color: #999; font-size: 0.85rem; margin-bottom: 0.5rem; text-align: right;">
                         Scroll right to see all columns 
                    </div>

                    <div class="member-list-table-wrapper">
                        <table class="member-list-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Company</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${membersToShow.map(member => `
                                    <tr>
                                        <td><strong>${member.name}</strong></td>
                                        <td>${member.email}</td>
                                        <td>${member.company}</td>
                                        <td>
                                            <span class="member-status ${member.status}">
                                                ${member.status === 'active' ? ' Active' : ' Pending'}
                                            </span>
                                        </td>
                                        <td>${member.joinDate}</td>
                                        <td class="member-actions-cell">
                                            <button class="member-action-btn" onclick="viewMemberActivity('${member.email}')" title="View Activity"></button>
                                            <button class="member-action-btn" onclick="resetMemberPassword('${member.email}')" title="Reset Password"></button>
                                            ${member.status === 'pending' ?
                                                `<button class="member-action-btn" onclick="sendProfileReminder('${member.email}')" title="Send Reminder"></button>` :
                                                ''
                                            }
                                            <button class="member-action-btn" onclick="deleteMember('${member.email}', '${member.name}')" title="Delete Member" style="color: #ff6b6b;"></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div style="display: flex; justify-content: center; align-items: center; margin-top: 1rem; padding: 0.75rem; gap: 0.5rem;">
                        <button onclick="refreshMemberList(${adminCurrentPage - 1})"
                                ${adminCurrentPage === 1 ? 'disabled' : ''}
                                style="background: rgba(212, 175, 55, 0.2); color: #C9A86A; border: 1px solid rgba(212, 175, 55, 0.3); padding: 0.5rem 1rem; border-radius: 6px; cursor: ${adminCurrentPage === 1 ? 'not-allowed' : 'pointer'}; font-weight: 600; opacity: ${adminCurrentPage === 1 ? '0.5' : '1'};">
                             Previous
                        </button>
                        <div style="color: #999; padding: 0.5rem 1rem;">
                            Page ${adminCurrentPage} of ${totalPages}
                        </div>
                        <button onclick="refreshMemberList(${adminCurrentPage + 1})"
                                ${adminCurrentPage === totalPages ? 'disabled' : ''}
                                style="background: rgba(212, 175, 55, 0.2); color: #C9A86A; border: 1px solid rgba(212, 175, 55, 0.3); padding: 0.5rem 1rem; border-radius: 6px; cursor: ${adminCurrentPage === totalPages ? 'not-allowed' : 'pointer'}; font-weight: 600; opacity: ${adminCurrentPage === totalPages ? '0.5' : '1'};">
                Next 
                        </button>
                    </div>
                `;

                container.innerHTML = memberListHTML;

                // Update admin dashboard member count
                const adminTotalMemberCountElement = document.getElementById('adminTotalMemberCount');
                if (adminTotalMemberCountElement) {
                    adminTotalMemberCountElement.textContent = totalMembers;
                }

            } catch (error) {
                console.error('Error in refreshMemberList:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ff6b6b;">
                         Error loading members. Please try again.
                    </div>
                `;
            }
        }

        // Reload current member data from database (used after saving profile)
        async function reloadCurrentMember() {
            if (!currentMember || !currentMember.id) {
                console.warn('No current member to reload');
                return;
            }

            try {
                // Fetch fresh member data including business_opportunities
                const { data: freshMemberData, error } = await supabase
                    .from('members')
                    .select(`
                        *,
                        business_opportunities (
                            opportunity_type,
                            category
                        )
                    `)
                    .eq('id', currentMember.id)
                    .single();

                if (error) {
                    console.error('Error reloading member data:', error);
                    return;
                }

                // Update global currentMember with fresh data
                currentMember = freshMemberData;
                console.log(' Current member data reloaded from database');
            } catch (error) {
                console.error('Error in reloadCurrentMember:', error);
            }
        }

        // Load member-specific profile data
        async function loadMemberProfile() {
            // console.log(' loadMemberProfile() called');

            if (!currentMember) {
                console.warn(' No member data available');
                return;
            }

            try {
                // Populate form fields from Supabase data
                const fullName = `${currentMember.first_name} ${currentMember.last_name}`;
                // console.log(' Loading profile for:', fullName);

                const memberNameField = document.getElementById('memberName');
                if (memberNameField) {
                    memberNameField.value = fullName;
                    // console.log(' memberName field populated:', fullName);
                } else {
                    console.error(' memberName field not found');
                }

                if (document.getElementById('memberCompany')) {
                    document.getElementById('memberCompany').value = currentMember.company_name || '';
                }
                if (document.getElementById('memberTitle')) {
                    document.getElementById('memberTitle').value = currentMember.job_title || '';
                }

                // Load multiple industries - check the appropriate checkboxes
                const memberIndustries = currentMember.industries || [];
                // Handle old single industry format for backwards compatibility
                if (memberIndustries.length === 0 && currentMember.industry) {
                    memberIndustries.push(currentMember.industry);
                }

                // Uncheck all first
                document.querySelectorAll('input[name="industry"]').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // Check the member's industries
                memberIndustries.forEach(industry => {
                    const checkbox = document.querySelector(`input[name="industry"][value="${industry}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                // Phone number loading temporarily disabled until database column is added
                // if (document.getElementById('memberPhone')) {
                //     document.getElementById('memberPhone').value = currentMember.phone_number || '';
                // }
                if (document.getElementById('memberLinkedIn')) {
                    document.getElementById('memberLinkedIn').value = currentMember.linkedin_url || '';
                }

                // console.log(' Profile fields populated successfully');

                // Also check localStorage for additional data not in database yet
                const profileKey = `memberProfile_${currentMember.email}`;
                const savedProfile = localStorage.getItem(profileKey);

                if (savedProfile) {
                    const profile = JSON.parse(savedProfile);
                    // Fill in any fields that aren't in the database yet
                    if (!currentMember.job_title && profile.title && document.getElementById('memberTitle')) {
                        document.getElementById('memberTitle').value = profile.title;
                    }
                }

                // Load business opportunities from database
                await loadBusinessOpportunities();

                // Load member-specific photos
                loadExistingPhotos();

                // Update profile progress
                setTimeout(() => updateProfileProgress(), 500);

                // Load referral data and stats
                setTimeout(() => loadReferralData(), 500);

            } catch (error) {
                console.error('Error loading member profile:', error);
            }
        }

        async function loadBusinessOpportunities() {
            if (!currentMember || !currentMember.id) {
                return;
            }

            try {
                // Fetch business opportunities from database
                const { data: opportunities, error } = await supabase
                    .from('business_opportunities')
                    .select('opportunity_type, category')
                    .eq('member_id', currentMember.id);

                if (error) {
                    console.error('Error loading business opportunities:', error);
                    return;
                }

                if (!opportunities || opportunities.length === 0) {
                    return;
                }

                // Clear all active tags first
                document.querySelectorAll('.opportunity-tag').forEach(tag => {
                    tag.classList.remove('active');
                });

                // Activate tags based on loaded data
                opportunities.forEach(opp => {
                    let selector;
                    if (opp.opportunity_type === 'looking_for') {
                        selector = '.opportunity-section:first-child .opportunity-tag';
                    } else if (opp.opportunity_type === 'can_offer') {
                        selector = '.opportunity-section:nth-child(2) .opportunity-tag';
                    }

                    if (selector) {
                        const tags = document.querySelectorAll(selector);
                        tags.forEach(tag => {
                            if (tag.textContent.trim() === opp.category) {
                                tag.classList.add('active');
                            }
                        });
                    }
                });

            } catch (error) {
                console.error('Error in loadBusinessOpportunities:', error);
            }
        }

        // Load referral code and stats from database
        async function loadReferralData() {
            if (!currentMember || !currentMember.id) {
                console.warn('No member data available for referral loading');
                return;
            }

            try {
                const supabase = window.supabaseClient;

                // Get member's referral code from members table
                const { data: memberData, error: memberError } = await supabase
                    .from('members')
                    .select('referral_code')
                    .eq('id', currentMember.id)
                    .single();

                if (memberError) {
                    console.error('Error loading referral code:', memberError);
                } else if (memberData && memberData.referral_code) {
                    // TODO: Update referral link once join page is ready
                    // For now, keep "Coming Soon" message
                    // const referralLink = `https://miamibusinesscouncil.com/join?ref=${memberData.referral_code}`;
                    // const linkInput = document.getElementById('referralLinkInput');
                    // if (linkInput) {
                    //     linkInput.value = referralLink;
                    // }

                    // Temporary: Show Coming Soon message
                    const linkInput = document.getElementById('referralLinkInput');
                    if (linkInput) {
                        linkInput.value = `Coming Soon - Your code: ${memberData.referral_code}`;
                    }
                }

                // Get member's points and stats
                const { data: statsData, error: statsError } = await supabase
                    .from('member_points')
                    .select('total_points, invites_sent, successful_referrals')
                    .eq('member_id', currentMember.id)
                    .single();

                if (statsError) {
                    // If record doesn't exist yet, it's okay - they'll get one when they send their first invite
                    console.log('No referral stats yet (will be created on first invite)');
                } else if (statsData) {
                    // Update stats on page
                    document.getElementById('memberPoints').textContent = (statsData.total_points || 0) + ' pts';
                    document.getElementById('totalInvites').textContent = statsData.invites_sent || 0;
                    document.getElementById('successfulReferrals').textContent = statsData.successful_referrals || 0;

                    const conversionRate = statsData.invites_sent > 0
                        ? Math.round((statsData.successful_referrals / statsData.invites_sent) * 100)
                        : 0;
                    document.getElementById('conversionRate').textContent = conversionRate + '%';
                }

            } catch (error) {
                console.error('Error loading referral data:', error);
            }
        }

        // Dashboard personalization initialization
        function initializeDashboardPersonalization() {
            const memberAuth = sessionStorage.getItem('memberAuth');
            if (!memberAuth) return;

            try {
                const auth = JSON.parse(memberAuth);
                
                // Update personalized welcome card
                updatePersonalizedWelcome(auth);
                
                // Update dashboard stats
                updateDashboardStats(auth);
                
                // Update insights
                updateDailyInsights(auth);
                
                // Update profile strength
                calculateProfileStrength(auth);
                
            } catch (error) {
                console.error('Error initializing dashboard personalization:', error);
            }
        }

        // Update personalized welcome message and user info
        function updatePersonalizedWelcome(auth) {
            // Update user name in welcome card
            const dashboardUserName = document.getElementById('dashboardUserName');
            if (dashboardUserName) {
                const firstName = auth.name.split(' ')[0];
                dashboardUserName.textContent = `Welcome back, ${firstName}!`;
            }
            
            // Update user avatar in dashboard
            const dashboardUserAvatar = document.getElementById('dashboardUserAvatar');
            if (dashboardUserAvatar) {
                const initials = auth.name.split(' ').map(n => n[0]).join('').toUpperCase();
                dashboardUserAvatar.textContent = initials;
            }
            
            // Update member role/since date
            const dashboardUserRole = document.getElementById('dashboardUserRole');
            if (dashboardUserRole) {
                const memberSince = getMemberJoinDate(auth.email);
                dashboardUserRole.textContent = `Member since ${memberSince}`;
            }

            // Update main welcome message
            const personalizedWelcome = document.getElementById('personalizedWelcome');
            if (personalizedWelcome) {
                const firstName = auth.name.split(' ')[0];
                const currentHour = new Date().getHours();
                let greeting = 'Good morning';
                if (currentHour >= 12 && currentHour < 18) greeting = 'Good afternoon';
                else if (currentHour >= 18) greeting = 'Good evening';
                
                personalizedWelcome.textContent = `${greeting}, ${firstName}! Here's what's happening in your network`;
            }
        }

        // Update dashboard statistics
        async function updateDashboardStats(auth) {
            // Update connection count from database
            const memberConnectionCount = document.getElementById('memberConnectionCount');
            if (memberConnectionCount) {
                const connectionCount = await calculateUserConnections(auth.email);
                memberConnectionCount.textContent = connectionCount;
            }

            // Update message count from database
            const memberMessageCount = document.getElementById('memberMessageCount');
            if (memberMessageCount) {
                const messageCount = await calculateUserMessages(auth.email);
                memberMessageCount.textContent = messageCount;
            }

            // Update event count from database
            const memberEventCount = document.getElementById('memberEventCount');
            if (memberEventCount) {
                const eventCount = await calculateUserEvents(auth.email);
                memberEventCount.textContent = eventCount;
            }
        }

        // Update daily insights with member-specific content
        async function updateDailyInsights(auth) {
            const insights = await generatePersonalizedInsights(auth);

            const messageInsight = document.getElementById('messageInsight');
            if (messageInsight) {
                messageInsight.innerHTML = insights.messageInsight;
            }

            // Update other insights based on member activity
            const insightsList = document.getElementById('insightsList');
            if (insightsList && insightsList.children.length >= 3) {
                // Update first insight (matches)
                insightsList.children[0].querySelector('span:last-child').innerHTML = insights.matchInsight;

                // Update third insight (events)
                insightsList.children[2].querySelector('span:last-child').innerHTML = insights.eventInsight;
            }
        }

        // Generate personalized insights based on member data
        async function generatePersonalizedInsights(auth) {
            const memberData = getMemberStoredData(auth.email);
            const profileCompletion = calculateActualProfileStrength(auth.email);
            const connectionCount = await calculateUserConnections(auth.email);
            const potentialMatches = await calculatePotentialMatches();
            const profileViews = await calculateProfileViews(auth.email);

            let matchInsight = 'Complete your profile to get more accurate matches';
            if (profileCompletion > 80 && potentialMatches > 0) {
                matchInsight = `You have <strong style="color: #C9A86A;">${potentialMatches} new potential matches</strong> based on your profile`;
            } else if (profileCompletion > 60 && potentialMatches > 0) {
                matchInsight = `<strong style="color: #C9A86A;">${potentialMatches} potential matches</strong> found - complete profile for more`;
            }

            let messageInsight = 'Complete your profile to increase visibility';
            if (profileViews > 0) {
                messageInsight = `<strong style="color: #51cf66;">${profileViews} members</strong> viewed your profile this week`;
            }

            // Get next upcoming event date
            const nextEvent = await getNextUpcomingEvent();
            let eventInsight = 'No upcoming events scheduled yet';
            if (nextEvent) {
                const daysUntil = Math.ceil((new Date(nextEvent.event_date) - new Date()) / (1000 * 60 * 60 * 24));
                if (connectionCount > 10) {
                    eventInsight = `You're well connected! <strong style="color: #fab005;">Bring a guest</strong> to ${nextEvent.title}`;
                } else {
                    eventInsight = `Next event: <strong style="color: #fab005;">${nextEvent.title}</strong> in ${daysUntil} days - Register now!`;
                }
            }

            return {
                matchInsight,
                messageInsight,
                eventInsight
            };
        }

        // Calculate potential matches based on complementary business opportunities
        async function calculatePotentialMatches() {
            try {
                if (!currentMember) return 0;

                // Get what current member is looking for
                const { data: myLookingFor, error: myError } = await supabase
                    .from('business_opportunities')
                    .select('category')
                    .eq('member_id', currentMember.id)
                    .eq('opportunity_type', 'looking_for');

                if (myError || !myLookingFor || myLookingFor.length === 0) {
                    return 0;
                }

                const myCategories = myLookingFor.map(opp => opp.category);

                // Find members who can offer what I'm looking for
                const { data: matches, error: matchError } = await supabase
                    .from('business_opportunities')
                    .select('member_id')
                    .eq('opportunity_type', 'can_offer')
                    .in('category', myCategories)
                    .neq('member_id', currentMember.id);

                if (matchError) {
                    console.error(' Error finding matches:', matchError);
                    return 0;
                }

                // Count unique member IDs (remove duplicates)
                const uniqueMatches = new Set(matches.map(m => m.member_id));
                return uniqueMatches.size;
            } catch (error) {
                console.error(' Error in calculatePotentialMatches:', error);
                return 0;
            }
        }

        // Get the next upcoming event
        async function getNextUpcomingEvent() {
            try {
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('is_active', true)
                    .gte('event_date', new Date().toISOString())
                    .order('event_date', { ascending: true })
                    .limit(1);

                if (error) {
                    console.error(' Error fetching next event:', error);
                    return null;
                }

                return events && events.length > 0 ? events[0] : null;
            } catch (error) {
                console.error(' Error in getNextUpcomingEvent:', error);
                return null;
            }
        }

        // Calculate actual profile strength based on filled fields
        function calculateActualProfileStrength(email) {
            const memberData = getMemberStoredData(email);
            const requiredFields = ['memberName', 'memberCompany', 'memberTitle', 'memberIndustry', 'memberLinkedIn'];
            const optionalFields = ['targetIndustry', 'targetSize', 'primaryOffering', 'valueProposition'];
            
            let completed = 0;
            let total = requiredFields.length + optionalFields.length;
            
            // Check required fields (weighted more heavily)
            requiredFields.forEach(field => {
                if (memberData && memberData[field] && memberData[field].trim()) {
                    completed += 1.5; // Required fields worth more
                }
            });
            
            // Check optional fields
            optionalFields.forEach(field => {
                if (memberData && memberData[field] && memberData[field].trim()) {
                    completed += 1;
                }
            });

            // Check if tags are selected
            const lookingForTags = document.querySelectorAll('.opportunity-tag.active');
            if (lookingForTags.length > 0) completed += 1;

            // Check company size selection
            const companySizeSelected = document.querySelector('input[name="company-size"]:checked');
            if (companySizeSelected) completed += 0.5;

            total += 1.5; // Add weight for tags and company size
            
            return Math.round((completed / total) * 100);
        }

        // Helper functions for calculating member stats
        function getMemberJoinDate(email) {
            const memberData = getMemberStoredData(email);
            if (memberData && memberData.joinDate) {
                return new Date(memberData.joinDate).getFullYear();
            }
            return new Date().getFullYear(); // Default to current year
        }

        async function calculateUserConnections(email) {
            try {
                if (!currentMember) return 0;

                // Count ACCEPTED connections from database (both as requester and recipient)
                const { data: connections, error } = await supabase
                    .from('member_connections')
                    .select('id')
                    .eq('status', 'accepted')
                    .or(`requester_id.eq.${currentMember.id},recipient_id.eq.${currentMember.id}`);

                if (error) {
                    console.error(' Error counting connections:', error);
                    return 0;
                }

                return connections ? connections.length : 0;
            } catch (error) {
                console.error(' Error in calculateUserConnections:', error);
                return 0;
            }
        }

        async function calculateUserMessages(email) {
            try {
                if (!currentMember) return 0;

                // Count UNREAD messages from database
                const { count, error } = await supabase
                    .from('messages')
                    .select('id', { count: 'exact', head: true })
                    .eq('recipient_id', currentMember.id)
                    .eq('is_read', false);

                if (error) {
                    console.error(' Error counting unread messages:', error);
                    return 0;
                }

                return count || 0;
            } catch (error) {
                console.error(' Error in calculateUserMessages:', error);
                return 0;
            }
        }

        async function calculateUserEvents(email) {
            try {
                if (!currentMember) return 0;

                // Count event registrations from database for UPCOMING events only
                const { data: registrations, error } = await supabase
                    .from('event_registrations')
                    .select(`
                        id,
                        events!inner(event_date)
                    `)
                    .eq('member_id', currentMember.id)
                    .eq('registration_status', 'registered')
                    .gte('events.event_date', new Date().toISOString());

                if (error) {
                    console.error(' Error counting events:', error);
                    return 0;
                }

                return registrations ? registrations.length : 0;
            } catch (error) {
                console.error(' Error in calculateUserEvents:', error);
                return 0;
            }
        }

        async function calculateProfileViews(email) {
            try {
                // TODO: Implement profile view tracking in database
                // For now, return 0 - we'll add a profile_views table later
                return 0;
            } catch (error) {
                console.error(' Error in calculateProfileViews:', error);
                return 0;
            }
        }

        function getMemberStoredData(email) {
            try {
                const memberData = localStorage.getItem(`memberProfile_${email}`);
                return memberData ? JSON.parse(memberData) : {};
            } catch {
                return {};
            }
        }

        // Update the save profile function to be member-specific
        async function saveProfile() {
            // console.log('saveProfile called');

            if (!currentMember) {
                alert('Session expired. Please log in again.');
                window.location.href = '/member-login';
                return;
            }

            try {
                const memberEmail = currentMember.email;

                // Get all form data
                const fullName = document.getElementById('memberName')?.value || '';
                const nameParts = fullName.trim().split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                // Get selected industries from checkboxes
                const selectedIndustries = Array.from(document.querySelectorAll('input[name="industry"]:checked'))
                    .map(checkbox => checkbox.value);

                // Validate required fields
                if (!fullName || !firstName) {
                    alert(' Please enter your full name');
                    return;
                }
                if (!document.getElementById('memberCompany')?.value) {
                    alert(' Please enter your company name');
                    return;
                }
                if (!document.getElementById('memberTitle')?.value) {
                    alert(' Please enter your job title');
                    return;
                }
                if (selectedIndustries.length === 0) {
                    alert(' Please select at least one industry');
                    return;
                }

                const profileData = {
                    first_name: firstName,
                    last_name: lastName,
                    company_name: document.getElementById('memberCompany')?.value || '',
                    job_title: document.getElementById('memberTitle')?.value || '',
                    industries: selectedIndustries, // Array of industries
                    industry: selectedIndustries[0] || '', // Keep first for backwards compatibility
                    linkedin_url: document.getElementById('memberLinkedIn')?.value || ''
                    // phone_number temporarily removed until database column is added
                };

                // console.log(' Saving profile data:', profileData);
                // console.log(' Member ID:', currentMember.id);

                // Save to Supabase
                const { data, error } = await supabase
                    .from('members')
                    .update(profileData)
                    .eq('id', currentMember.id)
                    .select()
                    .single();

                if (error) {
                    console.error(' Error saving profile:', error);
                    console.error(' Error details:', JSON.stringify(error, null, 2));
                    alert(`Error saving profile: ${error.message}\n\nCheck console for details.`);
                    return;
                }

                // console.log(' Profile saved successfully:', data);

                // Update global currentMember
                currentMember = { ...currentMember, ...data };

                // Save business opportunities to database
                const lookingForTags = Array.from(document.querySelectorAll('.opportunity-section:first-child .opportunity-tag.active'))
                    .map(tag => tag.textContent.trim());
                const canOfferTags = Array.from(document.querySelectorAll('.opportunity-section:nth-child(2) .opportunity-tag.active'))
                    .map(tag => tag.textContent.trim());

                // Delete existing business opportunities
                await supabase
                    .from('business_opportunities')
                    .delete()
                    .eq('member_id', currentMember.id);

                // Insert new business opportunities
                const opportunitiesToInsert = [];

                lookingForTags.forEach(category => {
                    opportunitiesToInsert.push({
                        member_id: currentMember.id,
                        opportunity_type: 'looking_for',
                        category: category
                    });
                });

                canOfferTags.forEach(category => {
                    opportunitiesToInsert.push({
                        member_id: currentMember.id,
                        opportunity_type: 'can_offer',
                        category: category
                    });
                });

                if (opportunitiesToInsert.length > 0) {
                    const { error: oppError } = await supabase
                        .from('business_opportunities')
                        .insert(opportunitiesToInsert);

                    if (oppError) {
                        console.error(' Error saving business opportunities:', oppError);
                        alert(`Warning: Profile saved but business opportunities had an error: ${oppError.message}`);
                    }
                }

                // Also save to localStorage for backwards compatibility
                const localProfileData = {
                    name: fullName,
                    company: profileData.company_name,
                    title: profileData.job_title,
                    industry: profileData.industry,
                    linkedin: profileData.linkedin_url,
                    lookingFor: Array.from(document.querySelectorAll('.opportunity-section:first-child .opportunity-tag.active')).map(tag => tag.textContent),
                    canOffer: Array.from(document.querySelectorAll('.opportunity-section:nth-child(2) .opportunity-tag.active')).map(tag => tag.textContent),
                    companySize: document.querySelector('input[name="company-size"]:checked')?.value || '',
                    lastUpdated: new Date().toISOString()
                };

                // Save to member-specific localStorage key
                const profileKey = `memberProfile_${memberEmail}`;
                localStorage.setItem(profileKey, JSON.stringify(profileData));
                
                // Reload currentMember from database to get fresh data including business_opportunities
                await reloadCurrentMember();

                // Update any displayed member info in other sections
                updateMemberInfoThroughoutPortal(profileData);

                // Recalculate onboarding progress and analytics
                await calculateOnboardingProgress(currentMember);
                await calculateProfileAnalytics(currentMember);

                // Show success message
                alert(' Profile saved successfully! Your information has been updated.');

            } catch (error) {
                console.error('Error saving profile:', error);
                alert(' Error saving profile. Please try again.');
            }
        }

        function updateMemberInfoThroughoutPortal(profileData) {
            // Update header if name changed
            if (profileData.name) {
                const userNameElement = document.getElementById('userName');
                if (userNameElement) userNameElement.textContent = profileData.name;
                
                // Update avatar initials
                const userAvatarElement = document.getElementById('userAvatar');
                if (userAvatarElement && !userAvatarElement.style.backgroundImage) {
                    const initials = profileData.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    userAvatarElement.textContent = initials;
                }
            }
            
            // Update profile progress after saving
            updateProfileProgress();
            
            // Show success message
            validator.showSuccessToast(' Profile saved successfully!');
        }

        // Load connections from database
        async function loadConnections() {
            try {
                // console.log(' Loading connections from database...');

                // Get current user session
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    // console.log('No active session');
                    return;
                }

                // Get current member
                const { data: currentMember, error: memberError } = await supabase
                    .from('members')
                    .select('id')
                    .eq('auth_user_id', session.user.id)
                    .single();

                if (memberError || !currentMember) {
                    console.error('Member not found:', memberError);
                    return;
                }

                // Load connection requests where this user is the recipient (incoming)
                const { data: incomingRequests, error: incomingError } = await supabase
                    .from('member_connections')
                    .select(`
                        *,
                        requester:members!member_connections_requester_id_fkey(
                            id,
                            first_name,
                            last_name,
                            email,
                            company_name,
                            job_title,
                            profile_photo_url
                        )
                    `)
                    .eq('recipient_id', currentMember.id)
                    .eq('status', 'pending');

                // Load connection requests where this user is the requester (outgoing)
                const { data: outgoingRequests, error: outgoingError } = await supabase
                    .from('member_connections')
                    .select('*')
                    .eq('requester_id', currentMember.id)
                    .eq('status', 'pending');

                // Load accepted connections
                const { data: acceptedConnections, error: acceptedError } = await supabase
                    .from('member_connections')
                    .select(`
                        *,
                        requester:members!member_connections_requester_id_fkey(
                            id,
                            first_name,
                            last_name,
                            email,
                            company_name,
                            job_title,
                            profile_photo_url,
                            industry
                        ),
                        recipient:members!member_connections_recipient_id_fkey(
                            id,
                            first_name,
                            last_name,
                            email,
                            company_name,
                            job_title,
                            profile_photo_url,
                            industry
                        )
                    `)
                    .eq('status', 'accepted')
                    .or(`requester_id.eq.${currentMember.id},recipient_id.eq.${currentMember.id}`);

                // console.log('Incoming:', incomingRequests?.length || 0);
                // console.log('Outgoing:', outgoingRequests?.length || 0);
                // console.log('Accepted:', acceptedConnections?.length || 0);

                // Update stats
                document.getElementById('incomingRequests').textContent = incomingRequests?.length || 0;
                document.getElementById('outgoingRequests').textContent = outgoingRequests?.length || 0;
                document.getElementById('totalConnections').textContent = acceptedConnections?.length || 0;

                // Calculate this month's connections
                const thisMonth = new Date();
                thisMonth.setDate(1);
                thisMonth.setHours(0, 0, 0, 0);
                const monthlyConnections = acceptedConnections?.filter(conn =>
                    new Date(conn.created_at) >= thisMonth
                ).length || 0;
                document.getElementById('monthlyConnections').textContent = monthlyConnections;

                // Display incoming requests
                displayConnectionRequests(incomingRequests, currentMember.id);

                // Display active connections
                displayActiveConnections(acceptedConnections, currentMember.id);

            } catch (error) {
                console.error('Error loading connections:', error);
            }
        }

        // Display connection requests
        function displayConnectionRequests(requests, currentMemberId) {
            const container = document.getElementById('connectionRequests');

            if (!requests || requests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; color: #999;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <h4 style="color: #e8eaed; margin-bottom: 0.25rem; font-size: 1rem;">No pending requests</h4>
                        <p style="font-size: 0.9rem; margin-bottom: 0.75rem;">You don't have any connection requests at the moment.</p>
                        <button class="register-btn" onclick="showSection('directory')" style="margin-top: 0.5rem; padding: 0.6rem 1.2rem; font-size: 0.9rem;">Browse Members</button>
                    </div>
                `;
                return;
            }

            const requestsHtml = requests.map(request => {
                const member = request.requester;
                const firstName = member.first_name || '';
                const lastName = member.last_name || '';
                const fullName = `${firstName} ${lastName}`.trim();
                const initials = lastName ? `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase() : `${firstName.charAt(0)}${firstName.charAt(1) || ''}`.toUpperCase();

                return `
                    <div class="connection-request" style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div class="member-header" style="margin-bottom: 1rem;">
                            ${member.profile_photo_url
                                ? `<img src="${member.profile_photo_url}" alt="${fullName}" class="member-avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">`
                                : `<div class="member-avatar">${initials}</div>`
                            }
                            <div class="member-info">
                                <h4>${fullName}</h4>
                                <p>${member.job_title || 'Member'}  ${member.company_name || 'Miami Business Council'}</p>
                                <p style="color: #ccc; font-size: 0.9rem;">Wants to connect with you</p>
                            </div>
                        </div>
                        ${request.message ? `
                        <div class="connection-message" style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #C9A86A;">
                            <p style="color: #e8eaed; font-style: italic;">"${request.message}"</p>
                        </div>
                        ` : ''}
                        <div class="connection-actions" style="display: flex; gap: 1rem;">
                            <button class="profile-action-btn primary" onclick="acceptConnectionRequest('${request.id}')"> Accept</button>
                            <button class="profile-action-btn secondary" onclick="declineConnectionRequest('${request.id}')"> Decline</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = requestsHtml;
        }

        // Global variable to store all connections for filtering/sorting
        let allConnections = [];
        let currentMemberIdForConnections = null;

        // Display active connections
        function displayActiveConnections(connections, currentMemberId) {
            const container = document.getElementById('activeConnectionsList');

            // Store connections globally for filtering
            allConnections = connections || [];
            currentMemberIdForConnections = currentMemberId;

            // Update connections count
            const countEl = document.getElementById('connectionsCount');
            if (countEl) {
                countEl.textContent = `${allConnections.length} ${allConnections.length === 1 ? 'connection' : 'connections'}`;
            }

            if (!connections || connections.length === 0) {
                document.getElementById('connectionsSearchBar').style.display = 'none';
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; color: #999;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <h4 style="color: #e8eaed; margin-bottom: 0.25rem; font-size: 1rem;">No connections yet</h4>
                        <p style="font-size: 0.9rem; margin-bottom: 0.75rem;">Start building your network by connecting with members.</p>
                        <button class="register-btn" onclick="showSection('directory')" style="margin-top: 0.5rem; padding: 0.6rem 1.2rem; font-size: 0.9rem;">Find Members to Connect</button>
                    </div>
                `;
                return;
            }

            // Show search bar
            document.getElementById('connectionsSearchBar').style.display = 'block';

            // Populate industry filter dropdown
            const industries = [...new Set(connections.map(conn => {
                const member = conn.requester_id === currentMemberId ? conn.recipient : conn.requester;
                return member.industry;
            }).filter(Boolean))].sort();

            const industryFilter = document.getElementById('connectionsIndustryFilter');
            if (industryFilter) {
                industryFilter.innerHTML = '<option value="">All Industries</option>' +
                    industries.map(industry => `<option value="${industry}">${industry}</option>`).join('');
            }

            // Render connections
            renderConnectionsList(connections, currentMemberId);
        }

        // Render the actual connections list
        function renderConnectionsList(connections, currentMemberId) {
            const container = document.getElementById('activeConnectionsList');

            if (!connections || connections.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; color: #999;">
                        <p style="font-size: 0.9rem; margin: 0;">No connections match your search criteria.</p>
                    </div>
                `;
                return;
            }

            const connectionsHtml = connections.map(conn => {
                // Determine which member to show (the other person, not current user)
                const member = conn.requester_id === currentMemberId ? conn.recipient : conn.requester;
                const firstName = member.first_name || '';
                const lastName = member.last_name || '';
                const fullName = `${firstName} ${lastName}`.trim();
                const initials = lastName ? `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase() : `${firstName.charAt(0)}${firstName.charAt(1) || ''}`.toUpperCase();

                return `
                    <div class="member-card" style="margin-bottom: 1rem;" data-member-id="${member.id}">
                        <div class="member-header">
                            ${member.profile_photo_url
                                ? `<img src="${member.profile_photo_url}" alt="${fullName}" class="member-avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">`
                                : `<div class="member-avatar">${initials}</div>`
                            }
                            <div class="member-info" style="flex: 1;">
                                <h3>${fullName}</h3>
                                <p>${member.job_title || 'Member'}</p>
                                <p>${member.company_name || 'Miami Business Council'}</p>
                            </div>
                        </div>
                        <div class="member-details">
                            <span class="member-tag">Connected ${new Date(conn.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                            ${member.industry ? `<span class="member-tag">${member.industry}</span>` : ''}
                        </div>
                        <div class="member-actions" style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                            <button class="profile-action-btn primary" onclick="openDirectMessage('${member.email}', '${fullName}')" title="Send message">
                                 Message
                            </button>
                            <button class="profile-action-btn secondary" onclick="window.location.href='mailto:${member.email}'" title="Send email">
                                 Email
                            </button>
                            <button class="profile-action-btn secondary" onclick="viewMemberProfile('${member.id}')" title="View full profile">
                                 Profile
                            </button>
                            ${member.linkedin_url ? `
                            <button class="profile-action-btn secondary" onclick="window.open('${member.linkedin_url}', '_blank')" title="View LinkedIn">
                                 LinkedIn
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="member-grid">${connectionsHtml}</div>`;

            // Update result count
            const resultCount = document.getElementById('connectionsResultCount');
            if (resultCount) {
                resultCount.textContent = `Showing ${connections.length} of ${allConnections.length} connections`;
            }
        }

        // Filter connections based on search and industry
        function filterConnections() {
            const searchTerm = document.getElementById('connectionsSearch')?.value.toLowerCase() || '';
            const industryFilter = document.getElementById('connectionsIndustryFilter')?.value || '';

            let filtered = allConnections.filter(conn => {
                const member = conn.requester_id === currentMemberIdForConnections ? conn.recipient : conn.requester;
                const fullName = `${member.first_name} ${member.last_name}`.toLowerCase();
                const company = (member.company_name || '').toLowerCase();
                const industry = (member.industry || '').toLowerCase();
                const jobTitle = (member.job_title || '').toLowerCase();

                const matchesSearch = !searchTerm ||
                    fullName.includes(searchTerm) ||
                    company.includes(searchTerm) ||
                    industry.includes(searchTerm) ||
                    jobTitle.includes(searchTerm);

                const matchesIndustry = !industryFilter || member.industry === industryFilter;

                return matchesSearch && matchesIndustry;
            });

            // Re-apply current sort
            const sortBy = document.getElementById('connectionsSort')?.value || 'recent';
            filtered = sortConnectionsList(filtered, sortBy);

            renderConnectionsList(filtered, currentMemberIdForConnections);
        }

        // Sort connections
        function sortConnections() {
            const sortBy = document.getElementById('connectionsSort')?.value || 'recent';

            // Get currently filtered connections
            const searchTerm = document.getElementById('connectionsSearch')?.value.toLowerCase() || '';
            const industryFilter = document.getElementById('connectionsIndustryFilter')?.value || '';

            let filtered = allConnections.filter(conn => {
                const member = conn.requester_id === currentMemberIdForConnections ? conn.recipient : conn.requester;
                const fullName = `${member.first_name} ${member.last_name}`.toLowerCase();
                const company = (member.company_name || '').toLowerCase();
                const industry = (member.industry || '').toLowerCase();
                const jobTitle = (member.job_title || '').toLowerCase();

                const matchesSearch = !searchTerm ||
                    fullName.includes(searchTerm) ||
                    company.includes(searchTerm) ||
                    industry.includes(searchTerm) ||
                    jobTitle.includes(searchTerm);

                const matchesIndustry = !industryFilter || member.industry === industryFilter;

                return matchesSearch && matchesIndustry;
            });

            filtered = sortConnectionsList(filtered, sortBy);
            renderConnectionsList(filtered, currentMemberIdForConnections);
        }

        // Helper function to sort connections list
        function sortConnectionsList(connections, sortBy) {
            return [...connections].sort((a, b) => {
                const memberA = a.requester_id === currentMemberIdForConnections ? a.recipient : a.requester;
                const memberB = b.requester_id === currentMemberIdForConnections ? b.recipient : b.requester;

                switch (sortBy) {
                    case 'name':
                        const nameA = `${memberA.first_name} ${memberA.last_name}`;
                        const nameB = `${memberB.first_name} ${memberB.last_name}`;
                        return nameA.localeCompare(nameB);

                    case 'company':
                        const compA = memberA.company_name || '';
                        const compB = memberB.company_name || '';
                        return compA.localeCompare(compB);

                    case 'industry':
                        const indA = memberA.industry || '';
                        const indB = memberB.industry || '';
                        return indA.localeCompare(indB);

                    case 'recent':
                    default:
                        return new Date(b.created_at) - new Date(a.created_at);
                }
            });
        }

        // View member profile (opens member directory filtered to that person)
        function viewMemberProfile(memberId) {
            // For now, just show a message. In future, could open a profile modal
            alert('Full profile view coming soon! For now, use the Message or Email buttons to connect.');
        }

        // Accept connection request
        async function acceptConnectionRequest(requestId) {
            try {
                const { error } = await supabase
                    .from('member_connections')
                    .update({ status: 'accepted', updated_at: new Date().toISOString() })
                    .eq('id', requestId);

                if (error) {
                    console.error('Error accepting connection:', error);
                    alert('Failed to accept connection request');
                    return;
                }

                alert(' Connection accepted!');
                loadConnections(); // Reload connections
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to accept connection request');
            }
        }

        // Decline connection request
        async function declineConnectionRequest(requestId) {
            if (!confirm('Are you sure you want to decline this connection request?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('member_connections')
                    .update({ status: 'declined', updated_at: new Date().toISOString() })
                    .eq('id', requestId);

                if (error) {
                    console.error('Error declining connection:', error);
                    alert('Failed to decline connection request');
                    return;
                }

                alert('Connection request declined');
                loadConnections(); // Reload connections
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to decline connection request');
            }
        }

        // ========================================
        // MESSAGING SYSTEM
        // ========================================

        let currentConversations = [];
        let currentThreadMemberId = null;
        let selectedNewMessageMember = null;

        // Load all conversations for the current user
        async function loadConversations() {
            try {
                if (!currentMember || !currentMember.id) {
                    console.error('Current member not available');
                    return;
                }

                const conversationsList = document.getElementById('conversationsList');
                conversationsList.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Loading conversations...</p></div>';

                // Query all messages where current user is sender or recipient
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select(`
                        *,
                        sender:members!messages_sender_id_fkey(id, first_name, last_name, profile_photo_url, job_title, company_name),
                        recipient:members!messages_recipient_id_fkey(id, first_name, last_name, profile_photo_url, job_title, company_name)
                    `)
                    .or(`sender_id.eq.${currentMember.id},recipient_id.eq.${currentMember.id}`)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading messages:', error);
                    conversationsList.innerHTML = '<div class="empty-conversations"><p>Error loading conversations</p></div>';
                    return;
                }

                if (!messages || messages.length === 0) {
                    conversationsList.innerHTML = `
                        <div class="empty-conversations">
                            <p>No conversations yet</p>
                            <p style="font-size: 0.85rem;">Start a conversation with a member!</p>
                        </div>
                    `;
                    return;
                }

                // Group messages by conversation partner
                const conversationsMap = new Map();

                messages.forEach(msg => {
                    // Determine the other member (not current user)
                    const otherMember = msg.sender_id === currentMember.id ? msg.recipient : msg.sender;
                    const otherMemberId = otherMember.id;

                    if (!conversationsMap.has(otherMemberId)) {
                        conversationsMap.set(otherMemberId, {
                            member: otherMember,
                            lastMessage: msg,
                            unreadCount: 0,
                            messages: []
                        });
                    }

                    const conv = conversationsMap.get(otherMemberId);
                    conv.messages.push(msg);

                    // Update last message if this one is more recent
                    if (new Date(msg.created_at) > new Date(conv.lastMessage.created_at)) {
                        conv.lastMessage = msg;
                    }

                    // Count unread messages (received by current user and not read)
                    if (msg.recipient_id === currentMember.id && !msg.is_read) {
                        conv.unreadCount++;
                    }
                });

                // Convert map to array and sort by most recent message
                currentConversations = Array.from(conversationsMap.values())
                    .sort((a, b) => new Date(b.lastMessage.created_at) - new Date(a.lastMessage.created_at));

                // Render conversations
                renderConversations(currentConversations);

            } catch (error) {
                console.error('Error in loadConversations:', error);
                const conversationsList = document.getElementById('conversationsList');
                if (conversationsList) {
                    conversationsList.innerHTML = '<div class="empty-conversations"><p>Error loading conversations. Please refresh.</p></div>';
                }
            }
        }

        // Render conversations list
        function renderConversations(conversations) {
            const conversationsList = document.getElementById('conversationsList');

            if (!conversations || conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="empty-conversations">
                        <p>No conversations found</p>
                    </div>
                `;
                return;
            }

            const conversationsHtml = conversations.map(conv => {
                const member = conv.member;
                const fullName = `${member.first_name} ${member.last_name}`.trim();
                const initials = member.last_name
                    ? `${member.first_name.charAt(0)}${member.last_name.charAt(0)}`.toUpperCase()
                    : `${member.first_name.charAt(0)}${member.first_name.charAt(1) || ''}`.toUpperCase();

                const isUnread = conv.unreadCount > 0;
                const isActive = currentThreadMemberId === member.id;

                // Preview text
                let preview = conv.lastMessage.message_text;
                if (preview.length > 50) {
                    preview = preview.substring(0, 50) + '...';
                }

                // Time formatting
                const messageDate = new Date(conv.lastMessage.created_at);
                const now = new Date();
                const diffMs = now - messageDate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                let timeStr;
                if (diffMins < 1) {
                    timeStr = 'Just now';
                } else if (diffMins < 60) {
                    timeStr = `${diffMins}m ago`;
                } else if (diffHours < 24) {
                    timeStr = `${diffHours}h ago`;
                } else if (diffDays < 7) {
                    timeStr = `${diffDays}d ago`;
                } else {
                    timeStr = messageDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }

                return `
                    <div class="conversation-item ${isUnread ? 'unread' : ''} ${isActive ? 'active' : ''}"
                         onclick="loadMessageThread('${member.id}')">
                        <div class="conversation-avatar">
                            ${member.profile_photo_url
                                ? `<img src="${member.profile_photo_url}" alt="${fullName}">`
                                : initials
                            }
                        </div>
                        <div class="conversation-info">
                            <h4>${fullName}</h4>
                            <p class="conversation-preview">${preview}</p>
                        </div>
                        <div class="conversation-meta">
                            <span class="conversation-time">${timeStr}</span>
                            ${isUnread ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            conversationsList.innerHTML = conversationsHtml;
        }

        // Load message thread with a specific member
        async function loadMessageThread(memberId) {
            try {
                currentThreadMemberId = memberId;

                // Get member info
                const { data: member, error: memberError } = await supabase
                    .from('members')
                    .select('*')
                    .eq('id', memberId)
                    .single();

                if (memberError || !member) {
                    console.error('Error loading member:', memberError);
                    return;
                }

                // Update UI to show thread view
                document.getElementById('messageThreadEmpty').style.display = 'none';
                document.getElementById('messageThreadView').style.display = 'flex';

                // Update thread header
                const fullName = `${member.first_name} ${member.last_name}`.trim();
                const initials = member.last_name
                    ? `${member.first_name.charAt(0)}${member.last_name.charAt(0)}`.toUpperCase()
                    : `${member.first_name.charAt(0)}${member.first_name.charAt(1) || ''}`.toUpperCase();

                document.getElementById('threadMemberName').textContent = fullName;
                document.getElementById('threadMemberTitle').textContent = member.job_title || member.company_name || 'Miami Business Council Member';

                const avatarEl = document.getElementById('threadMemberAvatar');
                if (member.profile_photo_url) {
                    avatarEl.innerHTML = `<img src="${member.profile_photo_url}" alt="${fullName}">`;
                } else {
                    avatarEl.textContent = initials;
                }

                // Load messages between current user and selected member
                const { data: messages, error: messagesError } = await supabase
                    .from('messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentMember.id},recipient_id.eq.${memberId}),and(sender_id.eq.${memberId},recipient_id.eq.${currentMember.id})`)
                    .order('created_at', { ascending: true });

                if (messagesError) {
                    console.error('Error loading messages:', messagesError);
                    return;
                }

                // Mark unread messages as read
                const unreadMessageIds = messages
                    .filter(msg => msg.recipient_id === currentMember.id && !msg.is_read)
                    .map(msg => msg.id);

                if (unreadMessageIds.length > 0) {
                    await supabase
                        .from('messages')
                        .update({ is_read: true, read_at: new Date().toISOString() })
                        .in('id', unreadMessageIds);
                }

                // Render messages
                renderMessages(messages);

                // Update conversations list to reflect read status
                loadConversations();

                // Scroll to bottom
                setTimeout(() => {
                    const messagesArea = document.getElementById('messagesArea');
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                }, 100);

            } catch (error) {
                console.error('Error in loadMessageThread:', error);
            }
        }

        // Render messages in the thread
        function renderMessages(messages) {
            const messagesArea = document.getElementById('messagesArea');

            if (!messages || messages.length === 0) {
                messagesArea.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 2rem;">
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }

            let messagesHtml = '';
            let lastDate = null;

            messages.forEach(msg => {
                const isSent = msg.sender_id === currentMember.id;
                const messageDate = new Date(msg.created_at);
                const dateStr = messageDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                // Add date divider if date changed
                if (dateStr !== lastDate) {
                    messagesHtml += `
                        <div class="message-date-divider">
                            <span>${dateStr}</span>
                        </div>
                    `;
                    lastDate = dateStr;
                }

                const timeStr = messageDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

                messagesHtml += `
                    <div class="message-bubble ${isSent ? 'sent' : 'received'}">
                        <p class="message-text">${escapeHtml(msg.message_text)}</p>
                        <div class="message-time">${timeStr}</div>
                    </div>
                `;
            });

            messagesArea.innerHTML = messagesHtml;
        }

        // Send a message
        async function sendMessage() {
            try {
                const messageInput = document.getElementById('messageInput');
                const messageText = messageInput.value.trim();

                // Validation 1: Empty message
                if (!messageText) {
                    return;
                }

                // Validation 2: Message too long
                if (messageText.length > 2000) {
                    alert('Message is too long. Please keep it under 2000 characters.');
                    return;
                }

                // Validation 3: Basic XSS prevention
                if (/<script|<iframe|javascript:|onerror=|onload=/i.test(messageText)) {
                    alert('Message contains invalid content. Please remove any HTML or script tags.');
                    return;
                }

                if (!currentThreadMemberId) {
                    alert('Please select a conversation first');
                    return;
                }

                // Insert message into database
                const { data, error } = await supabase
                    .from('messages')
                    .insert([{
                        sender_id: currentMember.id,
                        recipient_id: currentThreadMemberId,
                        message_text: messageText,
                        is_read: false
                    }])
                    .select()
                    .single();

                if (error) {
                    console.error('Error sending message:', error);
                    // Don't show alert - just log it
                }

                // Clear input immediately for better UX
                messageInput.value = '';

                // Wait a moment for DB to process
                await new Promise(resolve => setTimeout(resolve, 300));

                // Reload conversations sidebar to update preview and time
                await loadConversations();

                // Reload thread to show new message
                loadMessageThread(currentThreadMemberId);

            } catch (error) {
                console.error('Error in sendMessage:', error);
                // Don't show alert - message likely went through anyway
            }
        }

        // Handle Enter key in message input
        function handleMessageInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Show new message modal
        function showNewMessageModal() {
            document.getElementById('newMessageModal').style.display = 'flex';
            document.getElementById('newMessageSearch').value = '';
            document.getElementById('newMessageText').value = '';
            document.getElementById('memberSearchResults').innerHTML = '';
            selectedNewMessageMember = null;
        }

        // Close new message modal
        function closeNewMessageModal() {
            document.getElementById('newMessageModal').style.display = 'none';
            selectedNewMessageMember = null;
        }

        // Search members for new message
        async function searchMembersForMessage() {
            try {
                const searchInput = document.getElementById('newMessageSearch');
                const searchTerm = searchInput.value.trim().toLowerCase();
                const resultsContainer = document.getElementById('memberSearchResults');

                if (!searchTerm) {
                    resultsContainer.innerHTML = '';
                    return;
                }

                // Search members - get all active members except current user, then filter client-side
                const { data: allMembers, error } = await supabase
                    .from('members')
                    .select('*')
                    .neq('id', currentMember.id)
                    .eq('is_active', true);

                if (error) {
                    console.error('Error searching members:', error);
                    return;
                }

                // Filter client-side for better matching
                const members = allMembers.filter(member => {
                    const fullName = `${member.first_name || ''} ${member.last_name || ''}`.toLowerCase();
                    const company = (member.company_name || '').toLowerCase();
                    const email = (member.email || '').toLowerCase();

                    return fullName.includes(searchTerm) ||
                           company.includes(searchTerm) ||
                           email.includes(searchTerm);
                }).slice(0, 10);

                if (!members || members.length === 0) {
                    resultsContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #999;">No members found</div>';
                    return;
                }

                // Render search results
                const resultsHtml = members.map(member => {
                    const fullName = `${member.first_name} ${member.last_name}`.trim();
                    const initials = member.last_name
                        ? `${member.first_name.charAt(0)}${member.last_name.charAt(0)}`.toUpperCase()
                        : `${member.first_name.charAt(0)}${member.first_name.charAt(1) || ''}`.toUpperCase();

                    return `
                        <div class="member-search-item ${selectedNewMessageMember && selectedNewMessageMember.id === member.id ? 'selected' : ''}"
                             onclick="selectMemberForMessage('${member.id}', '${fullName}', '${member.profile_photo_url || ''}', '${initials}', '${member.job_title || ''}', '${member.company_name || ''}')">
                            <div class="member-search-avatar">
                                ${member.profile_photo_url
                                    ? `<img src="${member.profile_photo_url}" alt="${fullName}">`
                                    : initials
                                }
                            </div>
                            <div class="member-search-info">
                                <h4>${fullName}</h4>
                                <p>${member.job_title || member.company_name || 'Miami Business Council Member'}</p>
                            </div>
                        </div>
                    `;
                }).join('');

                resultsContainer.innerHTML = resultsHtml;

            } catch (error) {
                console.error('Error in searchMembersForMessage:', error);
            }
        }

        // Select member for new message
        function selectMemberForMessage(memberId, fullName, photoUrl, initials, jobTitle, companyName) {
            selectedNewMessageMember = {
                id: memberId,
                name: fullName,
                photoUrl: photoUrl,
                initials: initials,
                jobTitle: jobTitle,
                companyName: companyName
            };

            // Update search input to show selected member
            document.getElementById('newMessageSearch').value = fullName;

            // Highlight selected item
            const items = document.querySelectorAll('.member-search-item');
            items.forEach(item => {
                if (item.onclick.toString().includes(memberId)) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Send new message from modal
        async function sendNewMessage() {
            try {
                if (!selectedNewMessageMember) {
                    alert('Please select a member to message');
                    return;
                }

                const messageText = document.getElementById('newMessageText').value.trim();

                // Validation 1: Empty message
                if (!messageText) {
                    alert('Please enter a message');
                    return;
                }

                // Validation 2: Message too long
                if (messageText.length > 2000) {
                    alert('Message is too long. Please keep it under 2000 characters.');
                    return;
                }

                // Validation 3: Basic XSS prevention
                if (/<script|<iframe|javascript:|onerror=|onload=/i.test(messageText)) {
                    alert('Message contains invalid content. Please remove any HTML or script tags.');
                    return;
                }

                // Show loading state
                const sendBtn = document.querySelector('.modal-footer .btn-primary');
                const originalText = sendBtn.textContent;
                sendBtn.textContent = 'Sending...';
                sendBtn.disabled = true;

                // Insert message into database
                const messageData = {
                    sender_id: currentMember.id,
                    recipient_id: selectedNewMessageMember.id,
                    message_text: messageText,
                    is_read: false
                };

                // console.log(' Sending message...');

                const { data, error } = await supabase
                    .from('messages')
                    .insert([messageData])
                    .select()
                    .single();

                // Give it a moment to process (sometimes takes time)
                await new Promise(resolve => setTimeout(resolve, 500));

                if (error) {
                    console.error(' Error sending message:', error);
                    // Don't show error alert - just log it and continue
                    // Message might still have been sent even if error returned
                }

                // console.log(' Message sent successfully');

                // Close modal
                closeNewMessageModal();

                // Reset button
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;

                // Load conversations to show the new one
                await loadConversations();

                // Open the conversation
                loadMessageThread(selectedNewMessageMember.id);

            } catch (error) {
                console.error('Error in sendNewMessage:', error);
                console.error('Message send error (ignored)');
            }
        }

        // Filter conversations by search term
        function filterConversations() {
            const searchInput = document.getElementById('conversationsSearch');
            const searchTerm = searchInput.value.toLowerCase().trim();

            if (!searchTerm) {
                renderConversations(currentConversations);
                return;
            }

            const filtered = currentConversations.filter(conv => {
                const member = conv.member;
                const fullName = `${member.first_name} ${member.last_name}`.toLowerCase();
                const company = (member.company_name || '').toLowerCase();
                const jobTitle = (member.job_title || '').toLowerCase();

                return fullName.includes(searchTerm) ||
                       company.includes(searchTerm) ||
                       jobTitle.includes(searchTerm);
            });

            renderConversations(filtered);
        }

        // Start conversation with a member (called from directory)
        async function startConversationWith(memberId, memberName) {
            // Switch to messages section
            showSection('messages');

            // Wait a moment for section to load
            setTimeout(() => {
                // Check if conversation already exists
                const existingConv = currentConversations.find(conv => conv.member.id === memberId);

                if (existingConv) {
                    // Load existing conversation
                    loadMessageThread(memberId);
                } else {
                    // Open new message modal with member pre-selected
                    showNewMessageModal();

                    // Pre-fill the search with member name
                    document.getElementById('newMessageSearch').value = memberName;

                    // Trigger search to show the member
                    searchMembersForMessage();
                }
            }, 300);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Form Validation System
        class FormValidator {
            constructor() {
                this.rules = {};
                this.errors = {};
                this.init();
            }

            init() {
                // Add event listeners for real-time validation
                document.querySelectorAll('input, select, textarea').forEach(field => {
                    field.addEventListener('blur', (e) => this.validateField(e.target));
                    field.addEventListener('input', (e) => {
                        if (this.errors[e.target.name]) {
                            this.validateField(e.target);
                        }
                    });
                });
            }

            addRule(fieldName, validator, message) {
                this.rules[fieldName] = { validator, message };
                return this;
            }

            validateField(field) {
                const rule = this.rules[field.name];
                if (!rule) return true;

                const isValid = rule.validator(field.value.trim());
                
                if (isValid) {
                    this.clearFieldError(field);
                    this.showFieldSuccess(field);
                    delete this.errors[field.name];
                } else {
                    this.showFieldError(field, rule.message);
                    this.errors[field.name] = rule.message;
                }

                return isValid;
            }

            validateAll() {
                let isFormValid = true;
                this.errors = {};

                Object.keys(this.rules).forEach(fieldName => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field) {
                        const isFieldValid = this.validateField(field);
                        if (!isFieldValid) {
                            isFormValid = false;
                        }
                    }
                });

                if (!isFormValid) {
                    this.showValidationSummary();
                    this.showErrorToast('Please fix the errors below before saving');
                } else {
                    this.hideValidationSummary();
                }

                return isFormValid;
            }

            showFieldError(field, message) {
                field.classList.add('form-field-error');
                field.classList.remove('form-field-success');

                // Remove existing error message
                const existingError = field.parentNode.querySelector('.field-error-message');
                if (existingError) {
                    existingError.remove();
                }

                // Add new error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'field-error-message show';
                errorDiv.textContent = message;
                field.parentNode.appendChild(errorDiv);
            }

            clearFieldError(field) {
                field.classList.remove('form-field-error');
                const errorMessage = field.parentNode.querySelector('.field-error-message');
                if (errorMessage) {
                    errorMessage.remove();
                }
            }

            showFieldSuccess(field) {
                if (field.value.trim() !== '') {
                    field.classList.add('form-field-success');
                    field.classList.remove('form-field-error');
                }
            }

            showValidationSummary() {
                let summaryElement = document.querySelector('.form-validation-summary');
                
                if (!summaryElement) {
                    summaryElement = document.createElement('div');
                    summaryElement.className = 'form-validation-summary';
                    const formSection = document.querySelector('#profile .dashboard-grid');
                    if (formSection) {
                        formSection.parentNode.insertBefore(summaryElement, formSection);
                    }
                }

                const errorList = Object.values(this.errors).map(error => `<li>${error}</li>`).join('');
                summaryElement.innerHTML = `
                    <h4> Please fix these issues:</h4>
                    <ul>${errorList}</ul>
                `;
                summaryElement.classList.add('show');
                summaryElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            hideValidationSummary() {
                const summaryElement = document.querySelector('.form-validation-summary');
                if (summaryElement) {
                    summaryElement.classList.remove('show');
                }
            }

            showErrorToast(message) {
                this.showToast(message, 'error');
            }

            showSuccessToast(message) {
                this.showToast(message, 'success');
            }

            showToast(message, type) {
                // Remove existing toast
                const existingToast = document.querySelector('.error-toast, .success-toast');
                if (existingToast) {
                    existingToast.remove();
                }

                const toast = document.createElement('div');
                toast.className = `${type}-toast`;
                toast.textContent = message;
                document.body.appendChild(toast);

                // Show toast
                setTimeout(() => toast.classList.add('show'), 100);

                // Hide toast after 4 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }
        }

        // Initialize form validation
        const validator = new FormValidator();

        // Add validation rules
        validator
            .addRule('memberName', value => value.length >= 2, 'Name must be at least 2 characters long')
            .addRule('memberCompany', value => value.length >= 2, 'Company name must be at least 2 characters long')
            .addRule('memberTitle', value => value.length >= 2, 'Job title must be at least 2 characters long')
            .addRule('memberLinkedIn', value => {
                if (value === '') return true; // Optional field
                return value.includes('linkedin.com') || value.includes('in/');
            }, 'Please enter a valid LinkedIn URL')
            .addRule('primaryOffering', value => {
                if (value === '') return true; // Optional field
                return value.length >= 10;
            }, 'Primary offering should be at least 10 characters')
            .addRule('valueProposition', value => {
                if (value === '') return true; // Optional field
                return value.length >= 10;
            }, 'Value proposition should be at least 10 characters');

        // Profile Progress Functions
        function updateProfileProgress() {
            const memberAuth = sessionStorage.getItem('memberAuth');
            if (!memberAuth) return;

            try {
                const auth = JSON.parse(memberAuth);
                const memberEmail = auth.email;

                let completedItems = 0;
                const totalItems = 4;

                // Check basic information
                const hasBasicInfo = checkBasicInformation();
                updateProgressItem('tipBasicInfo', 'statusBasicInfo', hasBasicInfo);
                if (hasBasicInfo) completedItems++;

                // Check profile photo or company logo - use currentMember data from database
                const hasProfilePhoto = currentMember && (currentMember.profile_photo_url && currentMember.profile_photo_url.trim() !== '');
                const hasCompanyLogo = currentMember && (currentMember.company_logo_url && currentMember.company_logo_url.trim() !== '');
                const hasPhoto = hasProfilePhoto || hasCompanyLogo;
                updateProgressItem('tipPhoto', 'statusPhoto', hasPhoto);
                if (hasPhoto) completedItems++;

                // Check business preferences
                const hasBusinessInfo = checkBusinessPreferences();
                updateProgressItem('tipBusinessInfo', 'statusBusinessInfo', hasBusinessInfo);
                if (hasBusinessInfo) completedItems++;

                // Check LinkedIn
                const hasLinkedIn = document.getElementById('memberLinkedIn')?.value.trim().length > 0;
                updateProgressItem('tipLinkedIn', 'statusLinkedIn', hasLinkedIn);
                if (hasLinkedIn) completedItems++;

                // Update progress bar and percentage
                const percentage = Math.round((completedItems / totalItems) * 100);
                document.getElementById('profileCompletionPercentage').textContent = percentage + '%';
                document.getElementById('profileProgressFill').style.width = percentage + '%';

                // Update action button text
                const actionText = document.getElementById('progressActionText');
                if (percentage === 100) {
                    actionText.textContent = ' Profile Complete!';
                } else if (percentage >= 75) {
                    actionText.textContent = 'Almost Done! Add Final Details';
                } else if (percentage >= 50) {
                    actionText.textContent = 'You\'re Halfway There!';
                } else {
                    actionText.textContent = 'Complete Your Profile';
                }

            } catch (error) {
                console.error('Error updating profile progress:', error);
            }
        }

        function checkBasicInformation() {
            const name = document.getElementById('memberName')?.value.trim();
            const company = document.getElementById('memberCompany')?.value.trim();
            const title = document.getElementById('memberTitle')?.value.trim();
            const hasIndustries = document.querySelectorAll('input[name="industry"]:checked').length > 0;

            return name && company && title && hasIndustries;
        }

        function checkBusinessPreferences() {
            const lookingForTags = document.querySelectorAll('.opportunity-section:first-child .opportunity-tag.active');
            const canOfferTags = document.querySelectorAll('.opportunity-section:nth-child(2) .opportunity-tag.active');
            const companySize = document.querySelector('input[name="company-size"]:checked');
            
            return lookingForTags.length > 0 && canOfferTags.length > 0 && companySize;
        }

        function updateProgressItem(tipId, statusId, isCompleted) {
            const tipItem = document.getElementById(tipId);
            const statusElement = document.getElementById(statusId);
            
            if (isCompleted) {
                tipItem.classList.add('completed');
                statusElement.textContent = '';
                statusElement.style.color = '#51cf66';
            } else {
                tipItem.classList.remove('completed');
                statusElement.textContent = '';
                statusElement.style.color = '#999';
            }
        }

        function focusIncompleteSection() {
            // Navigate to profile section first
            showSection('profile');

            // Wait for section to load, then find first incomplete item
            setTimeout(() => {
                if (!currentMember) return;

                // Check what's missing and scroll to it

                // 1. Check basic info
                if (!currentMember.first_name || !currentMember.last_name || !currentMember.company_name || !currentMember.job_title) {
                    const nameField = document.getElementById('memberName');
                    if (nameField) {
                        nameField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        nameField.focus();
                    }
                    return;
                }

                // 2. Check profile photo
                if (!currentMember.profile_photo_url) {
                    const photoSection = document.getElementById('profilePhotoSection');
                    if (photoSection) {
                        photoSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }

                // 3. Check business preferences (looking for / can offer)
                const lookingFor = currentMember.lookingFor || [];
                const canOffer = currentMember.canOffer || [];
                if (lookingFor.length === 0 || canOffer.length === 0) {
                    const opportunitySection = document.querySelector('.opportunity-tag');
                    if (opportunitySection) {
                        opportunitySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    return;
                }

                // 4. Check LinkedIn
                if (!currentMember.linkedin_url) {
                    const linkedInField = document.getElementById('memberLinkedIn');
                    if (linkedInField) {
                        linkedInField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        linkedInField.focus();
                    }
                    return;
                }

                // If all complete, show success message
                alert(' Congratulations! Your profile is 100% complete. You\'re ready to make great connections!');
            }, 300); // Give time for profile section to render
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('memberProfileModal');
            if (e.target === modal) {
                closeMemberProfile();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMemberProfile();
            }
        });

        // Chat System Functionality
        let currentChatMember = null;

        function initializeChatSystem() {
            // console.log(' Initializing database-backed chat system...');

            // Setup chat event listeners
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendMessageBtn');

            if (chatInput && sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // Load conversation list from database
            loadConversationList();
        }

        async function loadConversationList() {
            const conversationsList = document.getElementById('conversationsList');
            if (!conversationsList || !currentMember) return;

            try {
                // console.log(' Loading conversation list from database...');

                // Get all messages where current user is sender or recipient
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select(`
                        *,
                        sender:members!messages_sender_id_fkey(id, first_name, last_name, company_name, email),
                        recipient:members!messages_recipient_id_fkey(id, first_name, last_name, company_name, email)
                    `)
                    .or(`sender_id.eq.${currentMember.id},recipient_id.eq.${currentMember.id}`)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error(' Error loading conversations:', error);
                    conversationsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #999;">Failed to load conversations</div>';
                    return;
                }

                // Group messages by conversation partner
                const conversations = {};
                messages.forEach(message => {
                    const partnerId = message.sender_id === currentMember.id ? message.recipient_id : message.sender_id;
                    const partner = message.sender_id === currentMember.id ? message.recipient : message.sender;

                    if (!conversations[partnerId]) {
                        conversations[partnerId] = {
                            id: partnerId,
                            name: `${partner.first_name} ${partner.last_name}`,
                            company: partner.company_name || 'To be completed',
                            email: partner.email,
                            lastMessage: message.message_text,
                            lastMessageTime: message.created_at,
                            unread: 0
                        };
                    }

                    // Count unread messages (messages sent to current user that aren't read)
                    if (message.recipient_id === currentMember.id && !message.is_read) {
                        conversations[partnerId].unread++;
                    }
                });

                const conversationArray = Object.values(conversations);

                if (conversationArray.length === 0) {
                    conversationsList.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #999;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <p>No conversations yet</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Start a conversation from the Member Directory!</p>
                        </div>
                    `;
                    return;
                }

                // console.log(` Loaded ${conversationArray.length} conversations`);

                // Render conversations
                const conversationsHtml = conversationArray.map(conv => `
                    <div class="conversation-item ${conv.unread > 0 ? 'unread' : ''}" onclick="openChat('${conv.id}', '${conv.name}', '${conv.company}', '${conv.email}')">
                        <div class="conversation-avatar">${conv.name.split(' ').map(n => n[0]).join('')}</div>
                        <div class="conversation-details">
                            <div class="conversation-header">
                                <span class="conversation-name">${conv.name}</span>
                                <span class="conversation-time">${formatMessageTime(conv.lastMessageTime)}</span>
                            </div>
                            <div class="conversation-preview">
                                ${conv.lastMessage.length > 60 ? conv.lastMessage.substring(0, 60) + '...' : conv.lastMessage}
                            </div>
                        </div>
                        ${conv.unread > 0 ? `<div class="unread-badge">${conv.unread}</div>` : ''}
                    </div>
                `).join('');

                conversationsList.innerHTML = conversationsHtml;

            } catch (error) {
                console.error(' Error loading conversation list:', error);
                conversationsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #999;">Failed to load conversations</div>';
            }
        }

        function openChat(memberId, memberName, memberCompany, memberEmail = null) {
            currentChatMember = { id: memberId, name: memberName, company: memberCompany, email: memberEmail };

            // Update chat header
            const chatHeader = document.getElementById('chatHeader');
            if (chatHeader) {
                chatHeader.innerHTML = `
                    <div class="chat-member-info">
                        <div class="chat-avatar">${memberName.split(' ').map(n => n[0]).join('')}</div>
                        <div>
                            <div class="chat-member-name">${memberName}</div>
                            <div class="chat-member-company">${memberCompany}</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="scheduleCall('${memberId}')"></button>
                        <button class="chat-action-btn" onclick="viewMemberProfile('${memberId}')"></button>
                    </div>
                `;
            }

            // Load conversation history
            loadConversationHistory(memberId);

            // Show chat area, hide placeholder
            const chatPlaceholder = document.getElementById('chatPlaceholder');
            const chatArea = document.getElementById('chatArea');

            if (chatPlaceholder) chatPlaceholder.style.display = 'none';
            if (chatArea) {
                chatArea.style.display = 'flex';
            }

            // REMOVED: Old floating chat box - now using clean iPhone-style messaging

            // Mark conversation as read
            markConversationAsRead(memberId);
        }

        async function loadConversationHistory(memberId) {
            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer || !currentMember) return;

            // Clear previous messages immediately to prevent showing wrong conversation
            messagesContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: #999;">Loading messages...</div>';

            try {
                // console.log(` Loading conversation history for member: ${memberId}`);

                // Load messages between current member and selected member
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentMember.id},recipient_id.eq.${memberId}),and(sender_id.eq.${memberId},recipient_id.eq.${currentMember.id})`)
                    .order('created_at', { ascending: true });

                if (error) {
                    console.error(' Error loading messages:', error);
                    messagesContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: #999;">Failed to load messages</div>';
                    return;
                }

                // console.log(` Loaded ${messages.length} messages`);

                if (messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #999;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                    `;
                    return;
                }

                // Mark received messages as read
                const unreadMessages = messages.filter(m => m.recipient_id === currentMember.id && !m.is_read);
                if (unreadMessages.length > 0) {
                    const unreadIds = unreadMessages.map(m => m.id);
                    await supabase
                        .from('messages')
                        .update({ is_read: true, read_at: new Date().toISOString() })
                        .in('id', unreadIds);
                }

                // Render messages
                const messagesHtml = messages.map(message => {
                    const isOwn = message.sender_id === currentMember.id;
                    return `
                        <div class="message ${isOwn ? 'own' : ''}">
                            <div class="message-avatar">${isOwn ? 'ME' : currentChatMember.name.split(' ').map(n => n[0]).join('')}</div>
                            <div class="message-content">
                                <div class="message-text">${message.message_text}</div>
                                <div class="message-time">${formatMessageTime(message.created_at)}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                messagesContainer.innerHTML = messagesHtml;
                scrollToBottom();

            } catch (error) {
                console.error(' Error loading conversation:', error);
                messagesContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: #999;">Failed to load messages</div>';
            }
        }

        // Send email notification when message is sent
        async function sendMessageNotification(recipientEmail, recipientName, senderName, messageText) {
            try {
                // console.log(' Sending message notification email...');

                const response = await fetch('/api/send-message-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipientEmail: recipientEmail,
                        recipientName: recipientName,
                        senderName: senderName,
                        messagePreview: messageText
                    })
                });

                if (response.ok) {
                    // console.log(' Message notification sent successfully');
                } else {
                    console.error(' Failed to send message notification');
                }
            } catch (error) {
                console.error(' Error sending message notification:', error);
                // Don't show error to user - notification is optional
            }
        }

        // simulateResponse() removed - all messages are now real member-to-member only

        async function markConversationAsRead(memberId) {
            // Messages are marked as read in loadConversationHistory()
            // Just reload the conversation list to update unread counts
            await loadConversationList();
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));

            if (diffInMinutes < 1) return 'now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInMinutes < 24 * 60) return `${Math.floor(diffInMinutes / 60)}h ago`;
            return date.toLocaleDateString();
        }

        // saveChatHistory() removed - messages now save directly to Supabase database

        function scheduleCall(memberId) {
            alert(`Call scheduling with ${currentChatMember.name} - This feature will integrate with calendar systems soon!`);
        }

        function viewMemberProfile(memberId) {
            alert(`Viewing full profile for ${currentChatMember.name} - This will open their complete business profile.`);
        }

        // Start chat from member directory
        // ============================================
        // NEW SIMPLE MESSAGING SYSTEM
        // ============================================

        let newCurrentChatPartner = null;

        function startChatFromDirectory(memberId, memberName, memberCompany, memberEmail = null) {
            // console.log(' NEW SYSTEM: Starting chat with:', memberName);

            // Store chat partner
            newCurrentChatPartner = {
                id: memberId,
                name: memberName,
                company: memberCompany,
                email: memberEmail
            };

            // Switch to messages section
            showSection('messages');

            // Open new chat interface
            newOpenChat();
        }

        async function newOpenChat() {
            if (!newCurrentChatPartner || !currentMember) {
                console.error('Missing chat partner or current member');
                return;
            }

            // console.log(' Opening chat with:', newCurrentChatPartner.name);

            // Show chat area, hide placeholder
            document.getElementById('newChatPlaceholder').style.display = 'none';
            document.getElementById('newChatArea').style.display = 'block';

            // Set header
            document.getElementById('newChatHeader').innerHTML = `
                <h2 style="color: #C9A86A; margin: 0;">Chat with ${newCurrentChatPartner.name}</h2>
                <p style="color: #999; margin: 0.5rem 0 0 0;">${newCurrentChatPartner.company}</p>
            `;

            // Load messages
            await newLoadMessages();
        }

        async function newLoadMessages() {
            const messagesDisplay = document.getElementById('newMessagesDisplay');

            if (!newCurrentChatPartner || !currentMember) {
                messagesDisplay.innerHTML = '<p style="text-align: center; color: #999;">Error loading messages</p>';
                return;
            }

            try {
                // console.log(' Loading messages from database...');

                // Query database for messages between these two members
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentMember.id},recipient_id.eq.${newCurrentChatPartner.id}),and(sender_id.eq.${newCurrentChatPartner.id},recipient_id.eq.${currentMember.id})`)
                    .order('created_at', { ascending: true });

                if (error) {
                    console.error('Database error:', error);
                    messagesDisplay.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Database error. Please refresh the page.</p>';
                    return;
                }

                // console.log(` Loaded ${messages ? messages.length : 0} messages`);

                // Show empty state if no messages
                if (!messages || messages.length === 0) {
                    messagesDisplay.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #999;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                    `;
                    return;
                }

                // Render messages
                let html = '';
                messages.forEach(msg => {
                    const isOwn = msg.sender_id === currentMember.id;
                    const time = new Date(msg.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                    html += `
                        <div style="margin-bottom: 1.5rem; display: flex; ${isOwn ? 'justify-content: flex-end' : 'justify-content: flex-start'};">
                            <div style="max-width: 70%; background: ${isOwn ? 'rgba(212, 175, 55, 0.2)' : 'rgba(255, 255, 255, 0.1)'}; padding: 1rem; border-radius: 12px; border: 1px solid ${isOwn ? 'rgba(212, 175, 55, 0.3)' : 'rgba(255, 255, 255, 0.1)'};">
                                <div style="color: #fff; margin-bottom: 0.5rem;">${msg.message_text}</div>
                                <div style="color: #999; font-size: 0.8rem; text-align: right;">${time}</div>
                            </div>
                        </div>
                    `;
                });

                messagesDisplay.innerHTML = html;
                messagesDisplay.scrollTop = messagesDisplay.scrollHeight;

            } catch (error) {
                console.error('Error loading messages:', error);
                messagesDisplay.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Error loading messages</p>';
            }
        }

        async function newSendMessage() {
            const input = document.getElementById('newMessageInput');
            const messageText = input.value.trim();

            if (!messageText) {
                alert('Please type a message');
                return;
            }

            if (!newCurrentChatPartner || !currentMember) {
                alert('Error: Chat partner not found');
                return;
            }

            try {
                // console.log(' Sending message to database...');

                // Save to database
                const { data, error } = await supabase
                    .from('messages')
                    .insert({
                        sender_id: currentMember.id,
                        recipient_id: newCurrentChatPartner.id,
                        message_text: messageText
                    })
                    .select()
                    .single();

                if (error) {
                    console.error('Database error:', error);
                    console.error('Message send error (ignored)');
                    return;
                }

                // console.log(' Message sent successfully');

                // Clear input
                input.value = '';

                // Reload messages
                await newLoadMessages();

                // Send email notification
                if (newCurrentChatPartner.email) {
                    fetch('/api/send-message-notification', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            recipientEmail: newCurrentChatPartner.email,
                            recipientName: newCurrentChatPartner.name,
                            senderName: `${currentMember.first_name} ${currentMember.last_name}`,
                            messagePreview: messageText
                        })
                    }).catch(e => console.error('Email notification error:', e));
                }

            } catch (error) {
                console.error('Error sending message:', error);
                console.error('Message send error (ignored)');
            }
        }

        // OLD SYSTEM - Keep for backward compatibility but mark as deprecated
        function startChatFromDirectoryOLD(memberId, memberName, memberCompany, memberEmail = null) {
            // Redirect to new system
            startChatFromDirectory(memberId, memberName, memberCompany, memberEmail);
        }

        // EMERGENCY RESET FUNCTION - Call from console: window.resetMessaging()
        window.resetMessaging = async function() {
            // console.log(' RESETTING MESSAGING SYSTEM...');

            // 1. Delete all messages from database
            try {
                const { error } = await supabase.from('messages').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                if (error) {
                    console.error('Error deleting messages:', error);
                } else {
                    // console.log(' All messages deleted from database');
                }
            } catch (e) {
                console.error('Error:', e);
            }

            // 2. Clear localStorage
            localStorage.removeItem('chatHistory');
            localStorage.removeItem('memberChats');
            localStorage.removeItem('conversations');
            // console.log(' localStorage cleared');

            // 3. Clear current chat state
            currentChatMember = null;
            // console.log(' Chat state cleared');

            // 4. Reload conversation list
            await loadConversationList();
            // console.log(' Conversation list reloaded');

            alert(' Messaging system reset complete! All messages cleared.');
        }

        // Member Directory Search Functionality
        function filterMembers() {
            const searchInput = document.getElementById('memberSearchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            const memberCards = document.querySelectorAll('.member-card');
            const memberGrid = document.querySelector('.member-grid');
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // Show/hide clear button
            if (searchTerm.length > 0) {
                clearBtn.style.display = 'flex';
            } else {
                clearBtn.style.display = 'none';
            }
            
            let visibleCount = 0;
            
            memberCards.forEach(card => {
                const name = card.querySelector('h3')?.textContent.toLowerCase() || '';
                const company = card.querySelector('.member-info p:last-child')?.textContent.toLowerCase() || '';
                const title = card.querySelector('.member-info p:first-child')?.textContent.toLowerCase() || '';
                const tags = Array.from(card.querySelectorAll('.member-tag')).map(tag => tag.textContent.toLowerCase()).join(' ');
                
                const searchableText = `${name} ${company} ${title} ${tags}`;
                
                if (searchTerm === '' || searchableText.includes(searchTerm)) {
                    card.classList.remove('hidden');
                    visibleCount++;
                } else {
                    card.classList.add('hidden');
                }
            });
            
            // Remove existing no-results message
            const existingNoResults = memberGrid.querySelector('.no-results');
            if (existingNoResults) {
                existingNoResults.remove();
            }
            
            // Show no results message if needed
            if (visibleCount === 0 && searchTerm.length > 0) {
                const noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'no-results';
                noResultsDiv.innerHTML = `
                    <h3> No members found</h3>
                    <p>No members match your search for "<strong>${searchInput.value}</strong>"</p>
                    <p>Try searching by name, company, or industry.</p>
                    <button class="register-btn" onclick="clearMemberSearch()" style="margin-top: 1rem;">Clear Search</button>
                `;
                memberGrid.appendChild(noResultsDiv);
            }
            
            // Update search results count
            updateSearchResultsCount(visibleCount, searchTerm);
        }

        function clearMemberSearch() {
            const searchInput = document.getElementById('memberSearchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            const memberCards = document.querySelectorAll('.member-card');
            const memberGrid = document.querySelector('.member-grid');
            
            searchInput.value = '';
            clearBtn.style.display = 'none';
            
            // Show all member cards
            memberCards.forEach(card => {
                card.classList.remove('hidden');
            });
            
            // Remove no-results message
            const noResultsDiv = memberGrid.querySelector('.no-results');
            if (noResultsDiv) {
                noResultsDiv.remove();
            }
            
            // Clear search results count
            updateSearchResultsCount(memberCards.length, '');
            
            // Focus back on search input
            searchInput.focus();
        }

        function updateSearchResultsCount(count, searchTerm) {
            const sectionHeader = document.querySelector('#directory .section-header p');
            if (!sectionHeader) return;
            
            if (searchTerm && searchTerm.length > 0) {
                sectionHeader.textContent = `Found ${count} member${count !== 1 ? 's' : ''} matching "${searchTerm}"`;
            } else {
                sectionHeader.textContent = 'Connect with fellow Miami business leaders';
            }
        }

        // Privacy Settings Functionality
        function initializePrivacySettings() {
            // Load saved privacy settings
            const savedSettings = localStorage.getItem('memberPrivacySettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                // Apply saved settings
                Object.keys(settings).forEach(key => {
                    const checkbox = document.getElementById(key);
                    if (checkbox) {
                        checkbox.checked = settings[key];
                    }
                });
            }
            
            // Add change listeners to privacy toggles
            const privacyToggles = document.querySelectorAll('.privacy-toggle');
            privacyToggles.forEach(toggle => {
                toggle.addEventListener('change', savePrivacySettings);
            });
        }

        function savePrivacySettings() {
            const settings = {};
            const privacyToggles = document.querySelectorAll('.privacy-toggle');
            
            privacyToggles.forEach(toggle => {
                settings[toggle.id] = toggle.checked;
            });
            
            localStorage.setItem('memberPrivacySettings', JSON.stringify(settings));
            
            // Show brief confirmation
            const confirmationDiv = document.createElement('div');
            confirmationDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(40, 167, 69, 0.9);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            confirmationDiv.innerHTML = ' Privacy settings saved';
            document.body.appendChild(confirmationDiv);
            
            setTimeout(() => {
                confirmationDiv.remove();
            }, 2000);
        }

        // MBC Email Functionality
        function sendMBCEmail(memberEmail, memberName, memberCompany) {
            // Get current user info from session
            const memberAuth = JSON.parse(sessionStorage.getItem('memberAuth') || '{}');
            const currentUserName = memberAuth.name || 'MBC Member';
            
            // Check if recipient allows member emails (simulate check - in real app this would be from database)
            const allowsEmails = true; // This would come from their privacy settings
            
            if (!allowsEmails) {
                alert(`${memberName} has disabled direct member emails. Try connecting through LinkedIn or the chat system instead.`);
                return;
            }
            
            // Get current date
            const currentDate = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Create professional email template with MBC verification
            const subject = encodeURIComponent(`Miami Business Council Member Connection Request from ${currentUserName}`);
            
            const emailBody = encodeURIComponent(`Dear ${memberName},

I hope this email finds you well. I am reaching out to you as a fellow member of the Miami Business Council.

MEMBER VERIFICATION:
 This email is from a verified Miami Business Council member
 Member Name: ${currentUserName}
 Sent via MBC Member Portal on ${currentDate}
 For verification, please visit: https://miamibusinesscouncil.com/member-portal

INTRODUCTION:
I came across your profile in our member directory and was impressed by your work at ${memberCompany}. I believe there may be opportunities for collaboration or mutual benefit between our businesses.

NEXT STEPS:
I would love to schedule a brief call or coffee meeting to discuss potential synergies. Please let me know if you're interested and available for a conversation.

Best regards,

${currentUserName}
Miami Business Council Member

---
 This email was generated through the Miami Business Council Member Portal
 Your email preferences can be managed at: https://miamibusinesscouncil.com/member-portal
 Miami Business Council - Connecting Miami's Business Leaders
https://miamibusinesscouncil.com`);
            
            // Create mailto link
            const mailtoLink = `mailto:${memberEmail}?subject=${subject}&body=${emailBody}`;
            
            // Show confirmation dialog
            const confirmMessage = `Send professional MBC member introduction email to ${memberName} at ${memberCompany}?\n\nThe email will include:\n MBC member verification\n Professional introduction template\n Your contact information\n Meeting request`;
            
            if (confirm(confirmMessage)) {
                // Open email client
                window.location.href = mailtoLink;
                
                // Log the interaction (in real app, this would save to database)
                logEmailInteraction(memberEmail, memberName, memberCompany);
                
                // Show success message
                setTimeout(() => {
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: rgba(40, 167, 69, 0.9);
                        color: white;
                        padding: 1rem 1.5rem;
                        border-radius: 8px;
                        z-index: 1000;
                        max-width: 300px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    `;
                    successDiv.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 0.5rem;"> Email Opened</div>
                        <div style="font-size: 0.9rem;">Professional MBC introduction email created for ${memberName}</div>
                    `;
                    document.body.appendChild(successDiv);
                    
                    setTimeout(() => {
                        successDiv.remove();
                    }, 5000);
                }, 1000);
            }
        }

        function logEmailInteraction(memberEmail, memberName, memberCompany) {
            // Save email interaction to localStorage for analytics
            const interactions = JSON.parse(localStorage.getItem('emailInteractions') || '[]');
            
            interactions.push({
                recipientEmail: memberEmail,
                recipientName: memberName,
                recipientCompany: memberCompany,
                timestamp: new Date().toISOString(),
                type: 'mbc_introduction_email'
            });
            
            // Keep only last 50 interactions
            if (interactions.length > 50) {
                interactions.splice(0, interactions.length - 50);
            }
            
            localStorage.setItem('emailInteractions', JSON.stringify(interactions));
        }

        // Enhanced Smart Match Email Integration
        function sendSmartIntro(memberId, memberName) {
            // Get member data for smart intro
            const members = [
                { id: 'april', email: 'april@retailu.ca', company: 'Ask April AI Coaching' },
                { id: 'joy', email: 'sabral@me.com', company: 'Owner Retail' }
            ];
            
            const member = members.find(m => m.id === memberId);
            if (member) {
                sendMBCEmail(member.email, memberName, member.company);
            }
        }

        // Referral System Functionality
        function copyReferralLink() {
            const linkInput = document.getElementById('referralLinkInput');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(linkInput.value);
            
            const copyBtn = document.querySelector('.copy-link-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = ' Copied!';
            copyBtn.style.background = '#51cf66';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.background = '#C9A86A';
            }, 2000);
        }

        // Show invite modal
        function showInviteModal() {
            document.getElementById('inviteModal').classList.add('active');
            // Reset form
            document.getElementById('inviteForm').reset();
            document.getElementById('inviteStatus').style.display = 'none';
        }

        // Close invite modal
        function closeInviteModal() {
            document.getElementById('inviteModal').classList.remove('active');
        }

        // Send invitation via API
        async function sendInvitation(event) {
            event.preventDefault();

            const memberAuth = JSON.parse(sessionStorage.getItem('memberAuth') || '{}');
            const memberEmail = memberAuth.email;

            if (!memberEmail) {
                showInviteError('You must be logged in to send invitations');
                return;
            }

            const inviteeEmail = document.getElementById('inviteeEmail').value;
            const inviteeName = document.getElementById('inviteeName').value;
            const personalMessage = document.getElementById('personalMessage').value;

            // Disable send button
            const sendBtn = document.getElementById('sendInviteBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            try {
                const response = await fetch('/api/send-referral-invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        memberEmail: memberEmail,
                        inviteeEmail: inviteeEmail,
                        inviteeName: inviteeName || null,
                        invitationMethod: 'email',
                        personalMessage: personalMessage || null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to send invitation');
                }

                // Success!
                showInviteSuccess(`Invitation sent successfully to ${inviteeEmail}!`);

                // Update stats on page
                if (data.stats) {
                    document.getElementById('totalInvites').textContent = data.stats.invites_sent;
                    document.getElementById('successfulReferrals').textContent = data.stats.successful_referrals;
                    document.getElementById('memberPoints').textContent = data.stats.total_points + ' pts';

                    const conversionRate = data.stats.invites_sent > 0
                        ? Math.round((data.stats.successful_referrals / data.stats.invites_sent) * 100)
                        : 0;
                    document.getElementById('conversionRate').textContent = conversionRate + '%';
                }

                // Close modal after 2 seconds
                setTimeout(() => {
                    closeInviteModal();
                }, 2000);

            } catch (error) {
                console.error('Error sending invitation:', error);
                showInviteError(error.message || 'Failed to send invitation. Please try again.');
            } finally {
                // Re-enable send button
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Invitation';
            }
        }

        function showInviteSuccess(message) {
            const statusEl = document.getElementById('inviteStatus');
            statusEl.className = 'invite-status success';
            statusEl.textContent = ' ' + message;
            statusEl.style.display = 'block';
        }

        function showInviteError(message) {
            const statusEl = document.getElementById('inviteStatus');
            statusEl.className = 'invite-status error';
            statusEl.textContent = ' ' + message;
            statusEl.style.display = 'block';
        }

        // Legacy email share (opens email client with template)
        function shareViaEmail() {
            const memberAuth = JSON.parse(sessionStorage.getItem('memberAuth') || '{}');
            const currentUserName = memberAuth.name || 'MBC Member';
            const referralLink = document.getElementById('referralLinkInput').value;

            const subject = encodeURIComponent(`Join Miami Business Council - Invitation from ${currentUserName}`);
            const body = encodeURIComponent(`Hi there!

I wanted to personally invite you to join the Miami Business Council, Miami's premier networking organization for business leaders.

As a current member, I can tell you that MBC has been instrumental in growing my network and business opportunities. Here's what makes it special:

 AI-powered smart matching with ideal business partners
 Direct member-to-member communication platform
 Monthly networking events with high-quality attendees
 Exclusive member directory and collaboration opportunities
 Professional development and speaking opportunities

JOIN HERE: ${referralLink}

When you join through my referral link, you'll get:
 Priority access to upcoming events
 Direct introduction to relevant members
 Access to our exclusive member portal

I'd be happy to introduce you to other members who align with your business goals once you join.

Best regards,
${currentUserName}
Miami Business Council Member

P.S. - The member portal has some amazing features including smart matching and direct messaging that have really helped me connect with the right people.`);

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        function shareOnLinkedIn() {
            const memberAuth = JSON.parse(sessionStorage.getItem('memberAuth') || '{}');
            const currentUserName = memberAuth.name || 'MBC Member';
            const referralLink = document.getElementById('referralLinkInput').value;
            
            const text = encodeURIComponent(`I'm excited to be part of Miami Business Council, where AI-powered networking meets real business growth! 

If you're a Miami business leader looking to:
 Connect with ideal clients & partners through smart matching
 Access exclusive networking events
 Join a curated community of entrepreneurs

You should check this out: ${referralLink}

The member portal is incredibly well-designed with features like direct messaging and intelligent business matching. It's like LinkedIn but specifically for Miami's business community.

#MiamiBusinessCouncil #Networking #BusinessGrowth #Miami #Entrepreneurship`);
            
            const linkedInUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(referralLink)}&text=${text}`;
            window.open(linkedInUrl, '_blank');
            updateInviteStats();
        }

        function shareViaSMS() {
            const memberAuth = JSON.parse(sessionStorage.getItem('memberAuth') || '{}');
            const currentUserName = memberAuth.name || 'MBC Member';
            const referralLink = document.getElementById('referralLinkInput').value;
            
            const message = encodeURIComponent(`Hey! I'm a member of Miami Business Council and thought you'd be interested. It's an exclusive networking org for Miami business leaders with AI-powered matching and great events. Check it out: ${referralLink} - ${currentUserName}`);
            
            window.location.href = `sms:?body=${message}`;
            updateInviteStats();
        }

        function shareGeneric() {
            const referralLink = document.getElementById('referralLinkInput').value;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join Miami Business Council',
                    text: 'Join Miami\'s premier business networking organization with AI-powered matching and exclusive events.',
                    url: referralLink
                });
            } else {
                copyReferralLink();
                alert('Referral link copied to clipboard! Share it with potential members.');
            }
            updateInviteStats();
        }

        // Removed updateInviteStats() - now using database tracking via API

        function claimReward(rewardType) {
            const currentPoints = parseInt(document.getElementById('memberPoints').textContent);
            let cost, rewardName, message;
            
            switch(rewardType) {
                case 'speaking':
                    cost = 500;
                    rewardName = 'Speaking Opportunity';
                    message = 'Speaking slot reserved! We\'ll contact you about upcoming event opportunities.';
                    break;
                case 'affiliate':
                    cost = 300;
                    rewardName = 'Affiliate Commission';
                    message = 'Affiliate program activated! You\'ll now earn 20% commission on successful referrals.';
                    break;
                default:
                    return;
            }
            
            if (currentPoints >= cost) {
                if (confirm(`Claim ${rewardName} for ${cost} points?\n\nThis will deduct ${cost} points from your account.`)) {
                    // Deduct points
                    const newPoints = currentPoints - cost;
                    document.getElementById('memberPoints').textContent = newPoints + ' pts';
                    
                    // Save to localStorage
                    localStorage.setItem('memberPoints', newPoints);
                    
                    // Show success message
                    alert(` ${rewardName} claimed successfully!\n\n${message}\n\nRemaining points: ${newPoints}`);
                    
                    // Update reward card to claimed state
                    const rewardCard = event.target.closest('.reward-card');
                    const claimBtn = rewardCard.querySelector('.claim-reward-btn');
                    claimBtn.textContent = 'Claimed ';
                    claimBtn.disabled = true;
                    claimBtn.style.background = '#51cf66';
                    claimBtn.style.color = '#000';
                }
            } else {
                alert(`Not enough points! You need ${cost} points but only have ${currentPoints} points.\n\nEarn more points by referring new members (100 points each).`);
            }
        }

        function initializeReferralSystem() {
            // Load saved stats
            const stats = JSON.parse(localStorage.getItem('referralStats') || '{"totalInvites": 12, "successfulReferrals": 3}');
            document.getElementById('totalInvites').textContent = stats.totalInvites;
            document.getElementById('successfulReferrals').textContent = stats.successfulReferrals;
            
            const conversionRate = Math.round((stats.successfulReferrals / stats.totalInvites) * 100);
            document.getElementById('conversionRate').textContent = conversionRate + '%';
            
            // Load saved points
            const points = localStorage.getItem('memberPoints') || '250';
            document.getElementById('memberPoints').textContent = points + ' pts';
            
            // Generate unique referral code based on member info
            const memberAuth = JSON.parse(sessionStorage.getItem('memberAuth') || '{}');
            if (memberAuth.name) {
                const initials = memberAuth.name.split(' ').map(n => n[0]).join('');
                const year = new Date().getFullYear();
                const referralCode = `${initials}${year}`;
                document.getElementById('referralLinkInput').value = `https://miamibusinesscouncil.com/join?ref=${referralCode}`;
            }
        }

        // PWA Functionality
        let deferredPrompt;
        let isIOS = false;
        let isInStandaloneMode = false;

        // Check if device is iOS
        function checkIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        // Check if app is in standalone mode
        function checkStandaloneMode() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone ||
                   document.referrer.includes('android-app://');
        }

        // Register Service Worker - DISABLED TO FIX CACHING
        async function registerServiceWorker() {
            // console.log(' Service Worker registration DISABLED - using direct server requests');
            return; // Exit early - no service worker

            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    // console.log('[PWA] Service Worker registered:', registration);
                    
                    // Listen for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                showUpdateAvailable();
                            }
                        });
                    });
                    
                    return registration;
                } catch (error) {
                    console.error('[PWA] Service Worker registration failed:', error);
                }
            }
        }

        // Show PWA install prompt
        function showInstallPrompt() {
            const banner = document.getElementById('pwaInstallBanner');
            const installBtn = document.getElementById('pwaInstallBtn');
            const dismissBtn = document.getElementById('pwaDismissBtn');
            const closeBtn = document.getElementById('pwaCloseBtn');
            
            // Don't show if already dismissed or installed
            if (localStorage.getItem('pwaInstallDismissed') || isInStandaloneMode) {
                return;
            }

            // Show banner
            banner.style.display = 'block';
            
            // Handle install button
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    // console.log('[PWA] Install prompt outcome:', outcome);
                    
                    if (outcome === 'accepted') {
                        localStorage.setItem('pwaInstalled', 'true');
                    }
                    deferredPrompt = null;
                } else if (isIOS) {
                    // Show iOS install instructions
                    showIOSInstallInstructions();
                }
                banner.style.display = 'none';
            });
            
            // Handle dismiss button
            dismissBtn.addEventListener('click', () => {
                banner.style.display = 'none';
                localStorage.setItem('pwaInstallDismissed', Date.now());
            });

            // Handle close button (X)
            closeBtn.addEventListener('click', () => {
                banner.style.display = 'none';
                localStorage.setItem('pwaInstallDismissed', Date.now());
            });
        }

        // Show iOS install instructions
        function showIOSInstallInstructions() {
            const message = `To install MBC Portal on your iPhone:

1. Tap the Share button (square with arrow up)
2. Scroll down and tap "Add to Home Screen"
3. Tap "Add" to install the app

You'll then have quick access to chat with members and manage your business connections!`;
            
            alert(message);
        }

        // Show update available notification
        function showUpdateAvailable() {
            const updateDiv = document.createElement('div');
            updateDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #C9A86A;
                color: #000;
                padding: 1rem;
                border-radius: 8px;
                z-index: 1000;
                max-width: 300px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            updateDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.5rem;"> Update Available</div>
                <div style="font-size: 0.9rem; margin-bottom: 1rem;">A new version of MBC Portal is available with improvements and new features.</div>
                <button onclick="location.reload()" style="background: #000; color: #C9A86A; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">Update Now</button>
                <button onclick="this.parentElement.remove()" style="background: rgba(0,0,0,0.1); border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Later</button>
            `;
            document.body.appendChild(updateDiv);
            
            setTimeout(() => {
                if (updateDiv.parentElement) {
                    updateDiv.remove();
                }
            }, 10000);
        }

        // Request notification permission
        async function requestNotificationPermission() {
            if ('Notification' in window && 'serviceWorker' in navigator) {
                const permission = await Notification.requestPermission();
                // console.log('[PWA] Notification permission:', permission);
                
                if (permission === 'granted') {
                    // Subscribe to push notifications
                    subscribeToNotifications();
                }
                
                return permission;
            }
            return 'not-supported';
        }

        // Subscribe to push notifications
        async function subscribeToNotifications() {
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: null // Would use actual VAPID key in production
                });
                // console.log('[PWA] Push subscription:', subscription);
                
                // Send subscription to server (would implement in production)
                // await sendSubscriptionToServer(subscription);
            } catch (error) {
                console.error('[PWA] Push subscription failed:', error);
            }
        }

        // Mobile navigation toggle
        function initializeMobileNavigation() {
            // Create mobile menu toggle button
            const header = document.querySelector('.portal-header');
            const sidebar = document.querySelector('.sidebar');
            
            // Add mobile menu button to header on mobile
            if (window.innerWidth <= 768) {
                const mobileMenuBtn = document.createElement('button');
                mobileMenuBtn.innerHTML = '';
                mobileMenuBtn.style.cssText = `
                    background: none;
                    border: none;
                    color: #C9A86A;
                    font-size: 1.5rem;
                    cursor: pointer;
                    display: block;
                `;
                
                mobileMenuBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('mobile-open');
                });
                
                // Insert at beginning of header content
                const headerContent = document.querySelector('.header-content');
                headerContent.insertBefore(mobileMenuBtn, headerContent.firstChild);
                
                // Close menu when clicking nav items
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        sidebar.classList.remove('mobile-open');
                    });
                });
            }
        }

        // Enhanced chat for mobile
        function initializeMobileChat() {
            const chatSidebar = document.querySelector('.chat-sidebar');
            const chatMain = document.querySelector('.chat-main');
            
            if (window.innerWidth <= 768 && chatSidebar && chatMain) {
                // Add back button to chat header
                const chatHeader = document.getElementById('chatHeader');
                if (chatHeader) {
                    const backBtn = document.createElement('button');
                    backBtn.innerHTML = ' Back';
                    backBtn.style.cssText = `
                        background: rgba(255,255,255,0.1);
                        border: none;
                        color: #e8eaed;
                        padding: 0.5rem;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-right: 1rem;
                    `;
                    
                    backBtn.addEventListener('click', () => {
                        chatSidebar.classList.add('mobile-open');
                        document.getElementById('chatArea').style.display = 'none';
                        document.getElementById('chatPlaceholder').style.display = 'flex';
                    });
                }
            }
        }

        // Initialize PWA features
        function initializePWA() {
            isIOS = checkIOS();
            isInStandaloneMode = checkStandaloneMode();
            
            // console.log('[PWA] iOS:', isIOS, 'Standalone:', isInStandaloneMode);
            
            // Register service worker
            registerServiceWorker();
            
            // Listen for install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                // console.log('[PWA] Install prompt available');
                e.preventDefault();
                deferredPrompt = e;
                
                // Show custom install prompt after delay
                setTimeout(() => {
                    showInstallPrompt();
                }, 3000);
            });
            
            // Handle app installed
            window.addEventListener('appinstalled', () => {
                // console.log('[PWA] App installed successfully');
                localStorage.setItem('pwaInstalled', 'true');
                
                // Hide install banner if showing
                const banner = document.getElementById('pwaInstallBanner');
                if (banner) banner.style.display = 'none';
                
                // Request notification permission after install
                setTimeout(() => {
                    requestNotificationPermission();
                }, 2000);
            });
            
            // Show install prompt for iOS or other browsers after delay
            if (!isInStandaloneMode && !localStorage.getItem('pwaInstallDismissed')) {
                setTimeout(() => {
                    showInstallPrompt();
                }, 5000);
            }
            
            // Initialize mobile features
            initializeMobileNavigation();
            initializeMobileChat();
        }

        // Portal Preview and Screenshot Functionality
        function generatePortalPreview() {
            // Create a preview modal showing the portal in action
            const previewModal = document.createElement('div');
            previewModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            previewModal.innerHTML = `
                <div style="background: rgba(255,255,255,0.1); border-radius: 20px; padding: 2rem; max-width: 90vw; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: #C9A86A; margin: 0;"> Portal Preview Gallery</h2>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;"></button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                        <!-- Dashboard Preview -->
                        <div style="text-align: center;">
                            <h3 style="color: #e8eaed; margin-bottom: 1rem;"> Dashboard</h3>
                            <div style="background: linear-gradient(135deg, #0a0a0b 0%, #1a1a1b 100%); border-radius: 12px; padding: 1rem; border: 1px solid rgba(212, 175, 55, 0.2);">
                                <div style="height: 200px; display: flex; align-items: center; justify-content: center; color: #C9A86A;">
                                    <div>
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                                        <div>Member Dashboard</div>
                                        <div style="font-size: 0.8rem; opacity: 0.7;">Events  Stats  Quick Actions</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Smart Matches Preview -->
                        <div style="text-align: center;">
                            <h3 style="color: #e8eaed; margin-bottom: 1rem;"> Smart Matches</h3>
                            <div style="background: linear-gradient(135deg, #0a0a0b 0%, #1a1a1b 100%); border-radius: 12px; padding: 1rem; border: 1px solid rgba(212, 175, 55, 0.2);">
                                <div style="height: 200px; display: flex; align-items: center; justify-content: center; color: #C9A86A;">
                                    <div>
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                                        <div>AI-Powered Matching</div>
                                        <div style="font-size: 0.8rem; opacity: 0.7;">Find Ideal Clients  Partners</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Preview -->
                        <div style="text-align: center;">
                            <h3 style="color: #e8eaed; margin-bottom: 1rem;"> Messages</h3>
                            <div style="background: linear-gradient(135deg, #0a0a0b 0%, #1a1a1b 100%); border-radius: 12px; padding: 1rem; border: 1px solid rgba(212, 175, 55, 0.2);">
                                <div style="height: 200px; display: flex; align-items: center; justify-content: center; color: #C9A86A;">
                                    <div>
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                                        <div>Direct Member Chat</div>
                                        <div style="font-size: 0.8rem; opacity: 0.7;">Real-time Messaging</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Directory Preview -->
                        <div style="text-align: center;">
                            <h3 style="color: #e8eaed; margin-bottom: 1rem;"> Directory</h3>
                            <div style="background: linear-gradient(135deg, #0a0a0b 0%, #1a1a1b 100%); border-radius: 12px; padding: 1rem; border: 1px solid rgba(212, 175, 55, 0.2);">
                                <div style="height: 200px; display: flex; align-items: center; justify-content: center; color: #C9A86A;">
                                    <div>
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                                        <div>Member Directory</div>
                                        <div style="font-size: 0.8rem; opacity: 0.7;">Search  Connect  Email</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Referral System Preview -->
                        <div style="text-align: center;">
                            <h3 style="color: #e8eaed; margin-bottom: 1rem;"> Referrals</h3>
                            <div style="background: linear-gradient(135deg, #0a0a0b 0%, #1a1a1b 100%); border-radius: 12px; padding: 1rem; border: 1px solid rgba(212, 175, 55, 0.2);">
                                <div style="height: 200px; display: flex; align-items: center; justify-content: center; color: #C9A86A;">
                                    <div>
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                                        <div>Invite & Earn</div>
                                        <div style="font-size: 0.8rem; opacity: 0.7;">Rewards  Speaking Slots</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile App Preview -->
                        <div style="text-align: center;">
                            <h3 style="color: #e8eaed; margin-bottom: 1rem;"> Mobile App</h3>
                            <div style="background: linear-gradient(135deg, #0a0a0b 0%, #1a1a1b 100%); border-radius: 12px; padding: 1rem; border: 1px solid rgba(212, 175, 55, 0.2);">
                                <div style="height: 200px; display: flex; align-items: center; justify-content: center; color: #C9A86A;">
                                    <div>
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                                        <div>Progressive Web App</div>
                                        <div style="font-size: 0.8rem; opacity: 0.7;">Install  Offline  Notifications</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; text-align: center;">
                        <button onclick="sharePortalPreview()" style="background: #C9A86A; color: #000; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; margin: 0.5rem;">
                             Share Preview
                        </button>
                        <button onclick="downloadPreviewInstructions()" style="background: rgba(255,255,255,0.1); color: #e8eaed; border: 1px solid rgba(255,255,255,0.2); padding: 1rem 2rem; border-radius: 8px; font-weight: 500; cursor: pointer; margin: 0.5rem;">
                             Screenshot Guide
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(previewModal);
        }

        // Share portal preview functionality
        function sharePortalPreview() {
            const shareText = ` Check out the Miami Business Council Member Portal!

Features include:
 AI-powered smart business matching
 Direct member-to-member messaging  
 Comprehensive member directory
 Referral system with rewards
 Mobile app (PWA) functionality
 Analytics and networking insights

Perfect for Miami business leaders looking to grow their network and find ideal clients!

#MiamiBusinessCouncil #Networking #BusinessGrowth #AI #Miami`;

            if (navigator.share) {
                navigator.share({
                    title: 'Miami Business Council Member Portal',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText + '\\n\\n' + window.location.href).then(() => {
                    alert('Preview description copied to clipboard!');
                });
            }
        }

        // Download instructions for taking screenshots
        function downloadPreviewInstructions() {
            const instructions = ` PORTAL SCREENSHOT GUIDE

To create professional preview images for the MBC Portal:

DESKTOP SCREENSHOTS (1280x720):
1. Dashboard View: Show main dashboard with cards and navigation
2. Smart Matches: Display the AI matching interface with member matches
3. Member Directory: Show the searchable member directory
4. Chat Interface: Display the messaging system in action

MOBILE SCREENSHOTS (750x1334):
1. Mobile Dashboard: Vertical layout on phone
2. Chat Mobile: Mobile messaging interface
3. Mobile Navigation: Show the slide-out menu
4. PWA Install: Show the install prompt

TIPS FOR GREAT SCREENSHOTS:
 Use full browser window at specified dimensions
 Hide personal/test data - use sample member names
 Show the portal in its best state (populated with data)
 Use consistent lighting and clear text
 Show interactive elements like hover states
 Include the gold accent colors prominently

TOOLS RECOMMENDED:
 Browser DevTools device simulator
 Screenshotting tools: Cleanshot X, Snagit, or built-in browser tools
 Image editing: Figma, Canva, or Photoshop for final touches

Once created, save as:
 /Images/portal-preview-desktop.png
 /Images/portal-preview-mobile.png  
 /Images/portal-smart-matches.png
 /Images/portal-member-directory.png
 /Images/portal-preview.png (main social sharing image)

This will enable beautiful previews when sharing the portal link on social media and in the mobile app store!`;

            // Create downloadable text file
            const blob = new Blob([instructions], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'MBC-Portal-Screenshot-Guide.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Hidden admin function - add to browser console for preview generation
        window.generatePortalScreenshots = function() {
            // console.log('%c MBC Portal Screenshot Mode', 'color: #C9A86A; font-size: 16px; font-weight: bold;');
            // console.log('Use these browser dimensions for optimal screenshots:');
            // console.log('Desktop: 1280x720 (16:9)');
            // console.log('Mobile: 750x1334 (iPhone)');
            // console.log('Take screenshots of each section for the preview gallery.');
            
            // Add visual guidelines
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(212, 175, 55, 0.1);
                border: 3px dashed #C9A86A;
                pointer-events: none;
                z-index: 9999;
            `;
            
            const label = document.createElement('div');
            label.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #C9A86A;
                color: #000;
                padding: 1rem;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                pointer-events: auto;
                cursor: pointer;
            `;
            label.textContent = ' Screenshot Mode (Click to Exit)';
            label.onclick = () => {
                overlay.remove();
                label.remove();
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(label);
            
            setTimeout(() => {
                overlay.remove();
                label.remove();
            }, 10000);
        };

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setupPhotoUpload();
            initializeChatSystem();
            initializePrivacySettings();
            initializeReferralSystem();
            initializePWA();
        });
    </script>

    <script>
        // Enhanced member data loading from Supabase
        async function loadMembersFromDatabase() {
            try {
                // console.log('Loading members from Supabase database...');
                
                const { data: members, error } = await supabase
                    .from('members')
                    .select(`
                        *,
                        business_opportunities (
                            opportunity_type,
                            category
                        )
                    `)
                    .eq('is_active', true);

                if (error) {
                    console.error('Supabase error:', error);
                    return getHardcodedMembers();
                }

                // console.log(`Loaded ${members.length} members from database`);
                
                // Transform database format to portal format
                return members.map(member => {
                    const lookingFor = member.business_opportunities
                        ?.filter(opp => opp.opportunity_type === 'looking_for')
                        ?.map(opp => opp.category) || [];

                    const canOffer = member.business_opportunities
                        ?.filter(opp => opp.opportunity_type === 'can_offer')
                        ?.map(opp => opp.category) || [];

                    const firstName = member.first_name || '';
                    const lastName = member.last_name || '';
                    const initials = lastName ? `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase() : `${firstName.charAt(0)}${firstName.charAt(1) || ''}`.toUpperCase();

                    // Handle industries - support both new array format and old single format
                    let industries = [];
                    if (member.industries && Array.isArray(member.industries)) {
                        industries = member.industries;
                    } else if (member.industries && typeof member.industries === 'string') {
                        try {
                            industries = JSON.parse(member.industries);
                        } catch {
                            industries = member.industries ? [member.industries] : [];
                        }
                    } else if (member.industry) {
                        industries = [member.industry];
                    }

                    const memberObj = {
                        id: member.id,
                        name: `${firstName} ${lastName}`.trim(),
                        firstName: firstName,
                        lastName: lastName,
                        title: member.job_title || '',
                        company: member.company_name || '',
                        industry: member.industry || industries[0] || 'Business',
                        industries: industries, // Array of industries
                        avatar: initials,
                        photoUrl: member.profile_photo_url || null,
                        companyLogoUrl: member.company_logo_url || null,
                        email: member.email,
                        lookingFor,
                        canOffer,
                        linkedin: member.linkedin_url,
                        score: 0 // Will be calculated based on match compatibility
                    };

                    // Calculate real match score if currentMember is loaded
                    if (currentMember && member.id !== currentMember.id) {
                        memberObj.score = calculateMatchScore(memberObj);
                    }

                    return memberObj;
                });
                
            } catch (error) {
                console.error('Error loading members from database:', error);
                return getHardcodedMembers();
            }
        }

        // Calculate match score between current member and another member (0-100)
        function calculateMatchScore(otherMember) {
            try {
                if (!currentMember || !otherMember) return 0;

                let score = 50; // Base score

                // Get current member's opportunities from their profile in memory
                const myLookingFor = currentMember.business_opportunities
                    ?.filter(opp => opp.opportunity_type === 'looking_for')
                    ?.map(opp => opp.category) || [];

                const myCanOffer = currentMember.business_opportunities
                    ?.filter(opp => opp.opportunity_type === 'can_offer')
                    ?.map(opp => opp.category) || [];

                // Check if what I'm looking for matches what they can offer
                const theyCanOfferWhatINeed = otherMember.canOffer.filter(category =>
                    myLookingFor.includes(category)
                ).length;

                // Check if what they're looking for matches what I can offer
                const ICanOfferWhatTheyNeed = otherMember.lookingFor.filter(category =>
                    myCanOffer.includes(category)
                ).length;

                // Boost score based on mutual matches
                score += (theyCanOfferWhatINeed * 15); // +15 per category match
                score += (ICanOfferWhatTheyNeed * 15); // +15 per category match

                // Industry match bonus
                if (currentMember.industry && otherMember.industry === currentMember.industry) {
                    score += 10;
                }

                // Cap at 99
                return Math.min(99, score);
            } catch (error) {
                console.error('Error calculating match score:', error);
                return 50; // Default score on error
            }
        }

        // Enhanced business matching with real data
        async function generateMatchesFromDatabase() {
            try {
                const response = await fetch('/api/business-matching', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        member_id: 'current-user-id', // This would be the logged-in user
                        looking_for: Array.from(document.querySelectorAll('.opportunity-section:first-child .opportunity-tag.active')).map(tag => tag.textContent),
                        can_offer: Array.from(document.querySelectorAll('.opportunity-section:nth-child(2) .opportunity-tag.active')).map(tag => tag.textContent),
                        limit: 10
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.data;
                } else {
                    console.error('Failed to fetch matches from database');
                    return generateMatches(); // Fallback to client-side matching
                }
            } catch (error) {
                console.error('Error fetching matches:', error);
                return generateMatches(); // Fallback to client-side matching
            }
        }

        // Enhanced member connection with database
        async function connectWithMemberDatabase(memberName, memberId) {
            try {
                const response = await fetch('/api/connections', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        requester_id: 'current-user-id', // This would be the logged-in user
                        recipient_id: memberId,
                        message: `Hi ${memberName}, I'd like to connect with you through Miami Business Council.`
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Connection request sent to ${memberName}! They'll receive an email notification.`);
                } else {
                    const error = await response.json();
                    alert(`Failed to send connection: ${error.error}`);
                }
            } catch (error) {
                console.error('Error sending connection:', error);
                alert(`Error sending connection request. Please try again.`);
            }
        }

        // Enhanced profile saving with database
        // REMOVED: Old broken saveProfileToDatabase function that caused infinite loop

        // Fallback function for hardcoded members (when database not connected)
        function getHardcodedMembers() {
            // No longer returning hardcoded fake members - use real database data only
            return [];
        }

        // Update existing functions to use database when available
        // Override generateMatches to try database first
        const originalGenerateMatches = generateMatches;
        generateMatches = async function() {
            try {
                const databaseMatches = await generateMatchesFromDatabase();
                if (databaseMatches && databaseMatches.length > 0) {
                    return databaseMatches;
                }
            } catch (error) {
                // console.log('Using fallback matching algorithm');
            }
            return originalGenerateMatches();
        };

        // Override connectWithMember to try database first
        const originalConnectWithMember = connectWithMember;
        connectWithMember = async function(memberName, memberId = null) {
            if (memberId) {
                await connectWithMemberDatabase(memberName, memberId);
            } else {
                originalConnectWithMember(memberName);
            }
        };

        // Override saveProfile to try database first
        const originalSaveProfile = saveProfile;
        saveProfile = async function() {
            try {
                await saveProfileToDatabase();
            } catch (error) {
                // console.log('Using fallback profile saving');
                originalSaveProfile();
            }
        };

        // Initialize database connection when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadMembersFromDatabase().then(members => {
                // console.log(`Loaded ${members.length} members from database`);
                // Update member directory with real data
                updateMemberDirectory(members);
                // Update dashboard member counts
                updateMemberCounts(members.length);
            });
        });

        // Update member directory with database members
        function updateMemberDirectory(members) {
            const memberGrid = document.querySelector('.member-grid');
            if (!memberGrid || members.length === 0) return;

            const memberCardsHtml = members.map(member => {
                const tags = [...(member.lookingFor || []), ...(member.canOffer || [])].slice(0, 3);
                const tagsArray = tags.map(tag => `'${tag}'`).join(', ');

                // Create arrays for business interests
                const lookingForArray = (member.lookingFor || []).map(item => `'${item}'`).join(', ');
                const canOfferArray = (member.canOffer || []).map(item => `'${item}'`).join(', ');

                return `
                <div class="member-card" onclick="openMemberProfile('${member.id}', '${member.name}', '${member.title}', '${member.company}', '${member.avatar}', [${tagsArray}], '${member.email}', ${member.linkedin ? `'${member.linkedin}'` : 'null'}, ${member.photoUrl ? `'${member.photoUrl}'` : 'null'}, [${lookingForArray}], [${canOfferArray}])">
                    <div class="member-header">
                        ${member.photoUrl
                            ? `<img src="${member.photoUrl}" alt="${member.name}" class="member-avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">`
                            : `<div class="member-avatar">${member.avatar}</div>`
                        }
                        <div class="member-info">
                            <h3>${member.name}</h3>
                            ${member.title ? `<p>${member.title}</p>` : ''}
                            <p>${member.company || 'Miami Business Council'}</p>
                        </div>
                    </div>
                    ${member.companyLogoUrl ? `
                    <div style="display: flex; justify-content: center; margin: 1rem 0;">
                        <img src="${member.companyLogoUrl}" alt="${member.company} logo" style="max-width: 100px; max-height: 50px; object-fit: contain; border-radius: 4px;">
                    </div>
                    ` : ''}
                    <div class="member-details">
                        ${member.industries && member.industries.length > 0
                            ? member.industries.map(industry => `<span class="member-tag" style="background: rgba(212, 175, 55, 0.2); color: #C9A86A; border: 1px solid rgba(212, 175, 55, 0.3);">${industry}</span>`).join('')
                            : ''
                        }
                        ${tags.map(tag => `<span class="member-tag">${tag}</span>`).join('')}
                    </div>
                </div>
                `;
            }).join('');

            memberGrid.innerHTML = memberCardsHtml;
        }

        // Update member counts in dashboard stats
        function updateMemberCounts(memberCount) {
            // Update total member count in regular member dashboard
            const totalMemberCountElement = document.getElementById('totalMemberCount');
            if (totalMemberCountElement) {
                totalMemberCountElement.textContent = memberCount;
            }

            // Update total member count in admin dashboard
            const adminTotalMemberCountElement = document.getElementById('adminTotalMemberCount');
            if (adminTotalMemberCountElement) {
                adminTotalMemberCountElement.textContent = memberCount;
            }
        }

        // ========================================
        // COMPREHENSIVE MEMBER DIRECTORY SYSTEM
        // ========================================

        let allMembers = []; // Store all members
        let filteredMembers = []; // After filtering
        let currentPage = 1;
        const membersPerPage = 20;
        let currentViewMode = 'grid'; // 'grid' or 'list'
        let currentFilters = {
            search: '',
            industry: 'all',
            sortBy: 'name-asc'
        };

        // Search members (real-time)
        function searchMembers() {
            const searchInput = document.getElementById('memberSearchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            currentFilters.search = searchInput.value.toLowerCase().trim();

            // Show/hide clear button
            clearBtn.style.display = currentFilters.search.length > 0 ? 'flex' : 'none';

            currentPage = 1; // Reset to first page
            applyFilters();
        }

        // Clear search
        function clearMemberSearch() {
            document.getElementById('memberSearchInput').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            currentFilters.search = '';
            currentPage = 1;
            applyFilters();
        }

        // Apply all filters and update display
        function applyFilters() {
            const industryFilter = document.getElementById('industryFilterSelect').value;
            const sortBy = document.getElementById('sortSelect').value;

            currentFilters.industry = industryFilter;
            currentFilters.sortBy = sortBy;

            // Filter members
            filteredMembers = allMembers.filter(member => {
                // Search filter
                if (currentFilters.search) {
                    const searchStr = `${member.name} ${member.company} ${member.industries.join(' ')}`.toLowerCase();
                    if (!searchStr.includes(currentFilters.search)) {
                        return false;
                    }
                }

                // Industry filter
                if (currentFilters.industry !== 'all') {
                    if (!member.industries || !member.industries.includes(currentFilters.industry)) {
                        return false;
                    }
                }

                return true;
            });

            // Sort members
            filteredMembers.sort((a, b) => {
                switch (currentFilters.sortBy) {
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'company-asc':
                        return a.company.localeCompare(b.company);
                    case 'date-desc':
                        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                    case 'date-asc':
                        return new Date(a.created_at || 0) - new Date(b.created_at || 0);
                    default:
                        return 0;
                }
            });

            renderMemberDirectory();
            updatePaginationControls();
            updateResultsCount();
        }

        // Set view mode (grid or list)
        function setViewMode(mode) {
            currentViewMode = mode;

            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');

            if (mode === 'grid') {
                gridBtn.style.background = 'rgba(212, 175, 55, 0.2)';
                gridBtn.style.borderColor = '#C9A86A';
                gridBtn.style.color = '#C9A86A';
                listBtn.style.background = 'rgba(255,255,255,0.05)';
                listBtn.style.borderColor = 'rgba(255,255,255,0.1)';
                listBtn.style.color = '#ccc';
            } else {
                listBtn.style.background = 'rgba(212, 175, 55, 0.2)';
                listBtn.style.borderColor = '#C9A86A';
                listBtn.style.color = '#C9A86A';
                gridBtn.style.background = 'rgba(255,255,255,0.05)';
                gridBtn.style.borderColor = 'rgba(255,255,255,0.1)';
                gridBtn.style.color = '#ccc';
            }

            renderMemberDirectory();
        }

        // Change page
        function changePage(direction) {
            const totalPages = Math.ceil(filteredMembers.length / membersPerPage);
            currentPage += direction;

            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            renderMemberDirectory();
            updatePaginationControls();

            // Scroll to top of directory
            document.getElementById('memberDirectoryContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // Go to specific page
        function goToPage(page) {
            currentPage = page;
            renderMemberDirectory();
            updatePaginationControls();
            document.getElementById('memberDirectoryContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // Render member directory
        function renderMemberDirectory() {
            const container = document.getElementById('memberDirectoryContainer');
            if (!container) return;

            // Calculate pagination
            const startIndex = (currentPage - 1) * membersPerPage;
            const endIndex = startIndex + membersPerPage;
            const membersToShow = filteredMembers.slice(startIndex, endIndex);

            if (membersToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #ccc;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <h3>No members found</h3>
                        <p>Try adjusting your search or filters</p>
                    </div>
                `;
                return;
            }

            // Set container class based on view mode
            container.className = currentViewMode === 'grid' ? 'member-grid' : 'member-list';

            // Generate member cards
            const memberCardsHtml = membersToShow.map(member => {
                const tags = member.industries || [];
                const tagsArray = tags.map(tag => `'${tag}'`).join(', ');

                // Create arrays for business interests
                const lookingForArray = (member.lookingFor || []).map(item => `'${item}'`).join(', ');
                const canOfferArray = (member.canOffer || []).map(item => `'${item}'`).join(', ');

                return `
                <div class="member-card" onclick="openMemberProfile('${member.id}', '${member.name}', '${member.title}', '${member.company}', '${member.avatar}', [${tagsArray}], '${member.email}', ${member.linkedin ? `'${member.linkedin}'` : 'null'}, ${member.photoUrl ? `'${member.photoUrl}'` : 'null'}, [${lookingForArray}], [${canOfferArray}])">
                    <div class="member-header">
                        ${member.photoUrl
                            ? `<img src="${member.photoUrl}" alt="${member.name}" class="member-avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">`
                            : `<div class="member-avatar">${member.avatar}</div>`
                        }
                        <div class="member-info">
                            <h3>${member.name}</h3>
                            ${member.title ? `<p>${member.title}</p>` : ''}
                            <p>${member.company || 'Miami Business Council'}</p>
                        </div>
                    </div>
                    ${member.companyLogoUrl ? `
                    <div style="display: flex; justify-content: center; margin: 1rem 0;">
                        <img src="${member.companyLogoUrl}" alt="${member.company} logo" style="max-width: 100px; max-height: 50px; object-fit: contain; border-radius: 4px;">
                    </div>
                    ` : ''}
                    <div class="member-details">
                        ${member.industries && member.industries.length > 0
                            ? member.industries.map(industry => `<span class="member-tag" style="background: rgba(212, 175, 55, 0.2); color: #C9A86A; border: 1px solid rgba(212, 175, 55, 0.3);">${industry}</span>`).join('')
                            : ''
                        }
                    </div>
                </div>
                `;
            }).join('');

            container.innerHTML = memberCardsHtml;
        }

        // Update pagination controls
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredMembers.length / membersPerPage);
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageNumbers = document.getElementById('pageNumbers');

            // Update button states
            prevBtn.disabled = currentPage === 1;
            prevBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
            prevBtn.style.cursor = currentPage === 1 ? 'not-allowed' : 'pointer';

            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            nextBtn.style.opacity = (currentPage === totalPages || totalPages === 0) ? '0.5' : '1';
            nextBtn.style.cursor = (currentPage === totalPages || totalPages === 0) ? 'not-allowed' : 'pointer';

            // Generate page numbers
            let pageNumbersHtml = '';
            const maxPagesToShow = 7;

            if (totalPages <= maxPagesToShow) {
                // Show all pages
                for (let i = 1; i <= totalPages; i++) {
                    pageNumbersHtml += generatePageButton(i);
                }
            } else {
                // Show abbreviated pagination
                if (currentPage <= 4) {
                    for (let i = 1; i <= 5; i++) {
                        pageNumbersHtml += generatePageButton(i);
                    }
                    pageNumbersHtml += '<span style="padding: 0.75rem; color: #ccc;">...</span>';
                    pageNumbersHtml += generatePageButton(totalPages);
                } else if (currentPage >= totalPages - 3) {
                    pageNumbersHtml += generatePageButton(1);
                    pageNumbersHtml += '<span style="padding: 0.75rem; color: #ccc;">...</span>';
                    for (let i = totalPages - 4; i <= totalPages; i++) {
                        pageNumbersHtml += generatePageButton(i);
                    }
                } else {
                    pageNumbersHtml += generatePageButton(1);
                    pageNumbersHtml += '<span style="padding: 0.75rem; color: #ccc;">...</span>';
                    for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                        pageNumbersHtml += generatePageButton(i);
                    }
                    pageNumbersHtml += '<span style="padding: 0.75rem; color: #ccc;">...</span>';
                    pageNumbersHtml += generatePageButton(totalPages);
                }
            }

            pageNumbers.innerHTML = pageNumbersHtml;
        }

        // Generate page button HTML
        function generatePageButton(pageNum) {
            const isActive = pageNum === currentPage;
            return `
                <button onclick="goToPage(${pageNum})" style="
                    padding: 0.75rem 1rem;
                    background: ${isActive ? 'rgba(212, 175, 55, 0.2)' : 'rgba(255,255,255,0.05)'};
                    border: 1px solid ${isActive ? '#C9A86A' : 'rgba(255,255,255,0.1)'};
                    border-radius: 8px;
                    color: ${isActive ? '#C9A86A' : '#e8eaed'};
                    cursor: pointer;
                    font-weight: ${isActive ? '600' : '400'};
                ">
                    ${pageNum}
                </button>
            `;
        }

        // Update results count
        function updateResultsCount() {
            const countElement = document.getElementById('memberResultsCount');
            if (countElement) {
                const count = filteredMembers.length;
                countElement.textContent = `${count} member${count !== 1 ? 's' : ''}`;
            }
        }

        // Initialize member directory with data
        function initializeMemberDirectory(members) {
            allMembers = members;
            filteredMembers = [...members];
            currentPage = 1;
            renderMemberDirectory();
            updatePaginationControls();
            updateResultsCount();
        }

        // Override the existing updateMemberDirectory to use new system
        const originalUpdateMemberDirectory = updateMemberDirectory;
        updateMemberDirectory = function(members) {
            initializeMemberDirectory(members);
        };
    </script>


    <style>
    .contact-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(18, 18, 18, 0.95);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.75rem 1rem;
        z-index: 999;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    }

    .footer-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .footer-contact {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-align: center;
    }

    .contact-label {
        color: #d4d6da;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .contact-support {
        background: #C9A86A;
        color: #000;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .contact-support:hover {
        background: #B09858;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }

    .contact-note {
        color: #999;
        font-size: 0.8rem;
    }

    /* Adjust main content to account for footer */
    .portal-container {
        padding-bottom: 60px;
    }

    /* Mobile responsive */
    @media (max-width: 480px) {
        .footer-contact {
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .contact-label,
        .contact-note {
            font-size: 0.8rem;
        }

        .contact-support {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }
    }

    /* Invite Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .invite-modal {
        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        color: #C9A86A;
        margin: 0;
        font-size: 1.5rem;
    }

    .modal-close {
        background: none;
        border: none;
        color: #999;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.3s ease;
    }

    .modal-close:hover {
        color: #fff;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .invite-form-field {
        margin-bottom: 1.25rem;
    }

    .invite-form-field label {
        display: block;
        color: #ccc;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .invite-form-field input,
    .invite-form-field textarea {
        width: 100%;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: #fff;
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .invite-form-field input:focus,
    .invite-form-field textarea:focus {
        outline: none;
        border-color: #C9A86A;
        background: rgba(255, 255, 255, 0.08);
    }

    .invite-form-field textarea {
        resize: vertical;
        min-height: 80px;
    }

    .invite-form-field small {
        display: block;
        color: #999;
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .btn-modal {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        border: none;
    }

    .btn-modal-primary {
        background: #C9A86A;
        color: #000;
    }

    .btn-modal-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);
    }

    .btn-modal-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-modal-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #ccc;
    }

    .btn-modal-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    .invite-status {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
    }

    .invite-status.success {
        background: rgba(81, 207, 102, 0.1);
        border: 1px solid rgba(81, 207, 102, 0.3);
        color: #51cf66;
    }

    .invite-status.error {
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.3);
        color: #ff6b6b;
    }
    </style>

    <!-- Invite Modal -->
    <div class="modal-overlay" id="inviteModal">
        <div class="invite-modal">
            <div class="modal-header">
                <h3> Send Invitation</h3>
                <button class="modal-close" onclick="closeInviteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="invite-status" id="inviteStatus"></div>

                <form id="inviteForm" onsubmit="sendInvitation(event)">
                    <div class="invite-form-field">
                        <label for="inviteeEmail">Invitee Email Address *</label>
                        <input
                            type="email"
                            id="inviteeEmail"
                            placeholder="colleague@example.com"
                            required
                        >
                        <small>We'll send them a personalized invitation from you</small>
                    </div>

                    <div class="invite-form-field">
                        <label for="inviteeName">Invitee Name (Optional)</label>
                        <input
                            type="text"
                            id="inviteeName"
                            placeholder="John Smith"
                        >
                        <small>Makes the invitation more personal</small>
                    </div>

                    <div class="invite-form-field">
                        <label for="personalMessage">Personal Message (Optional)</label>
                        <textarea
                            id="personalMessage"
                            placeholder="Add a personal note about why you think they'd be a great fit for Miami Business Council..."
                        ></textarea>
                        <small>This will be included in the invitation email</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeInviteModal()">Cancel</button>
                <button class="btn-modal btn-modal-primary" id="sendInviteBtn" onclick="sendInvitation(event)">
                    Send Invitation
                </button>
            </div>
        </div>
    </div>

</body>
</html>