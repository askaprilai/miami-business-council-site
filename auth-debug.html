<!DOCTYPE html>
<html>
<head>
    <title>Auth Debug - Miami Business Council</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #fff;
            padding: 2rem;
        }
        .status { margin: 1rem 0; padding: 1rem; background: #2a2a2a; border-radius: 8px; }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        pre { background: #0a0a0a; padding: 1rem; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Authentication Debug</h1>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');

        function log(message, type = 'status') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            output.appendChild(div);
        }

        async function debug() {
            log('Starting authentication debug...', 'warning');

            // Initialize Supabase
            const SUPABASE_URL = 'https://vsnvtujkkkbjpuuwxvyd.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzbnZ0dWpra2tianB1dXd4dnlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MzUyNDYsImV4cCI6MjA3MTIxMTI0Nn0.GwWKrl_6zlIBvIaJs8NngoheF24nNzAfBO5_j_d1ogA';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            log('‚úÖ Supabase client initialized', 'success');

            // Check URL for auth token
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const searchParams = new URLSearchParams(window.location.search);

            log(`URL Hash: ${window.location.hash}`, 'status');
            log(`URL Search: ${window.location.search}`, 'status');

            const hasToken = hashParams.has('access_token') || searchParams.has('token');
            log(`Has auth token in URL: ${hasToken}`, hasToken ? 'success' : 'warning');

            // Wait for Supabase to process
            if (hasToken) {
                log('Waiting 2 seconds for Supabase to process auth token...', 'warning');
                await new Promise(resolve => setTimeout(resolve, 2000));
            }

            // Get session
            log('Checking for active session...', 'status');
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();

            if (sessionError) {
                log(`‚ùå Session error: ${sessionError.message}`, 'error');
                log(`<pre>${JSON.stringify(sessionError, null, 2)}</pre>`, 'error');
                return;
            }

            if (!session) {
                log('‚ùå No active session found', 'error');
                log('Try clicking the magic link again or request a new one', 'warning');
                return;
            }

            log('‚úÖ Active session found!', 'success');
            log(`<pre>${JSON.stringify(session.user, null, 2)}</pre>`, 'success');

            // Check member profile
            log(`Looking for member with auth_user_id = ${session.user.id}`, 'status');

            const { data: member, error: memberError } = await supabase
                .from('members')
                .select('*')
                .eq('auth_user_id', session.user.id)
                .single();

            if (memberError) {
                log(`‚ùå Member lookup error: ${memberError.message}`, 'error');
                log(`<pre>${JSON.stringify(memberError, null, 2)}</pre>`, 'error');

                // Try to find by email
                log(`Trying to find member by email: ${session.user.email}`, 'status');
                const { data: memberByEmail } = await supabase
                    .from('members')
                    .select('*')
                    .eq('email', session.user.email)
                    .single();

                if (memberByEmail) {
                    log('‚úÖ Found member by email!', 'success');
                    log(`<pre>${JSON.stringify(memberByEmail, null, 2)}</pre>`, 'success');

                    if (!memberByEmail.auth_user_id) {
                        log('‚ö†Ô∏è Member exists but auth_user_id is NULL - needs linking!', 'warning');
                        log('Run this SQL to fix:', 'warning');
                        log(`<pre>UPDATE members SET auth_user_id = '${session.user.id}' WHERE email = '${session.user.email}';</pre>`, 'warning');
                    }
                } else {
                    log('‚ùå No member found by email either', 'error');
                }
                return;
            }

            if (!member) {
                log('‚ùå No member profile found', 'error');
                return;
            }

            log('‚úÖ Member profile found!', 'success');
            log(`<pre>${JSON.stringify(member, null, 2)}</pre>`, 'success');

            log('üéâ AUTHENTICATION SUCCESSFUL!', 'success');
            log('<a href="/portal" style="color: #4caf50;">Click here to go to portal</a>', 'success');
        }

        debug();
    </script>
</body>
</html>
